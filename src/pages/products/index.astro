---
// src/pages/products/index.astro
import Base from "../../layouts/Base.astro";

/* ---------- Load & filter brand JSON ---------- */
const modules = import.meta.glob("/src/content/brands/*.json", {
  eager: true,
  import: "default",
}) as Record<string, any>;

const items = Object.values(modules)
  .map((m: any) => (m?.default ?? m))
  .filter(Boolean);

const isProductish = (b: any) =>
  Array.isArray(b?.topics) &&
  (b.topics.includes("vanished-product") || b.topics.includes("cult-favorite"));

const prods = items
  .filter(isProductish)
  .sort((a: any, b: any) => String(a.brand).localeCompare(String(b.brand)));

/* ---------- Helpers for A–Z grouping ---------- */
const firstLetter = (s: string = "") => {
  const ch = (s[0] || "").toUpperCase();
  return /[A-Z]/.test(ch) ? ch : "#";
};
const anchorIdFor = (L: string) => (L === "#" ? "0-9" : L).replace(/[^A-Za-z0-9_-]/g, "-");

/* Group by first letter */
const groups: Record<string, any[]> = {};
for (const b of prods) {
  const L = firstLetter(b.brand);
  (groups[L] ||= []).push(b);
}

/* Letters in order; put # (0–9) last */
const letters = Object.keys(groups)
  .filter((k) => groups[k]?.length)
  .sort((a, b) => (a === "#" ? 1 : b === "#" ? -1 : a.localeCompare(b)));

const total = prods.length;

/* ---------- SEO ---------- */
const PAGE_TITLE = "Vanished Products";
const PAGE_DESC = "Discontinued products and cult favorites people still miss.";
const CANONICAL = Astro.site ? new URL("/products/", Astro.site).href : "/products/";

/* Optional JSON-LD (ItemList of first 100 only to keep script small) */
const LD_MAX = Math.min(total, 100);
const itemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: PAGE_TITLE,
  numberOfItems: LD_MAX,
  itemListOrder: "http://schema.org/ItemListOrderAscending",
  itemListElement: prods.slice(0, LD_MAX).map((b: any, i: number) => ({
    "@type": "ListItem",
    position: i + 1,
    name: b.brand,
    url: Astro.site
      ? new URL(`/brand/${encodeURIComponent(b.slug)}/`, Astro.site).href
      : `/brand/${encodeURIComponent(b.slug)}/`,
  })),
};
---

<Base title={PAGE_TITLE} description={PAGE_DESC} canonical={CANONICAL} jsonLd={itemListLd}>
  <div class="max-w-6xl mx-auto px-4">
    <!-- Page-level UX styles -->
    <style is:inline>
      html { scroll-behavior: smooth; }
      /* Anchor targets land below sticky header */
      .anchor-target { scroll-margin-top: 84px; } /* adjust if your header height changes */

      /* Visually highlight the section you jumped to / currently viewing */
      section:target .section-title,
      .section-title.is-active {
        background: rgba(99, 102, 241, 0.10); /* indigo-500 @ 10% */
        outline: 2px solid rgba(99, 102, 241, 0.35);
        border-radius: .5rem;
      }

      /* Active chip in jump bar */
      .jump a.active {
        outline: 2px solid rgb(99, 102, 241);
        outline-offset: 2px;
      }
    </style>

    <nav class="mb-3 flex flex-wrap gap-2" aria-label="Breadcrumb">
      <a href="/" class="chip focus-ring">← Home</a>
      <span class="chip opacity-70 cursor-default" aria-current="page">Products</span>
    </nav>

    <h1 id="top" class="text-2xl md:text-3xl font-bold mb-1">{PAGE_TITLE}</h1>
    <p class="text-sm text-slate-600 dark:text-slate-300 mb-3">
      Discontinued products and cult favorites. <span id="countLine">Showing {total} of {total}</span>
    </p>

    <!-- Controls -->
    <div class="mb-4 flex flex-col sm:flex-row items-start sm:items-center gap-3">
      <label for="q" class="text-sm text-slate-600 dark:text-slate-300">Search</label>
      <input
        id="q"
        type="search"
        class="w-full sm:w-[320px] rounded-md border border-slate-300 bg-white text-slate-900 placeholder-slate-400 px-3 py-2 focus-ring dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
        placeholder="Search products…"
        inputmode="search"
        aria-describedby="countLine"
      />

      <!-- Jump bar -->
      <div class="jump mt-1 sm:mt-0 flex flex-wrap gap-2" role="navigation" aria-label="Jump to letter">
        {letters.map((L) => {
          const anchor = anchorIdFor(L);
          return <a href={`#${anchor}`} class="chip focus-ring" data-letter={anchor}>{L}</a>;
        })}
      </div>
    </div>

    {total === 0 ? (
      <p class="text-slate-600 dark:text-slate-400">No products yet.</p>
    ) : (
      <>
        {/* Letter groups */}
        <div id="groups" class="space-y-8">
          {letters.map((L) => {
            const anchor = anchorIdFor(L);
            const arr = groups[L];
            return (
              <section id={anchor} class="anchor-target" role="region" aria-labelledby={`h-${anchor}`} data-group={anchor}>
                <!-- Sticky letter header for context while scrolling the group -->
                <div class="sticky top-2 z-10">
                  <div class="flex items-baseline gap-2 mb-3 bg-white/80 dark:bg-slate-900/80 backdrop-blur rounded px-2 py-1">
                    <h2 id={`h-${anchor}`} class="section-title text-xl font-semibold">{L}</h2>
                    <span class="text-sm text-slate-500 dark:text-slate-400" data-group-count>
                      ({arr.length})
                    </span>
                  </div>
                </div>

                <ul class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                  {arr.map((b: any) => (
                    <li data-name={String(b.brand).toLowerCase()}>
                      <a
                        href={`/brand/${encodeURIComponent(b.slug)}/`}
                        class="chip focus-ring block"
                        aria-label={`${b.brand}${b.fate ? ` — ${b.fate}` : ""}`}
                      >
                        {b.brand}
                        {b.category && <span class="ml-1 text-gray-500">({b.category})</span>}
                      </a>
                    </li>
                  ))}
                </ul>
              </section>
            );
          })}
        </div>

        <div class="mt-8">
          <a href="#top" class="chip focus-ring">↑ Back to top</a>
        </div>
      </>
    )}
  </div>

  <!-- Client-side filtering, counts, and active-letter highlighting -->
  <script is:inline>
    (function () {
      const q = document.getElementById('q');
      const groups = Array.from(document.querySelectorAll('section[data-group]'));
      const countLine = document.getElementById('countLine');
      const jump = document.querySelector('.jump');
      const jumpLinks = jump ? Array.from(jump.querySelectorAll('a[data-letter]')) : [];
      const linkById = new Map(jumpLinks.map(a => [a.getAttribute('data-letter'), a]));
      const titleById = new Map(
        groups.map(sec => [sec.id, /** @type {HTMLElement|null} */ (sec.querySelector('.section-title'))])
      );

      function normalize(s){ return (s || '').toLowerCase().trim(); }

      function setActive(letterId) {
        jumpLinks.forEach(a => a.classList.toggle('active', a.getAttribute('data-letter') === letterId));
        // Title highlight (class-based, in addition to :target)
        titleById.forEach((h, id) => h && h.classList.toggle('is-active', id === letterId));
      }

      function applyFilter() {
        const term = normalize(q.value);
        let visibleTotal = 0;

        groups.forEach(sec => {
          const items = Array.from(sec.querySelectorAll('li'));
          let visibleInGroup = 0;

          items.forEach(li => {
            const name = li.getAttribute('data-name') || '';
            const ok = !term || name.includes(term);
            li.style.display = ok ? '' : 'none';
            if (ok) visibleInGroup++;
          });

          // Toggle section visibility + update count
          sec.style.display = visibleInGroup ? '' : 'none';
          const cnt = sec.querySelector('[data-group-count]');
          if (cnt) cnt.textContent = `(${visibleInGroup})`;

          // Dim the jump chip if group empty
          const link = linkById.get(sec.id);
          if (link) {
            link.style.opacity = visibleInGroup ? '1' : '0.4';
            link.tabIndex = visibleInGroup ? 0 : -1;
            link.setAttribute('aria-disabled', visibleInGroup ? 'false' : 'true');
          }

          visibleTotal += visibleInGroup;
        });

        if (countLine) {
          const all = Number(/** @type {any} */({}).total ?? 0) || {{total}};
          countLine.textContent = `Showing ${visibleTotal} of ${all}`;
        }
      }

      // Smooth active state on click (before hashchange settles)
      jumpLinks.forEach(a => {
        a.addEventListener('click', () => setActive(a.getAttribute('data-letter') || ''));
      });

      // Update active state on hash change
      window.addEventListener('hashchange', () => {
        setActive(location.hash.replace('#','') || '');
        focusTargetFromHash();
      });

      // IntersectionObserver to highlight jump chip while scrolling
      if ('IntersectionObserver' in window && groups.length) {
        const io = new IntersectionObserver(entries => {
          const visible = entries
            .filter(e => e.isIntersecting && e.target.style.display !== 'none')
            .sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];
          if (visible?.target?.id) setActive(visible.target.id);
        }, { rootMargin: '-30% 0px -60% 0px', threshold: [0.1, 0.25, 0.5, 0.75] });
        groups.forEach(s => io.observe(s));
      }

      // Move focus to the section header for accessibility on deep-links
      function focusTargetFromHash() {
        const id = location.hash.slice(1);
        if (!id) return;
        const h = document.getElementById('h-' + id);
        if (h) {
          h.setAttribute('tabindex', '-1');
          h.focus({ preventScroll: true });
          setTimeout(() => h.removeAttribute('tabindex'), 300);
        }
      }

      // Init
      applyFilter();
      setActive(location.hash.replace('#','') || '');
      focusTargetFromHash();

      // Filter binding
      q.addEventListener('input', applyFilter);
    })();
  </script>
</Base>
