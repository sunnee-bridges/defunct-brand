---
// src/pages/products/index.astro
import Base from "../../layouts/Base.astro";
import {
  normalizeBrands,
  yearsOf,
  fateIconOf,
  fateTypeOf,
  primaryTextOf,
  truncateInline,
} from "../../lib/brandUtils";

/* ---------- Load & normalize brand JSON ---------- */
const modules = import.meta.glob("/src/content/brands/*.json", {
  eager: true,
  import: "default",
}) as Record<string, any>;
const brands: any[] = normalizeBrands(modules);

/* ---------- Filter to "productish" entries ---------- */
const isProductish = (b: any) => {
  const t: string[] = Array.isArray(b?.topics) ? b.topics : [];
  return t.some((x) => /^(vanished[-_ ]?product|cult[-_ ]?favorite)$/i.test(String(x)));
};

const prods = brands
  .filter(isProductish)
  .sort((a, b) => String(a.brand || "").localeCompare(String(b.brand || "")));

/* ---------- Helpers for A‚ÄìZ grouping ---------- */
const firstLetter = (s = "") => {
  const ch = (s[0] || "").toUpperCase();
  return /[A-Z]/.test(ch) ? ch : "#";
};
const anchorIdFor = (L: string) => (L === "#" ? "0-9" : L).replace(/[^A-Za-z0-9_-]/g, "-");

/* Group by first letter */
const groups: Record<string, any[]> = {};
for (const b of prods) {
  const L = firstLetter(String(b.brand));
  (groups[L] ||= []).push(b);
}

/* Letters in order; put # (0‚Äì9) last */
const letters = Object.keys(groups)
  .filter((k) => groups[k]?.length)
  .sort((a, b) => (a === "#" ? 1 : b === "#" ? -1 : a.localeCompare(b)));

const total = prods.length;

/* ---------- SEO ---------- */
const PAGE_TITLE = "Vanished Products";
const PAGE_DESC = "Discontinued products and cult favorites people still miss.";
const CANONICAL = Astro.site ? new URL("/products/", Astro.site).href : "/products/";

/* Optional JSON-LD (ItemList of first 100 only to keep script small) */
const LD_MAX = Math.min(total, 100);
const itemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: PAGE_TITLE,
  numberOfItems: LD_MAX,
  itemListOrder: "http://schema.org/ItemListOrderAscending",
  itemListElement: prods.slice(0, LD_MAX).map((b: any, i: number) => ({
    "@type": "ListItem",
    position: i + 1,
    name: b.brand,
    url: Astro.site
      ? new URL(`/brand/${encodeURIComponent(b.slug)}/`, Astro.site).href
      : `/brand/${encodeURIComponent(b.slug)}/`,
  })),
};
---

<Base title={PAGE_TITLE} description={PAGE_DESC} canonical={CANONICAL} jsonLd={itemListLd}>
  <style is:inline>
    html { scroll-behavior: smooth; }
    .anchor-target { scroll-margin-top: 84px; }

    .jump a { transition: background-color .15s ease, outline-color .15s ease, color .15s ease; }
    .jump a.active {
      outline: 2px solid rgb(99 102 241);
      outline-offset: 2px;
      background: rgba(99 102 241 / 0.10);
      color: rgb(55 48 163);
    }
    .dark .jump a.active { outline-color: rgb(165 180 252); background: rgba(99 102 241 / 0.25); color: rgb(224 231 255); }
    .dark .jump a { color: rgb(203 213 225); }

    /* Card polish (match A‚ÄìZ/home style) */
    .fcard-sm { position: relative; border-radius: .875rem; border: 1px solid var(--card-border, rgb(226 232 240)); background: var(--card-bg, #fff); padding:.75rem .85rem; overflow:hidden; transition: transform .16s ease, box-shadow .16s ease; }
    .fcard-sm:hover { transform: translateY(-1px); box-shadow: 0 6px 12px -8px rgb(0 0 0 / .18); }
    .dark .fcard-sm { --card-bg: rgb(2 6 23); --card-border: rgb(51 65 85); }
    .meta-row { display:flex; flex-wrap:wrap; gap:.4rem; margin-top:.35rem }
    .chip-lite { display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .5rem; border-radius:9999px; font-size:.7rem; font-weight:600; background: color-mix(in oklab, var(--tint, oklch(0.7 0 0)) 14%, white); border: 1px solid color-mix(in oklab, var(--tint, oklch(0.7 0 0)) 28%, white); color: oklch(0.28 0 0); }
    .dark .chip-lite { background: color-mix(in oklab, var(--tint, oklch(0.7 0 0)) 22%, rgb(2 6 23)); border-color: color-mix(in oklab, var(--tint, oklch(0.7 0 0)) 45%, rgb(2 6 23)); color: white; }
    .hook { margin-top:.25rem; font-size:.85rem; line-height:1.2rem; color: rgb(71 85 105); display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .dark .hook { color: rgb(203 213 225); }
  </style>

  <div class="max-w-6xl mx-auto px-4">
    <nav class="mb-3 flex flex-wrap gap-2" aria-label="Breadcrumb">
      <a href="/" class="chip focus-ring">‚Üê Home</a>
      <span class="chip opacity-70 cursor-default" aria-current="page">Products</span>
    </nav>

    <h1 id="top" class="text-2xl md:text-3xl font-bold mb-1">{PAGE_TITLE}</h1>
    <p class="text-sm text-slate-600 dark:text-slate-300 mb-3">
      Discontinued products and cult favorites. <span id="countLine">Showing {total} of {total}</span>
    </p>

    <!-- Controls -->
    <div class="mb-4 flex flex-col sm:flex-row items-start sm:items-center gap-3">
      <label for="q" class="text-sm text-slate-600 dark:text-slate-300">Search</label>
      <input
        id="q"
        type="search"
        class="w-full sm:w-[320px] rounded-md border border-slate-300 bg-white text-slate-900 placeholder-slate-400 px-3 py-2 focus-ring dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
        placeholder="Search products‚Ä¶"
        inputmode="search"
        aria-describedby="countLine"
      />

      <!-- Jump bar -->
      <div class="jump mt-1 sm:mt-0 flex flex-wrap gap-2" role="navigation" aria-label="Jump to letter">
        {letters.map((L) => {
          const anchor = anchorIdFor(L);
          return <a href={`#${anchor}`} class="chip focus-ring" data-letter-link={anchor}>{L}</a>;
        })}
      </div>
    </div>

    {total === 0 ? (
      <p class="text-slate-600 dark:text-slate-400">No products yet.</p>
    ) : (
      <>
        {/* Letter groups */}
        <div id="groups" class="space-y-8">
          {letters.map((L) => {
            const anchor = anchorIdFor(L);
            const arr = groups[L];
            return (
              <section id={anchor} role="region" aria-labelledby={`h-${anchor}`} data-group={anchor} class="anchor-target">
                <div class="flex items-baseline gap-2 mb-3">
                  <h2 id={`h-${anchor}`} class="text-xl font-semibold">{L}</h2>
                  <span class="text-sm text-slate-500 dark:text-slate-400" data-group-count>
                    ({arr.length})
                  </span>
                </div>

                <ul class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                  {arr.map((b: any) => {
                    const yrs = yearsOf(b);
                    const cat = b.__seo_category_label || b.category || "Brand";
                    // stable tint from category
                    let h = 0; const s = (cat || "brand") + "-vb"; for (let i = 0; i < s.length; i++) h = (h * 31 + s.charCodeAt(i)) >>> 0;
                    const tint = `oklch(0.7 0.12 ${h % 360})`;
                    const icon = fateIconOf(b);
                    const fateType = fateTypeOf(b) || "other";
                    const text = truncateInline(primaryTextOf(b), 120);

                    return (
                      <li data-name={String(b.brand).toLowerCase()}>
                        <article class="fcard-sm group h-full" style={{ "--tint": tint }}>
                          <a
                            href={`/brand/${encodeURIComponent(b.slug)}/`}
                            class="stretched-link focus-ring rounded"
                            aria-label={`${b.brand}${yrs ? ` (${yrs})` : ""}${cat ? ` ‚Äî ${cat}` : ""}`}
                          ></a>

                          <h3 class="text-base font-semibold leading-snug line-clamp-2 mb-1.5 text-slate-900 dark:text-slate-100 group-hover:underline underline-offset-2">
                            {b.brand}
                          </h3>

                          {text && (
                            <p class="hook">
                              <span aria-hidden="true">{icon}</span>
                              <span class="sr-only">Fate: {fateType}</span>
                              {" "}{text}
                            </p>
                          )}

                          <div class="meta-row">
                            {yrs && <span class="chip-lite" aria-label={`Years active ${yrs}`}>{yrs}</span>}
                            {cat && <span class="chip-lite" title={`Category: ${cat}`}>üè∑Ô∏è {cat}</span>}
                          </div>
                        </article>
                      </li>
                    );
                  })}
                </ul>
              </section>
            );
          })}
        </div>

        <div class="mt-8">
          <a href="#top" class="chip focus-ring">‚Üë Back to top</a>
        </div>
      </>
    )}
  </div>

  <!-- Client-side filtering, counts & stable active-letter highlight (scroll-based) -->
  <script is:inline>
    (function () {
      const q = document.getElementById('q');
      const sections = Array.from(document.querySelectorAll('section[data-group]'));
      const countLine = document.getElementById('countLine');
      const letterLinks = new Map(
        Array.from(document.querySelectorAll('[data-letter-link]')).map(a => [a.getAttribute('data-letter-link'), a])
      );

      function normalize(s){ return (s || '').toLowerCase().trim(); }

      function setActiveLetter(id) {
        letterLinks.forEach((a, key) => {
          const isActive = key === id;
          a.classList.toggle('active', isActive);
          if (isActive) a.setAttribute('aria-current', 'true');
          else a.removeAttribute('aria-current');
        });
      }

      // Letter click behavior
      letterLinks.forEach((a, key) => {
        a.addEventListener('click', (e) => {
          const targetId = key;
          const sec = document.getElementById(targetId);
          if (!sec) return;
          e.preventDefault();
          setActiveLetter(targetId);
          sec.scrollIntoView({ behavior: 'smooth', block: 'start' });
          history.pushState(null, '', '#' + targetId);
        });
      });

      // Filtering
      function applyFilter() {
        const term = normalize(q.value);
        let visibleTotal = 0;

        sections.forEach(sec => {
          const items = Array.from(sec.querySelectorAll('li'));
          let visibleInGroup = 0;

          items.forEach(li => {
            const name = li.getAttribute('data-name') || '';
            const ok = !term || name.includes(term);
            li.style.display = ok ? '' : 'none';
            if (ok) visibleInGroup++;
          });

          sec.style.display = visibleInGroup ? '' : 'none';
          const cnt = sec.querySelector('[data-group-count]');
          if (cnt) cnt.textContent = `(${visibleInGroup})`;

          const id = sec.id;
          const link = letterLinks.get(id);
          if (link) {
            link.style.opacity = visibleInGroup ? '1' : '0.4';
            link.tabIndex = visibleInGroup ? 0 : -1;
            link.setAttribute('aria-disabled', visibleInGroup ? 'false' : 'true');
          }

          visibleTotal += visibleInGroup;
        });

        if (countLine) {
          const all = Number({total});
          countLine.textContent = `Showing ${visibleTotal} of ${all}`;
        }
      }

      q.addEventListener('input', applyFilter);
      applyFilter();

      // Highlight from hash on load (if present)
      const hash = window.location.hash.slice(1);
      if (hash && letterLinks.has(hash)) setActiveLetter(hash);
    })();
  </script>
</Base>
