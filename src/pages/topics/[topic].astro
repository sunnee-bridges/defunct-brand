---
// src/pages/topics/[topic].astro

import Base from "../../layouts/Base.astro";

/** 1) Gather all brands (eager for static build) */
const brandModules = import.meta.glob("/src/content/brands/*.json", {
  eager: true,
  import: "default",
}) as Record<string, any>;

/** 2) Topic meta (richer intros). Extend any time. */
type TopicMeta = {
  label: string;
  desc: string;              // short intro + meta description
  descLong?: string;         // richer intro paragraph(s)
  heroImage?: string;        // optional hero image path/URL
  faq?: Array<{ q: string; a: string }>;
  keywords?: string[];       // optional: light topical hints for SEO
};

const TOPIC_META: Record<string, TopicMeta> = {
  "music-players": {
    label: "Music Players",
    desc: "Explore discontinued music players and services: timelines, outcomes, and related brands.",
    descLong:
      "From early MP3 devices to full ecosystem plays, this hub covers portable media hardware and the services behind them. Expect quick timelines, notable models, and links to reliable sources and archives.",
    heroImage: "/og/hubs/music-players.png",
    keywords: ["mp3 players", "portable music", "iPod", "Zune", "Walkman"],
    faq: [
      {
        q: "What counts as a music player here?",
        a: "Dedicated portable audio devices and closely related music services that were discontinued or sunset.",
      },
      {
        q: "Why did so many disappear?",
        a: "Smartphones subsumed most use-cases, margins shrank, and ecosystems consolidated around a few dominant platforms.",
      },
    ],
  },
  "portable-audio": {
    label: "Portable Audio",
    desc: "Portable audio devices that came and went: categories, timelines, and notable products.",
    descLong:
      "Spanning cassette, CD, MiniDisc, and digital eras, this hub highlights devices and brands that defined on-the-go listening—and how they were eventually replaced.",
    heroImage: "/og/hubs/portable-audio.png",
    keywords: ["headphones", "minidisc", "cassette", "bluetooth audio"],
  },
  // Add more topics as needed...
};

/** 3) Fallback label from slug */
function prettyLabel(slug: string) {
  return slug
    .split("-")
    .map((s) => (s ? s[0].toUpperCase() + s.slice(1) : s))
    .join(" ");
}

/** 4) Static paths from topics found in brand JSON */
export function getStaticPaths() {
  const topics = new Set<string>();
  for (const mod of Object.values(brandModules)) {
    const t = Array.isArray(mod?.topics) ? mod.topics : [];
    for (const sl of t) topics.add(String(sl).toLowerCase());
  }
  return [...topics].map((topic) => ({ params: { topic } }));
}

/** 5) Runtime data for this page */
const { topic } = Astro.params;
const slug = String(topic).toLowerCase();
const meta: TopicMeta =
  TOPIC_META[slug] ?? {
    label: prettyLabel(slug),
    desc: "Browse related discontinued brands collected under this topic.",
  };

/** Collect brands tagged with this topic */
const items = Object.values(brandModules)
  .filter(
    (b: any) =>
      Array.isArray(b?.topics) &&
      b.topics.map((x: any) => String(x).toLowerCase()).includes(slug)
  )
  .map((b: any) => ({
    name: b.brand,
    slug: b.slug,
    category: b.category ?? null,
  }))
  .sort((a, b) => a.name.localeCompare(b.name));

/** SEO / Canonical */
const hubPath = `/topics/${encodeURIComponent(slug)}/`;
const title = `${meta.label} • Topic Hub`;
const desc = meta.desc;
const canonical = Astro.site ? new URL(hubPath, Astro.site).href : hubPath;

/** JSON-LD ItemList */
const ldItems = items.map((b, i) => ({
  "@type": "ListItem",
  position: i + 1,
  name: b.name,
  url: Astro.site
    ? new URL(`/brand/${encodeURIComponent(b.slug)}/`, Astro.site).href
    : `/brand/${encodeURIComponent(b.slug)}/`,
}));

/** NEW: Breadcrumb + CollectionPage JSON-LD (mirrors UI) */
const breadcrumbLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home",   item: Astro.site ? new URL("/", Astro.site).href : "/" },
    { "@type": "ListItem", position: 2, name: "Topics", item: Astro.site ? new URL("/topics/", Astro.site).href : "/topics/" },
    { "@type": "ListItem", position: 3, name: meta.label, item: canonical },
  ],
};

const itemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: title,
  numberOfItems: items.length,
  itemListElement: ldItems,
};

const collectionPageLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  url: canonical,
  name: title,
  description: desc,
  mainEntity: itemListLd,
};
---

<Base title={title} description={desc} canonical={canonical} jsonLd={[collectionPageLd, breadcrumbLd]}>
  <Fragment slot="head">
    <meta name="robots" content={items.length ? "index,follow" : "noindex,follow"} />
    {meta.keywords?.length && <meta name="keywords" content={meta.keywords.join(", ")} />}
    <link rel="canonical" href={canonical} />
  </Fragment>

  {/* Breadcrumbs */}
  <nav class="flex flex-wrap items-center gap-2 my-3">
    <a href="/" class="chip focus-ring">← Home</a>
    <a href="/topics/" class="chip focus-ring">All Topics</a>
    <a href="/az/" class="chip focus-ring">Browse A–Z</a>
  </nav>

  {/* Header */}
  <h1 class="text-2xl md:text-3xl font-bold mb-1">{meta.label} • Topic Hub</h1>
  <p class="text-slate-600 dark:text-slate-300 mb-4">{desc}</p>

  {/* Optional hero */}
  {meta.heroImage && (
    <div class="mb-5 overflow-hidden rounded-2xl border border-slate-200 dark:border-slate-800">
      <img src={meta.heroImage} alt={`${meta.label} hero`} class="w-full h-auto block" loading="lazy" />
    </div>
  )}

  {/* Optional richer intro */}
  {meta.descLong && (
    <div class="prose dark:prose-invert max-w-none mb-6">
      <p>{meta.descLong}</p>
    </div>
  )}

  {/* Results summary */}
  <p class="text-sm text-slate-500 dark:text-slate-400 mb-3">
    {items.length} brand{items.length === 1 ? "" : "s"} in this topic
  </p>

  {/* Brand list */}
  {items.length ? (
    <ul class="grid gap-2 sm:grid-cols-2 md:grid-cols-3">
      {items.map((i) => (
        <li class="rounded-xl border border-slate-200 dark:border-slate-800 p-3">
          <a class="focus-ring hover:underline font-medium" href={`/brand/${encodeURIComponent(i.slug)}/`}>
            {i.name}
          </a>
          {i.category && (
            <span
              class="ml-2 text-xs px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 align-middle"
              aria-label={`Category: ${i.category}`}
              title={`Category: ${i.category}`}
            >
              {i.category}
            </span>
          )}
        </li>
      ))}
    </ul>
  ) : (
    <p class="text-slate-600 dark:text-slate-300">No brands are tagged with this topic yet.</p>
  )}

  {/* Optional FAQ */}
  {Array.isArray(meta.faq) && meta.faq.length > 0 && (
    <section class="mt-8">
      <h2 class="text-lg font-semibold mb-3">FAQ</h2>
      <div class="space-y-2">
        {meta.faq.map((f) => (
          <details class="rounded-xl border border-slate-200 dark:border-slate-800 p-3">
            <summary class="cursor-pointer font-medium">{f.q}</summary>
            <p class="mt-2 text-slate-700 dark:text-slate-300">{f.a}</p>
          </details>
        ))}
      </div>
    </section>
  )}

  {/* Gentle internal links */}
  <div class="mt-6 flex flex-wrap gap-2">
    <a href="/az/" class="chip focus-ring">Browse A–Z</a>
    <a href="/category/" class="chip focus-ring">Categories</a>
    <a href="/decade/" class="chip focus-ring">Decades</a>
  </div>
</Base>
