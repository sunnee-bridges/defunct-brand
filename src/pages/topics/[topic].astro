---
// src/pages/topics/[topic].astro
import Base from "../../layouts/Base.astro";
import { getCollection } from "astro:content";

/* ---------- Build static paths from topics in brands + taxonomy ---------- */
export async function getStaticPaths() {
  // Topics discovered from brand JSON
  const brandModules = import.meta.glob("/src/content/brands/*.json", {
    eager: true,
    import: "default",
  }) as Record<string, any>;

  const fromBrands = new Set<string>();
  for (const mod of Object.values(brandModules)) {
    const list = Array.isArray(mod?.topics) ? mod.topics : [];
    for (const t of list) fromBrands.add(String(t).toLowerCase());
  }

  // Topics declared in taxonomy (kind: "topic")
  const taxonomy = (await getCollection("taxonomy").catch(() => [])) as any[];
  const fromTaxonomy = new Set<string>();
  for (const t of taxonomy || []) {
    const d = t?.data;
    if (d?.kind === "topic" && d?.slug) {
      fromTaxonomy.add(String(d.slug).trim().toLowerCase());
    }
  }

  // Union → ensure we build pages for taxonomy-only topics too
  const all = Array.from(new Set([...fromBrands, ...fromTaxonomy])).sort();

  return all.map((topic) => ({ params: { topic } }));
}

/* ---------- Runtime brand load ---------- */
const brandModulesRuntime = import.meta.glob("/src/content/brands/*.json", {
  eager: true,
  import: "default",
}) as Record<string, any>;

/* ---------- Helpers ---------- */
const prettyLabel = (slug: string) =>
  String(slug)
    .split("-")
    .map((s) => (s ? s[0].toUpperCase() + s.slice(1) : s))
    .join(" ");

/* ---------- Params & taxonomy meta ---------- */
const { topic } = Astro.params;
const slug = String(topic || "").toLowerCase();

// Load taxonomy (optional)
const taxonomy = (await getCollection("taxonomy").catch(() => [])) as any[];
const byTopicMeta = new Map<string, any>();
for (const t of taxonomy || []) {
  const d = t?.data;
  if (d?.kind === "topic" && d?.slug) {
    byTopicMeta.set(String(d.slug).trim().toLowerCase(), d);
  }
}
const metaRaw = byTopicMeta.get(slug) || {};
const label = metaRaw.title ?? prettyLabel(slug);
const intro_md: string = metaRaw.intro_md || "";
const hero = metaRaw.hero || null;
const faq: Array<{ q: string; a: string }> = Array.isArray(metaRaw.faq) ? metaRaw.faq : [];

// Safe markdown intro render
const renderedIntro = intro_md ? (await Astro.renderMarkdown(intro_md)).html : "";

/* ---------- Collect brands tagged with this topic ---------- */
const seen = new Set<string>();
const items = Object.values(brandModulesRuntime)
  .filter(
    (b: any) =>
      Array.isArray(b?.topics) &&
      b.topics.map((x: any) => String(x).toLowerCase()).includes(slug)
  )
  .map((b: any) => ({
    name: b.brand,
    slug: b.slug,
    category: b.category ?? null,
  }))
  .filter((b) => {
    const k = String(b.slug || "").toLowerCase();
    if (!k || seen.has(k)) return false;
    seen.add(k);
    return true;
  })
  .sort((a, b) => a.name.localeCompare(b.name));

/* ---------- SEO / Canonical & JSON-LD ---------- */
const hubPath = `/topics/${encodeURIComponent(slug)}/`;
const canonical = Astro.site ? new URL(hubPath, Astro.site).href : hubPath;

// Description: prefer taxonomy intro (plain-texted) → fallback default
const introPlain = intro_md ? intro_md.replace(/[*_`>#-]/g, "").slice(0, 220) : "";
const desc =
  introPlain ||
  "Browse related discontinued brands collected under this topic.";

const title = `${label} • Topic Hub`;

const ldItems = items.map((b, i) => ({
  "@type": "ListItem",
  position: i + 1,
  name: b.name,
  url: Astro.site
    ? new URL(`/brand/${encodeURIComponent(b.slug)}/`, Astro.site).href
    : `/brand/${encodeURIComponent(b.slug)}/`,
}));

const itemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: title,
  numberOfItems: items.length,
  itemListElement: ldItems,
};

const collectionPageLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  url: canonical,
  name: title,
  description: desc,
  mainEntity: itemListLd,
};

const breadcrumbsLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: Astro.site ? new URL("/", Astro.site).href : "/" },
    { "@type": "ListItem", position: 2, name: "Topics", item: Astro.site ? new URL("/topics/", Astro.site).href : "/topics/" },
    { "@type": "ListItem", position: 3, name: label, item: canonical },
  ],
};

// Optional FAQPage LD if taxonomy provides FAQ
const faqLd = faq.length
  ? {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      mainEntity: faq.map((f: any) => ({
        "@type": "Question",
        name: f.q,
        acceptedAnswer: { "@type": "Answer", text: f.a },
      })),
    }
  : null;

// If empty topic, gently noindex (avoid thin-content indexation)
const shouldNoIndex = items.length === 0;
---

<Base
  title={title}
  description={desc}
  canonical={canonical}
  jsonLd={[collectionPageLd, breadcrumbsLd, itemListLd, ...(faqLd ? [faqLd] : [])]}
>
  <Fragment slot="head">
    <link rel="canonical" href={canonical} />
    <meta
      name="robots"
      content={shouldNoIndex ? "noindex,follow" : "max-snippet:-1, max-image-preview:large, max-video-preview:-1"}
    />
  </Fragment>

  {/* Breadcrumbs */}
  <nav class="flex flex-wrap items-center gap-2 my-3">
    <a href="/" class="chip focus-ring">← Home</a>
    <a href="/topics/" class="chip focus-ring">All Topics</a>
    <a href="/az/" class="chip focus-ring">Browse A–Z</a>
  </nav>

  {/* Header */}
  <h1 class="text-2xl md:text-3xl font-bold mb-1">{label} • Topic Hub</h1>
  <p class="text-slate-600 dark:text-slate-300 mb-4">{desc}</p>

  {/* Optional hero from taxonomy */}
  {hero?.src && (
    <div class="mb-5 overflow-hidden rounded-2xl border border-slate-200 dark:border-slate-800">
      <img src={hero.src} alt={hero.alt || `${label} hero`} class="w-full h-auto block" loading="lazy" decoding="async" />
    </div>
  )}

  {/* Optional intro markdown from taxonomy */}
  {renderedIntro && (
    <div class="prose dark:prose-invert max-w-none mb-6" set:html={renderedIntro} />
  )}

  {/* Results summary */}
  <p class="text-sm text-slate-500 dark:text-slate-400 mb-3">
    {items.length} brand{items.length === 1 ? "" : "s"} in this topic
  </p>

  {/* Brand list */}
  {items.length ? (
    <ul class="grid gap-2 sm:grid-cols-2 md:grid-cols-3">
      {items.map((i) => (
        <li class="rounded-xl border border-slate-200 dark:border-slate-800 p-3">
          <a class="focus-ring hover:underline font-medium" href={`/brand/${encodeURIComponent(i.slug)}/`}>
            {i.name}
          </a>
          {i.category && (
            <span
              class="ml-2 text-xs px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 align-middle"
              aria-label={`Category: ${i.category}`}
              title={`Category: ${i.category}`}
            >
              {i.category}
            </span>
          )}
        </li>
      ))}
    </ul>
  ) : (
    <p class="text-slate-600 dark:text-slate-300">No brands are tagged with this topic yet.</p>
  )}

  {/* Gentle internal links */}
  <div class="mt-6 flex flex-wrap gap-2">
    <a href="/category/" class="chip focus-ring">Categories</a>
    <a href="/decade/" class="chip focus-ring">Decades</a>
  </div>

  {/* Optional on-page FAQ render */}
  {faq.length > 0 && (
    <section class="mt-8">
      <h2 class="text-xl font-semibold mb-2">FAQ</h2>
      <div class="space-y-3">
        {faq.map((f) => (
          <details class="rounded-lg border border-slate-200 dark:border-slate-800 p-3">
            <summary class="font-medium cursor-pointer">{f.q}</summary>
            <div class="mt-2 text-slate-700 dark:text-slate-300">{f.a}</div>
          </details>
        ))}
      </div>
    </section>
  )}
</Base>
