---
// src/pages/index.astro
import Base from "../layouts/Base.astro";
import {
  normalizeBrands,
  toYear,
  decadeStart,
  catHue,
  yearsOf,
  fateIconOf,
  fateTypeOf,
  primaryTextOf,
  truncateInline,
} from "../lib/brandUtils";

/* ---------- Load curated brand JSON ---------- */
const modules = import.meta.glob("/src/content/brands/*.json", {
  eager: true,
  import: "default",
}) as Record<string, any>;

/* ---------- Normalize brands (dedupe + taxonomy merge) ---------- */
const brands: any[] = normalizeBrands(modules);

/* ---------- Categories (unique, alpha) ---------- */
const categories = Array.from(
  new Map(
    brands.map((b) => [String(b.__seo_category), String(b.__seo_category_label || b.category || "Brand")])
  ).entries()
)
  .map(([slug, label]) => ({ slug, label }))
  .sort((a, b) => a.label.localeCompare(b.label));

/* ---------- AVAILABLE decades only (prefer end year, fallback to start) ---------- */
const decadeSet = new Set<number>();
for (const b of brands) {
  const y = toYear(b?.active?.end) ?? toYear(b?.active?.start);
  if (y !== undefined) decadeSet.add(decadeStart(y));
}
const availableDecadeLabels: string[] = [...decadeSet]
  .sort((a, b) => a - b)
  .map((d) => `${d}s`);
const totalDecades = availableDecadeLabels.length;

/* ---------- Featured: most recently ended first (fallback to start) ---------- */
const featured = brands
  .slice()
  .sort((a, b) => {
    const ay = toYear(a?.active?.end) ?? toYear(a?.active?.start) ?? 0;
    const by = toYear(b?.active?.end) ?? toYear(b?.active?.start) ?? 0;
    return by - ay;
  })
  .slice(0, 9);

/* ---------- SEO ---------- */
const pageTitle = "Vanished Brands ‚Äî Defunct & Discontinued Brands Archive";
const pageDesc =
  "Explore discontinued and vanished brands with quick timelines, categories, decades, and a downloadable CSV dataset for research and journalism.";
const canonical = (Astro.site ? new URL("/", Astro.site).href : "/");

/* Organization (E-E-A-T: identity) */
const orgLd = {
  "@context": "https://schema.org",
  "@type": "Organization",
  name: "Vanished Brands",
  url: "https://vanishedbrands.com/",
  logo: "https://vanishedbrands.com/apple-touch-icon.png",
};

/* WebSite + SearchAction (helps site-wide discovery) */
const siteLd = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: "Vanished Brands",
  url: "https://vanishedbrands.com/",
  potentialAction: {
    "@type": "SearchAction",
    target: "https://vanishedbrands.com/az/?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
};

/* ItemLists for category/decade previews */
const categoriesItemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: "Browse by Category",
  itemListOrder: "http://schema.org/ItemListOrderAscending",
  numberOfItems: categories.length,
  itemListElement: categories.map((c, i: number) => ({
    "@type": "ListItem",
    position: i + 1,
    name: c.label,
    url: Astro.site
      ? new URL(`/category/${c.slug}/`, Astro.site).href
      : `/category/${c.slug}/`,
  })),
};

const decadesItemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: "Browse by Decade",
  itemListOrder: "http://schema.org/ItemListOrderAscending",
  numberOfItems: availableDecadeLabels.length,
  itemListElement: availableDecadeLabels.map((label: string, i: number) => ({
    "@type": "ListItem",
    position: i + 1,
    name: label,
    url: Astro.site
      ? new URL(`/decade/${label}/`, Astro.site).href
      : `/decade/${label}/`,
  })),
};

const faqLd = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  mainEntity: [
    {
      "@type": "Question",
      name: "What is Vanished Brands?",
      acceptedAnswer: {
        "@type": "Answer",
        text:
          "An archive of discontinued and defunct brands with timelines, categories, and a purchasable CSV dataset for research.",
      },
    },
    {
      "@type": "Question",
      name: "Can I download the dataset?",
      acceptedAnswer: {
        "@type": "Answer",
        text:
          "Yes. A free sample CSV is available, and the full dataset can be purchased securely via PayPal.",
      },
    },
  ],
};

const currentPath = Astro.url.pathname;
---

<Base
  title={pageTitle}
  description={pageDesc}
  canonical={canonical}
  jsonLd={[orgLd, siteLd, categoriesItemListLd, decadesItemListLd, faqLd]}
>
  <!-- Featured card styles -->
  <style is:inline>
    .fcard {
      position: relative;
      border-radius: 1rem;
      border: 1px solid var(--card-border, rgb(226 232 240));
      background:
        linear-gradient(180deg, color-mix(in oklab, var(--tint) 12%, transparent) 0%, transparent 28%),
        var(--card-bg, #fff);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
      overflow: hidden;
    }
    .dark .fcard { --card-bg: rgb(2 6 23); --card-border: rgb(51 65 85); }
    .fcard:hover {
      transform: translateY(-2px);
      box-shadow:
        0 8px 16px -8px color-mix(in oklab, var(--tint) 35%, transparent),
        0 2px 10px -6px rgb(0 0 0 / .12);
    }
    .meta-row { display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.35rem }
    .chip-lite {
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.25rem .5rem; border-radius:9999px; font-size:.72rem; font-weight:600;
      background: color-mix(in oklab, var(--tint) 14%, white);
      border: 1px solid color-mix(in oklab, var(--tint) 28%, white);
      color: oklch(0.28 0 0);
    }
    .dark .chip-lite {
      background: color-mix(in oklab, var(--tint) 22%, rgb(2 6 23));
      border-color: color-mix(in oklab, var(--tint) 45%, rgb(2 6 23));
      color: white;
    }
    .hook {
      margin-top:.45rem;
      font-size:.9rem;
      line-height:1.25rem;
      color: rgb(71 85 105);
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    .dark .hook { color: rgb(203 213 225); }
    .card-title a:hover { text-decoration: underline; text-underline-offset: 3px; }
  </style>

  <!-- ‚úÖ Collapsible ‚ÄúWhy this matters‚Äù -->
  <section class="mt-4 mb-6" aria-label="Why this matters">
    <h1 class="text-2xl md:text-3xl font-bold mb-3">Why Brands Disappear (and Why It Matters)</h1>

    <p class="text-slate-800 dark:text-slate-200">
      Every year, familiar names vanish. Vanished Brands tracks those stories with quick timelines,
      clear categories, and reliable sources so you can see what ended‚Äîand why.
    </p>

    <details class="mt-2">
      <summary class="cursor-pointer text-sm text-indigo-600 hover:underline">Read more</summary>
      <div class="prose dark:prose-invert max-w-none mt-2">
        <p>
          Why catalog defunct brands? Because they‚Äôre a fast, human way to understand bigger shifts in
          technology, retail, and culture. When smartphones absorbed MP3 players, when e-commerce reshaped
          malls, when streaming remade media‚Äîbrands were the first visible signals of change.
        </p>
        <p>
          Each brand page summarizes basics (founded, defunct, fate), links to sources, and points to related reading.
          Browse by <a class="underline" href="/az/">A‚ÄìZ</a>, explore <a class="underline" href="/category/">categories</a>,
          or jump through time with <a class="underline" href="/decade/">decades</a>.
          For trend work, grab the <a class="underline" href="/data/">CSV</a>.
        </p>
      </div>
    </details>

    <div class="mt-4 flex flex-wrap gap-2">
      <a href="/az/" class="chip focus-ring">Browse A‚ÄìZ</a>
      <a href="/category/" class="chip focus-ring">Categories</a>
      <a href="/decade/" class="chip focus-ring">Decades</a>
      <a href="/topics/" class="chip focus-ring">Topics</a>
      <a href="/data/" class="chip focus-ring">Download data (CSV)</a>
      <a href="/random/" class="chip focus-ring">Random brand</a>
    </div>
  </section>

  <p class="sr-only">
    Explore defunct and discontinued brands by category, decade, and A‚ÄìZ index.
    Each brand page summarizes the timeline, fate, and key facts. A downloadable CSV dataset
    is available for analysts, researchers, and journalists.
  </p>

  <!-- Categories (uses normalized seo_category labels) -->
  <section class="mt-6" role="region" aria-label="Browse by category">
    <h2 class="text-lg font-semibold mb-2">Browse by Category</h2>
    <nav class="flex flex-wrap gap-2" role="navigation" aria-label="Categories">
      {categories.map((c) => {
        const href = `/category/${c.slug}/`;
        const isCurrent = currentPath.startsWith(href);
        return (
          <a
            href={href}
            class="chip focus-ring aria-[current=page]:ring-2 aria-[current=page]:ring-indigo-500"
            aria-current={isCurrent ? "page" : undefined}
            title={`Defunct brands in ${c.label}`}
          >
            {c.label}
          </a>
        );
      })}
    </nav>
  </section>

  <!-- Decades -->
  <section class="mt-6" role="region" aria-label="Browse by decade">
    <h2 class="text-lg font-semibold mb-2">Browse by Decade</h2>
    <p class="text-gray-600 dark:text-slate-300 text-sm mb-1">
      Explore brands by the decade they ended (or started when unknown).
    </p>

    <nav class="flex flex-wrap gap-2 items-center" role="navigation" aria-label="Decades">
      {availableDecadeLabels.slice(0, 6).map((label) => {
        const href = `/decade/${label}/`;
        const isCurrent = currentPath === href;
        return (
          <a
            href={href}
            class="chip focus-ring aria-[current=page]:ring-2 aria-[current=page]:ring-indigo-500"
            aria-current={isCurrent ? "page" : undefined}
            title={`Defunct brands from the ${label}`}
          >
            {label}
          </a>
        );
      })}
      <a
        href="/decade/"
        class="btn-primary focus-ring"
        aria-label={`View all decades${totalDecades ? ` (${totalDecades} available)` : ""}`}
        title="View all decades"
      >
        View all ¬ª
      </a>
    </nav>
  </section>

  <!-- Featured grid (enhanced: shows hook + fate icon, still clean) -->
  <section class="mt-6 lg:mt-8" role="region" aria-label="Recently defunct brands">
    <h2 class="text-lg font-semibold mb-2">Recently Defunct (featured)</h2>

    <div class="grid grid-cols-[repeat(auto-fill,minmax(260px,1fr))] gap-5">
      {featured.map((b) => {
        const yrs = yearsOf(b);
        const cat = b.__seo_category_label || b.category || "Brand";
        const hue = catHue(cat);
        const tint = `oklch(0.7 0.12 ${hue})`;
        const icon = fateIconOf(b);
        const fateType = fateTypeOf(b) || "other";
        const primary = primaryTextOf(b);
        const text = b?.hook ? primary : truncateInline(primary, 160);

        return (
          <article class="fcard group p-4" data-brand-slug={b.slug} style={{ "--tint": tint }}>
            <h3 class="card-title text-lg font-semibold leading-snug mb-1 text-slate-900/95 dark:text-slate-100">
              <a
                href={`/brand/${b.slug}/`}
                class="stretched-link focus-ring rounded-sm"
                title={`What happened to ${b.brand}?`}
              >
                {b.brand}
              </a>
            </h3>

            {/* Hook ‚Üí fate ‚Üí summary with icon; always show if any */}
            {text && (
              <p class="hook">
                <span aria-hidden="true">{icon}</span>
                <span class="sr-only">Fate: {fateType}</span>
                {' '}{text}
              </p>
            )}

            <div class="meta-row">
              {yrs && <span class="chip-lite" aria-label={`Years active ${yrs}`}>{yrs}</span>}
              {cat && <span class="chip-lite" title={`Category: ${cat}`}>üè∑Ô∏è {cat}</span>}
            </div>
          </article>
        );
      })}
    </div>
  </section>
</Base>
