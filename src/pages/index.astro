---
// src/pages/index.astro
import Base from "../layouts/Base.astro";
import {
  normalizeBrands,
  toYear,
  decadeStart,
  catHue,
  yearsOf,
  fateIconOf,
  fateTypeOf,
  primaryTextOf,
  truncateInline,
} from "../lib/brandUtils";

/* ---------- Load curated brand JSON ---------- */
const raw = import.meta.glob("/src/content/brands/*.json", {
  eager: true,
  import: "default",
}) as Record<string, any>;

/* ---------- Normalize brands (dedupe + taxonomy merge) ---------- */
const brands: any[] = normalizeBrands(raw);

/* ---------- Search index for live suggestions ---------- */
const searchIndex = brands
  .filter((b) => b?.brand && b?.slug)
  .map((b) => ({
    name: String(b.brand),
    url: `/brand/${encodeURIComponent(b.slug)}/`,
    category: String(b.__seo_category_label || b.category || "Brand"),
  }));

/* ---------- Categories (unique, alpha) ---------- */
const categories = Array.from(
  new Map(
    brands.map((b) => [String(b.__seo_category), String(b.__seo_category_label || b.category || "Brand")])
  ).entries()
)
  .map(([slug, label]) => ({ slug, label }))
  .sort((a, b) => a.label.localeCompare(b.label));

/* ---------- AVAILABLE decades only (prefer end year, fallback to start) ---------- */
const decadeSet = new Set<number>();
for (const b of brands) {
  const y = toYear(b?.active?.end) ?? toYear(b?.active?.start);
  if (y !== undefined) decadeSet.add(decadeStart(y));
}
const availableDecadeLabels: string[] = [...decadeSet]
  .sort((a, b) => a - b)
  .map((d) => `${d}s`);
const totalDecades = availableDecadeLabels.length;

/* ---------- Featured: most recently ended first (fallback to start) ---------- */
const featured = brands
  .slice()
  .sort((a, b) => {
    const ay = toYear(a?.active?.end) ?? toYear(a?.active?.start) ?? 0;
    const by = toYear(b?.active?.end) ?? toYear(b?.active?.start) ?? 0;
    return by - ay;
  })
  .slice(0, 9);

/* ---------- Stats (computed from brands only) ---------- */
const totalAll = brands.length;
// If you prefer end-years only, swap this to just end years
const allYears: number[] = [];
for (const it of brands) {
  const s = toYear(it?.active?.start);
  const e = toYear(it?.active?.end);
  if (typeof s === "number") allYears.push(s);
  if (typeof e === "number") allYears.push(e);
}
const minY = allYears.length ? Math.min(...allYears) : undefined;
const maxY = allYears.length ? Math.max(...allYears) : undefined;
const yearSpan = (minY && maxY) ? `${minY}‚Äì${maxY}` : "‚Äî";

const cats = new Set(brands.map(b => String(b.__seo_category || "")).filter(Boolean));
const catCount = cats.size || "‚Äî";

/* ---------- Featured collections (predicates) ---------- */
const in1990s = (b:any) => {
  const y = toYear(b?.active?.end) ?? toYear(b?.active?.start);
  return y != null && decadeStart(y) === 1990;
};
const isSnacky = (b:any) => {
  const cat = String(b.__seo_category || b.category || "").toLowerCase();
  const topics = (Array.isArray(b.topics) ? b.topics : []).map((t:string)=>t.toLowerCase());
  const hook = String(b.hook || "").toLowerCase();
  return cat.includes("food")
    || topics.some(t => /snack|snacks|beverage|drink|cereal/.test(t))
    || /snack|cereal|cola|soda|gum|pie|bar|beverage/.test(hook);
};
const isBigFailure = (b:any) => {
  const fate = String(b.fate || "").toLowerCase();
  const topics = (Array.isArray(b.topics) ? b.topics : []).map((t:string)=>t.toLowerCase());
  return /bankrupt|liquidat|fraud|insolv|collapse/.test(fate)
      || topics.some(t => /(bankruptcy|fraud|scandal|banking crisis)/.test(t));
};
const pick = (arr:any[], pred:(b:any)=>boolean, n=8) =>
  arr.filter(pred)
     .sort((a,b) => (toYear(b?.active?.end) ?? 0) - (toYear(a?.active?.end) ?? 0))
     .slice(0, n);

const C90s  = pick(brands, in1990s, 8);
const CFood = pick(brands, isSnacky, 8);
const CFail = pick(brands, isBigFailure, 8);

/* ---------- SEO ---------- */
const pageTitle = "Vanished Brands ‚Äî Defunct & Discontinued Brands Archive";
const pageDesc =
  "Explore discontinued and vanished brands with quick timelines, categories, decades, and a downloadable CSV dataset for research and journalism.";
const canonical = (Astro.site ? new URL("/", Astro.site).href : "/");

/* Identity + discovery */
const orgLd = {
  "@context": "https://schema.org",
  "@type": "Organization",
  name: "Vanished Brands",
  url: "https://vanishedbrands.com/",
  logo: "https://vanishedbrands.com/apple-touch-icon.png",
};
const siteLd = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: "Vanished Brands",
  url: "https://vanishedbrands.com/",
  potentialAction: {
    "@type": "SearchAction",
    target: "https://vanishedbrands.com/az/?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
};
const categoriesItemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: "Browse by Category",
  itemListOrder: "http://schema.org/ItemListOrderAscending",
  numberOfItems: categories.length,
  itemListElement: categories.map((c, i: number) => ({
    "@type": "ListItem",
    position: i + 1,
    name: c.label,
    url: Astro.site
      ? new URL(`/category/${c.slug}/`, Astro.site).href
      : `/category/${c.slug}/`,
  })),
};
const decadesItemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: "Browse by Decade",
  itemListOrder: "http://schema.org/ItemListOrderAscending",
  numberOfItems: availableDecadeLabels.length,
  itemListElement: availableDecadeLabels.map((label: string, i: number) => ({
    "@type": "ListItem",
    position: i + 1,
    name: label,
    url: Astro.site
      ? new URL(`/decade/${label}/`, Astro.site).href
      : `/decade/${label}/`,
  })),
};
const faqLd = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  mainEntity: [
    {
      "@type": "Question",
      name: "What is Vanished Brands?",
      acceptedAnswer: {
        "@type": "Answer",
        text:
          "An archive of discontinued and defunct brands with timelines, categories, and a purchasable CSV dataset for research.",
      },
    },
    {
      "@type": "Question",
      name: "Can I download the dataset?",
      acceptedAnswer: {
        "@type": "Answer",
        text:
          "Yes. A free sample CSV is available, and the full dataset can be purchased securely via PayPal.",
      },
    },
  ],
};

const currentPath = Astro.url.pathname;
---

<Base
  title={pageTitle}
  description={pageDesc}
  canonical={canonical}
  jsonLd={[orgLd, siteLd, categoriesItemListLd, decadesItemListLd, faqLd]}
>
  <!-- Shared card + UI styles -->
  <style is:inline>
    /* Featured collections */
    .featured-collections { margin: 44px 0; }
    .featured-collections > h2 { font-size: 22px; margin: 0 0 22px 0; }

    .collection {
      margin: 28px 0 44px;
    }

    /* ‚úÖ Clear separation between adjacent collections */
    .collection + .collection {
      margin-top: 44px;
      padding-top: 22px;
      position: relative;
    }

    /* Hairline divider (soft gradient that works in light & dark) */
    .collection + .collection::before {
      content: "";
      position: absolute;
      inset: 0 auto auto 0;
      right: 0;
      height: 1px;
      top: 0;
      background: linear-gradient(90deg, transparent, rgba(2, 6, 23, 0.08), transparent);
    }
    .dark .collection + .collection::before {
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.14), transparent);
    }

    .collection-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px; /* a bit more room above the grid */
    }

    .brand-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 18px; /* slightly larger to avoid crowding across collections */
    }

    @media (max-width: 768px) {
      .brand-grid { gap: 14px; }
    }

    .fcard {
      position: relative;
      border-radius: 1rem;
      border: 1px solid var(--card-border, rgb(226 232 240));
      background:
        linear-gradient(180deg, color-mix(in oklab, var(--tint) 12%, transparent) 0%, transparent 28%),
        var(--card-bg, #fff);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
      overflow: hidden;
    }
    .dark .fcard { --card-bg: rgb(2 6 23); --card-border: rgb(51 65 85); }
    .fcard:hover {
      transform: translateY(-2px);
      box-shadow:
        0 8px 16px -8px color-mix(in oklab, var(--tint) 35%, transparent),
        0 2px 10px -6px rgb(0 0 0 / .12);
    }
    .fcard-sm {
      position:relative; border-radius:.875rem; border:1px solid var(--card-border, rgb(226 232 240));
      background: var(--card-bg, #fff); padding:.75rem .85rem; overflow:hidden; transition: transform .16s ease, box-shadow .16s ease;
    }
    .fcard-sm:hover{ transform: translateY(-1px); box-shadow: 0 6px 12px -8px rgb(0 0 0 / .18); }
    .dark .fcard-sm{ --card-bg: rgb(2 6 23); --card-border: rgb(51 65 85); }

    .meta-row { display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.35rem }
    .chip-lite {
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.25rem .5rem; border-radius:9999px; font-size:.72rem; font-weight:600;
      background: color-mix(in oklab, var(--tint) 14%, white);
      border: 1px solid color-mix(in oklab, var(--tint) 28%, white);
      color: oklch(0.28 0 0);
    }
    .dark .chip-lite {
      background: color-mix(in oklab, var(--tint) 22%, rgb(2 6 23));
      border-color: color-mix(in oklab, var(--tint) 45%, rgb(2 6 23));
      color: white;
    }
    .hook {
      margin-top:.45rem;
      font-size:.9rem;
      line-height:1.25rem;
      color: rgb(71 85 105);
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    .dark .hook { color: rgb(203 213 225); }
    .card-title a:hover { text-decoration: underline; text-underline-offset: 3px; }

    /* ===== Hero + compact stats + search ===== */
    .hero-section {
      margin-top: 0.5rem;
      margin-bottom: 1.75rem;
    }

    .hero-inner {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .hero-title {
      font-size: clamp(1.9rem, 3vw, 2.4rem);
      font-weight: 800;
      letter-spacing: 0.01em;
      color: rgb(15 23 42);
    }
    .dark .hero-title {
      color: rgb(241 245 249);
    }

    .hero-subtitle {
      font-size: 0.95rem;
      line-height: 1.5rem;
      color: rgb(71 85 105);
      max-width: 44rem;
    }
    .dark .hero-subtitle {
      color: rgb(203 213 225);
    }

    .hero-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 0.35rem;
    }

    .hero-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.6rem 1rem;
      border-radius: 9999px;
      font-size: 0.9rem;
      font-weight: 600;
      text-decoration: none;
      border: 1px solid transparent;
      cursor: pointer;
      white-space: nowrap;
    }

    .hero-btn-primary {
      background: linear-gradient(135deg, #6366f1, #7c3aed);
      color: white;
    }
    .hero-btn-primary:hover {
      filter: brightness(1.05);
    }

    .hero-btn-secondary {
      background: transparent;
      border-color: rgba(148, 163, 184, 0.8);
      color: rgb(15 23 42);
    }
    .dark .hero-btn-secondary {
      color: rgb(226 232 240);
      border-color: rgba(148, 163, 184, 0.9);
    }

    .hero-btn-ghost {
      background: transparent;
      color: rgb(79 70 229);
    }
    .dark .hero-btn-ghost {
      color: rgb(165 180 252);
    }

    .hero-stats {
      margin-top: 0.5rem;
    }

    .hero-stats-list {
      display: flex;
      flex-wrap: wrap;
      gap: 1.25rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgb(100 116 139);
    }
    .dark .hero-stats-list {
      color: rgb(148 163 184);
    }

    .hero-stat {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .hero-stat dt {
      font-weight: 700;
      font-size: 0.95rem;
      color: rgb(15 23 42);
    }
    .dark .hero-stat dt {
      color: rgb(226 232 240);
    }

    .hero-stat dd {
      font-weight: 500;
    }

    @media (max-width: 640px) {
      .hero-actions {
        flex-direction: row;
        align-items: flex-start;
      }
    }

    /* Search + chips + suggestions */
    .searchwrap { display: grid; gap: 10px; margin-top: 0.75rem; }
    .search {
      display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 8px;
      background: linear-gradient(180deg, color-mix(in oklab, rgb(124 58 237) 8%, transparent), transparent 60%), white;
      border: 1px solid rgb(229 231 235); border-radius: 14px; padding: 6px;
      box-shadow: 0 8px 22px -14px rgb(0 0 0 / .18); position: relative;
    }
    .dark .search{
      background: linear-gradient(180deg, color-mix(in oklab, rgb(124 58 237) 18%, transparent), transparent 60%), rgb(2 6 23);
      border-color: rgb(51 65 85);
    }
    .search-icon { position: absolute; left: 18px; font-size: 16px; pointer-events: none; color: rgb(100 116 139); }
    .dark .search-icon { color: rgb(148 163 184); }
    .search input {
      grid-column: 1 / span 1; width: 100%; border: 0; background: transparent;
      padding: 12px 12px 12px 44px; font-size: 16px; color: rgb(15 23 42); outline: none; border-radius: 10px;
    }
    .dark .search input { color: white; }
    .search-btn {
      grid-column: 2 / span 1; padding: 10px 16px; border: 0; border-radius: 10px;
      background: linear-gradient(135deg, #6366f1, #7c3aed); color: white; font-weight: 700; cursor: pointer;
      transition: transform .04s ease, filter .2s ease;
    }
    .search-btn:hover { filter: brightness(1.08); }
    .search-btn:active { transform: translateY(1px); }
    .suggestions { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      display: inline-flex; align-items:center; gap:.35rem; padding: .35rem .55rem; border-radius: 9999px;
      font-size: 12px; font-weight: 600; color: rgb(30 41 59);
      background: color-mix(in oklab, rgb(99 102 241) 10%, white);
      border: 1px solid color-mix(in oklab, rgb(99 102 241) 22%, white); text-decoration: none;
    }

    .live-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      max-height: 260px;
      overflow-y: auto;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: white;
      box-shadow: 0 8px 22px -14px rgba(0, 0, 0, 0.25);
      z-index: 30;
    }
    .dark .live-suggestions {
      background: rgb(15 23 42);
      border-color: rgba(148, 163, 184, 0.6);
    }
    .live-suggestions a {
      display: block;
      padding: 8px 12px;
      font-size: 14px;
      color: rgb(30 41 59);
      text-decoration: none;
    }
    .dark .live-suggestions a {
      color: rgb(226 232 240);
    }
    .live-suggestions a:hover {
      background: rgb(239 246 255);
    }
    .dark .live-suggestions a:hover {
      background: rgb(30 64 175 / 0.35);
    }
    .live-suggestions .subtext {
      display: block;
      font-size: 11px;
      color: rgb(100 116 139);
    }
    .dark .live-suggestions .subtext {
      color: rgb(148 163 184);
    }

    .dark .chip {
      color: white;
      background: color-mix(in oklab, rgb(99 102 241) 22%, rgb(2 6 23));
      border-color: color-mix(in oklab, rgb(99 102 241) 40%, rgb(2 6 23));
    }
  </style>

  <!-- ‚≠ê Hero: single punchy sentence + CTAs + compact stats + search -->
  <section class="hero-section" aria-label="Vanished Brands intro">
    <div class="hero-inner">
      <h1 class="hero-title">
        The searchable archive of brands that disappeared.
      </h1>

      <p class="hero-subtitle">
        <strong>Vanished Brands</strong> is a searchable archive of {totalAll} defunct and discontinued brands,
        browsable by decade, category, and fate ‚Äî with a research-ready CSV dataset for journalists, analysts,
        and the merely nostalgic.
      </p>

      <div class="hero-actions" aria-label="Primary actions">
        <a href="/az/" class="hero-btn hero-btn-primary focus-ring">
          Browse brands A‚ÄìZ
        </a>
        <a href="/decade/" class="hero-btn hero-btn-secondary focus-ring">
          Explore by decade
        </a>
        <a href="/data/" class="hero-btn hero-btn-ghost focus-ring">
          Download dataset (CSV)
        </a>
      </div>

      <div class="hero-stats" aria-label="Archive summary">
        <dl class="hero-stats-list">
          <div class="hero-stat">
            <dt>{totalAll}</dt>
            <dd>Defunct brands</dd>
          </div>
          <div class="hero-stat">
            <dt>{yearSpan}</dt>
            <dd>Years covered</dd>
          </div>
          <div class="hero-stat">
            <dt>{catCount}</dt>
            <dd>Categories</dd>
          </div>
          <div class="hero-stat">
            <dt>Free sample</dt>
            <dd>CSV dataset</dd>
          </div>
        </dl>
      </div>

      <form class="searchwrap" role="search" action="/az/" method="GET">
        <div class="search">
          <span class="search-icon" aria-hidden="true">üîé</span>
          <input
            type="search"
            name="q"
            id="brandSearch"
            placeholder={`Search ${totalAll} brands: Blockbuster, Circuit City, Toys R Us‚Ä¶`}
            aria-label="Search defunct brands"
            autocomplete="off"
          />
          <button class="search-btn" type="submit">Search</button>

          <!-- Live suggestions dropdown -->
          <div
            id="brandSearch-suggestions"
            class="live-suggestions hidden"
            role="listbox"
            aria-label="Search suggestions"
          ></div>
        </div>

        <!-- Example search chips -->
        <div class="suggestions" aria-label="Example searches">
          <a href="/az/?q=Blockbuster" class="chip">Blockbuster</a>
          <a href="/az/?q=Circuit%20City" class="chip">Circuit City</a>
          <a href="/az/?q=Napster" class="chip">Napster</a>
          <a href="/decade/1990s/" class="chip">1990s</a>
        </div>
      </form>

      <!-- Inline brand search index for live suggestions -->
      <script
        id="brand-index"
        type="application/json"
        is:inline
        set:html={JSON.stringify(searchIndex)}
      />
    </div>
  </section>

  <!-- Minimal ‚Äúwhy this matters‚Äù tucked away -->
  <details class="mt-2">
    <summary class="cursor-pointer text-sm text-indigo-600 hover:underline">Why brands disappear</summary>
    <div class="prose dark:prose-invert max-w-none mt-2">
      <p>
        When smartphones absorbed MP3 players, when e-commerce reshaped malls, when streaming remade media ‚Äî
        vanished brands were the first visible signals of change. Each page summarizes the basics (founded,
        defunct, fate) with sources and related reading.
      </p>
    </div>
  </details>

  <p class="sr-only">
    Explore defunct and discontinued brands by category, decade, and A‚ÄìZ index.
    Each brand page summarizes the timeline, fate, and key facts. A downloadable CSV dataset
    is available for analysts, researchers, and journalists.
  </p>

  <!-- ‚≠ê Featured Collections -->
  <section class="featured-collections" aria-label="Featured Collections">
    <h2>Featured Collections</h2>

    {C90s.length > 0 && (
      <div class="collection">
        <div class="collection-header">
          <h3>üïπÔ∏è 90s Brands We Still Miss</h3>
          <a href="/decade/1990s/" class="see-all">See all 90s brands ‚Üí</a>
        </div>
        <div class="brand-grid">
          {C90s.map((b) => {
            const yrs = yearsOf(b);
            const cat = b.__seo_category_label || b.category || "Brand";
            const tint = `oklch(0.7 0.12 ${catHue(cat)})`;
            const icon = fateIconOf(b);
            const fateType = fateTypeOf(b) || "other";
            const text = truncateInline(primaryTextOf(b), 120);
            return (
              <article class="fcard-sm" style={{ "--tint": tint }}>
                <a
                  href={`/brand/${encodeURIComponent(b.slug)}/`}
                  class="stretched-link focus-ring rounded"
                  aria-label={`${b.brand}${yrs ? ` (${yrs})` : ""}${cat ? ` ‚Äî ${cat}` : ""}`}
                ></a>
                <h4 class="text-base font-semibold leading-snug mb-1">{b.brand}</h4>
                {text && (
                  <p class="hook">
                    <span aria-hidden="true">{icon}</span>
                    <span class="sr-only">Fate: {fateType}</span>
                    {" "}{text}
                  </p>
                )}
                <div class="meta-row">
                  {yrs && <span class="chip-lite" aria-label={`Years active ${yrs}`}>{yrs}</span>}
                  {cat && <span class="chip-lite" title={`Category: ${cat}`}>üè∑Ô∏è {cat}</span>}
                </div>
              </article>
            );
          })}
        </div>
      </div>
    )}

    {CFood.length > 0 && (
      <div class="collection">
        <div class="collection-header">
          <h3>üçø Discontinued Snacks We Crave</h3>
          <a href="/category/food-beverage/" class="see-all">See all food brands ‚Üí</a>
        </div>
        <div class="brand-grid">
          {CFood.map((b) => {
            const yrs = yearsOf(b);
            const cat = b.__seo_category_label || b.category || "Brand";
            const tint = `oklch(0.7 0.12 ${catHue(cat)})`;
            const icon = fateIconOf(b);
            const fateType = fateTypeOf(b) || "other";
            const text = truncateInline(primaryTextOf(b), 120);
            return (
              <article class="fcard-sm" style={{ "--tint": tint }}>
                <a
                  href={`/brand/${encodeURIComponent(b.slug)}/`}
                  class="stretched-link focus-ring rounded"
                  aria-label={`${b.brand}${yrs ? ` (${yrs})` : ""}${cat ? ` ‚Äî ${cat}` : ""}`}
                ></a>
                <h4 class="text-base font-semibold leading-snug mb-1">{b.brand}</h4>
                {text && (
                  <p class="hook">
                    <span aria-hidden="true">{icon}</span>
                    <span class="sr-only">Fate: {fateType}</span>
                    {" "}{text}
                  </p>
                )}
                <div class="meta-row">
                  {yrs && <span class="chip-lite" aria-label={`Years active ${yrs}`}>{yrs}</span>}
                  {cat && <span class="chip-lite" title={`Category: ${cat}`}>üè∑Ô∏è {cat}</span>}
                </div>
              </article>
            );
          })}
        </div>
      </div>
    )}

    {CFail.length > 0 && (
      <div class="collection">
        <div class="collection-header">
          <h3>üí∞ Billion-Dollar Failures</h3>
          <a href="/topics/bankruptcy/" class="see-all">See all bankruptcies ‚Üí</a>
        </div>
        <div class="brand-grid">
          {CFail.map((b) => {
            const yrs = yearsOf(b);
            const cat = b.__seo_category_label || b.category || "Brand";
            const tint = `oklch(0.7 0.12 ${catHue(cat)})`;
            const icon = fateIconOf(b);
            const fateType = fateTypeOf(b) || "other";
            const text = truncateInline(primaryTextOf(b), 120);
            return (
              <article class="fcard-sm" style={{ "--tint": tint }}>
                <a
                  href={`/brand/${encodeURIComponent(b.slug)}/`}
                  class="stretched-link focus-ring rounded"
                  aria-label={`${b.brand}${yrs ? ` (${yrs})` : ""}${cat ? ` ‚Äî ${cat}` : ""}`}
                ></a>
                <h4 class="text-base font-semibold leading-snug mb-1">{b.brand}</h4>
                {text && (
                  <p class="hook">
                    <span aria-hidden="true">{icon}</span>
                    <span class="sr-only">Fate: {fateType}</span>
                    {" "}{text}
                  </p>
                )}
                <div class="meta-row">
                  {yrs && <span class="chip-lite" aria-label={`Years active ${yrs}`}>{yrs}</span>}
                  {cat && <span class="chip-lite" title={`Category: {cat}`}>üè∑Ô∏è {cat}</span>}
                </div>
              </article>
            );
          })}
        </div>
      </div>
    )}
  </section>

  <!-- Categories -->
  <section class="mt-6" role="region" aria-label="Browse by category">
    <h2 class="text-lg font-semibold mb-2">Browse by Category</h2>
    <nav class="flex flex-wrap gap-2" role="navigation" aria-label="Categories">
      {categories.map((c) => {
        const href = `/category/${c.slug}/`;
        const isCurrent = currentPath.startsWith(href);
        return (
          <a
            href={href}
            class="chip focus-ring aria-[current=page]:ring-2 aria-[current=page]:ring-indigo-500"
            aria-current={isCurrent ? "page" : undefined}
            title={`Defunct brands in ${c.label}`}
          >
            {c.label}
          </a>
        );
      })}
    </nav>
  </section>

  <!-- Decades -->
  <section class="mt-6" role="region" aria-label="Browse by decade">
    <h2 class="text-lg font-semibold mb-2">Browse by Decade</h2>
    <p class="text-gray-600 dark:text-slate-300 text-sm mb-1">
      Explore brands by the decade they ended (or started when unknown).
    </p>

    <nav class="flex flex-wrap gap-2 items-center" role="navigation" aria-label="Decades">
      {availableDecadeLabels.slice(0, 6).map((label) => {
        const href = `/decade/${label}/`;
        const isCurrent = currentPath === href;
        return (
          <a
            href={href}
            class="chip focus-ring aria-[current=page]:ring-2 aria-[current=page]:ring-indigo-500"
            aria-current={isCurrent ? "page" : undefined}
            title={`Defunct brands from the ${label}`}
          >
            {label}
          </a>
        );
      })}
      <a
        href="/decade/"
        class="btn-primary focus-ring"
        aria-label={`View all decades${totalDecades ? ` (${totalDecades} available)` : ""}`}
        title="View all decades"
      >
        View all ¬ª
      </a>
    </nav>
  </section>

  <!-- Recently Defunct (featured) -->
  <section class="mt-6 lg:mt-8" role="region" aria-label="Recently defunct brands">
    <h2 class="text-lg font-semibold mb-2">Recently Defunct (featured)</h2>

    <div class="grid grid-cols-[repeat(auto-fill,minmax(260px,1fr))] gap-5">
      {featured.map((b) => {
        const yrs = yearsOf(b);
        const cat = b.__seo_category_label || b.category || "Brand";
        const hue = catHue(cat);
        const tint = `oklch(0.7 0.12 ${hue})`;
        const icon = fateIconOf(b);
        const fateType = fateTypeOf(b) || "other";
        const primary = primaryTextOf(b);
        const text = b?.hook ? primary : truncateInline(primary, 160);

        return (
          <article class="fcard group p-4" data-brand-slug={b.slug} style={{ "--tint": tint }}>
            <h3 class="card-title text-lg font-semibold leading-snug mb-1 text-slate-900/95 dark:text-slate-100">
              <a
                href={`/brand/${b.slug}/`}
                class="stretched-link focus-ring rounded-sm"
                title={`What happened to ${b.brand}?`}
              >
                {b.brand}
              </a>
            </h3>

            {text && (
              <p class="hook">
                <span aria-hidden="true">{icon}</span>
                <span class="sr-only">Fate: {fateType}</span>
                {' '}{text}
              </p>
            )}

            <div class="meta-row">
              {yrs && <span class="chip-lite" aria-label={`Years active ${yrs}`}>{yrs}</span>}
              {cat && <span class="chip-lite" title={`Category: ${cat}`}>üè∑Ô∏è {cat}</span>}
            </div>
          </article>
        );
      })}
    </div>
  </section>

  <!-- Live search behavior -->
  <script is:inline>
    document.addEventListener("DOMContentLoaded", function () {
      const input = document.getElementById("brandSearch");
      const dropdown = document.getElementById("brandSearch-suggestions");
      const indexScript = document.getElementById("brand-index");

      if (!input || !dropdown || !indexScript) {
        console.warn("Search suggestions: missing input, dropdown, or index script");
        return;
      }

      let index = [];
      try {
        const raw = indexScript.textContent || "[]";
        index = JSON.parse(raw);
      } catch (e) {
        console.error("Search suggestions: failed to parse index JSON", e);
        index = [];
      }

      if (!Array.isArray(index) || index.length === 0) {
        console.warn("Search suggestions: index is empty");
      }

      function clearSuggestions() {
        dropdown.innerHTML = "";
        dropdown.classList.add("hidden");
      }

      function renderSuggestions(items) {
        if (!items.length) {
          clearSuggestions();
          return;
        }

        dropdown.innerHTML = items
          .map(
            (item) => `
              <a href="${item.url}" role="option">
                <span>${item.name}</span>
                ${item.category ? `<span class="subtext">${item.category}</span>` : ""}
              </a>
            `
          )
          .join("");

        dropdown.classList.remove("hidden");
      }

      input.addEventListener("input", (event) => {
        const q = event.target.value.trim().toLowerCase();

        if (!q) {
          clearSuggestions();
          return;
        }

        const matches = index
          .filter((item) => {
            const name = (item.name || "").toLowerCase();
            const category = (item.category || "").toLowerCase();
            return name.includes(q) || category.includes(q);
          })
          .slice(0, 8);

        renderSuggestions(matches);
      });

      // Hide dropdown shortly after blur so clicks still register
      input.addEventListener("blur", () => {
        setTimeout(clearSuggestions, 150);
      });

      // Prevent blur from killing clicks inside the dropdown when clicking a suggestion
      dropdown.addEventListener("mousedown", (e) => {
        e.preventDefault();
      });
    });
  </script>
</Base>
