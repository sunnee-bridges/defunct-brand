---
// src/pages/brand/[slug].astro

import Base from "../../layouts/Base.astro";
import ExploreMore from "../../components/ExploreMore.astro";
import AffiliateDisclosure from "../../components/AffiliateDisclosure.astro";
import LearnMore from "../../components/LearnMore.astro";

/** Generate paths for each brand file */
export function getStaticPaths() {
  const modules = import.meta.glob("/src/content/brands/*.json");
  return Object.keys(modules).map((p) => {
    const slug = (p.split("/").pop() || "")
      .replace(/\.public\.json$/i, "")
      .replace(/\.json$/i, "");
    return { params: { slug } };
  });
}

/** Eagerly load all brand JSON for lookup at render time */
const brandModules = import.meta.glob("/src/content/brands/*.json", {
  eager: true,
  import: "default",
}) as Record<string, any>;

/** Resolve current brand */
const { slug } = Astro.params;
const modKey = `/src/content/brands/${slug}.json`;
const brand = (brandModules[modKey] as any) ?? null;
const notFound = !brand;

const slogan =
  brand?.slogan ??
  (Array.isArray(brand?.taglines) && brand.taglines.length ? brand.taglines[0].text : undefined);

/* ---------------- Helpers ---------------- */
function catToPath(cat?: string) {
  if (!cat) return null;
  const s = cat.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "");
  return `/category/${encodeURIComponent(s)}/`;
}

function titleFromSlug(s: string) {
  return s.replace(/-/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());
}

const COUNTRY_LABEL: Record<string, string> = {
  BS: "Bahamas", US: "United States", GB: "United Kingdom", CA: "Canada",
  DE: "Germany", FR: "France",
};
const countryLabel = (code?: string) =>
  COUNTRY_LABEL[String(code || "").toUpperCase()] || code || "";

/** Minimal Markdown‚ÜíHTML (bold, links, paragraphs, simple lists) */
function escapeHtml(s: string) {
  return String(s || "")
    .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

function mdToHtml(md: string) {
  md = String(md || "").replace(/\r\n?/g, "\n").trim();
  if (!md) return "";
  const blocks: string[] = [];
  const lines = md.split("\n");
  let i = 0;

  while (i < lines.length) {
    if (/^\s*-\s+/.test(lines[i])) {
      const items: string[] = [];
      while (i < lines.length && /^\s*-\s+/.test(lines[i])) {
        items.push(lines[i].replace(/^\s*-\s+/, ""));
        i++;
      }
      const ul =
        "<ul>" +
        items.map((item) => {
          let t = escapeHtml(item);
          t = t.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
          t = t.replace(
            /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
            `<a href="$2" target="_blank" rel="noopener">$1</a>`
          );
          return `<li>${t}</li>`;
        }).join("") +
        "</ul>";
      blocks.push(ul);
      while (i < lines.length && lines[i].trim() === "") i++;
      continue;
    }

    const para: string[] = [];
    while (i < lines.length && lines[i].trim() !== "") { para.push(lines[i]); i++; }
    while (i < lines.length && lines[i].trim() === "") i++;

    const raw = escapeHtml(para.join(" "));
    if (raw) {
      let html = raw;
      html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
      html = html.replace(
        /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
        `<a href="$2" target="_blank" rel="noopener">$1</a>`
      );
      blocks.push(`<p>${html}</p>`);
    }
  }
  return blocks.join("\n");
}

/** Inline-bold/links for short strings */
function inlineMd(s: string) {
  let t = escapeHtml(s || "");
  t = t.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
  t = t.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, `<a href="$2" target="_blank" rel="noopener">$1</a>`);
  return t;
}

/** Truncate text to character limit */
function truncateText(text: string, limit: number = 155): string {
  if (!text || text.length <= limit) return text;
  return text.substring(0, limit - 3).trim() + '...';
}

/** Check if brand has displayable quick facts */
function hasQuickFacts(brand: any): boolean {
  // Check quick_facts object
  if (brand?.quick_facts) {
    const facts = Object.values(brand.quick_facts).filter(
      v => v !== null && v !== undefined && v !== ''
    );
    if (facts.length > 0) return true;
  }
  
  // Check stats object for displayable retail/business stats
  if (brand?.stats) {
    const displayableKeys = [
      'peak_stores', 'years_in_business', 'years_available',
      'employees_at_peak', 'peak_year', 'founding_year',
      'closure_year', 'alcohol_content', 'category'
    ];
    return displayableKeys.some(key => {
      const val = brand.stats[key];
      return val !== null && val !== undefined && val !== '';
    });
  }
  
  return false;
}

/** Format field name for display */
function formatFieldName(key: string): string {
  const labelMap: Record<string, string> = {
    'product_type': 'Product Type',
    'alcohol_content': 'Alcohol Content',
    'launch_year': 'Launch Year',
    'discontinued_year': 'Discontinued',
    'years_available': 'Years Active',
    'signature_feature': 'Signature Feature',
    'flavor_profile': 'Flavor',
    'bottle_size': 'Bottle Size',
    'typical_price': 'Typical Price',
    'target_market': 'Target Market',
    'parent_company': 'Parent Company',
    'primary_competitor': 'Main Competitor',
    'market_position': 'Market Position',
    'distribution': 'Distribution',
    'actual_vodka_content': 'Vodka Content',
    'peak_stores': 'Peak Stores',
    'years_in_business': 'Years Active',
    'employees_at_peak': 'Employees (Peak)',
    'peak_year': 'Peak Year',
    'founding_year': 'Founded',
    'closure_year': 'Closed'
  };
  
  return labelMap[key] || key
    .replace(/_/g, ' ')
    .replace(/\b\w/g, c => c.toUpperCase());
}

/** Years-only helpers */
const startY = brand?.active?.start;
const endY   = brand?.active?.end;
const years  = (startY || endY)
  ? `${startY ?? "?"}${startY ? "\u2013" : ""}${startY ? (endY ?? "?") : ""}`
  : "";

/** Fate ‚Üí icon */
const fateIcons: Record<string, string> = {
  bankruptcy: "üí•", bankrupt: "üí•",
  acquired: "ü§ù", acquisition: "ü§ù",
  merged: "üîÄ", merge: "üîÄ",
  liquidated: "üìâ", liquidation: "üìâ",
  fraud: "‚ö†Ô∏è", scandal: "‚ö†Ô∏è",
  shutdown: "üîí", closed: "üîí",
  crisis: "üö®", insolvency: "üö®",
};

function pickFateIcon(fate?: string, topics?: string[]) {
  const tset = new Set((topics || []).map((x) => String(x).toLowerCase()));
  for (const k of tset) {
    if (fateIcons[k]) return fateIcons[k];
  }
  const f = String(fate || "").toLowerCase();
  if (/bankrupt|chapter\s*11|insolv/.test(f)) return fateIcons.bankruptcy;
  if (/acqui/.test(f)) return fateIcons.acquired;
  if (/merg/.test(f)) return fateIcons.merged;
  if (/liquidat/.test(f)) return fateIcons.liquidated;
  if (/fraud|scandal/.test(f)) return fateIcons.fraud;
  if (/shut\s*down|closed/.test(f)) return fateIcons.shutdown;
  if (/crisis/.test(f)) return fateIcons.crisis;
  return "‚ÑπÔ∏è";
}

/* ---------------- Derived blocks ---------------- */
let pageTitle = "Page not found";
let pageDesc  = "Try another page or browse the full list.";
let canonical = Astro.site ? new URL("/az/", Astro.site).href : "/az/";
let jsonLdBlocks: any[] = [];
let ogImage = "";
let ogImageAlt = "";
let twitterCard = "summary_large_image";
let keywords = "";

type LinkItem = { href: string; label: string; external?: boolean; rel?: string };
let internalLinks: LinkItem[] = [];
let authorityLinks: LinkItem[] = [];
let mediaLinks: LinkItem[] = [];

let overviewHtml = "";
let timeline: Array<{ date: string; text?: string; year?: number; milestone?: string }> = [];
let sources: Array<{ label?: string; url: string }> = [];

/* Pull a 4-digit year (or echo original date) */
const yearOf = (d?: string) => (String(d || "").match(/\d{4}/)?.[0] || String(d || ""));

if (!notFound) {
  // Prefer author's Markdown body
  if (brand?.overview_md) {
    overviewHtml = mdToHtml(String(brand.overview_md));
  } else if (brand?.content?.introduction) {
    overviewHtml = mdToHtml(String(brand.content.introduction));
  }

  // Timeline/Sources (optional)
  timeline = Array.isArray(brand?.timeline) ? brand.timeline : [];
  sources =
    Array.isArray(brand?.sources) && brand.sources.length
      ? brand.sources
      : brand?.links?.wikipedia
      ? [{ label: "Wikipedia", url: brand.links.wikipedia }]
      : [];

  // SEO bits ‚Äî prefer SEO fields, then hook, else fate, else summary
  const activeStr = `${brand.active?.start ?? "?"}\u2013${brand.active?.end ?? "?"}`;
  const descPref = (brand.hook || brand.fate || brand.summary || "").trim();

  // SEO-optimized title
  pageTitle = brand?.seo?.meta_title || 
    `What Happened to ${brand.brand}?${years ? ` (${years})` : ''} - Complete Story`;

  // SEO-optimized description (max 155 characters)
  pageDesc = brand?.seo?.meta_description || 
    truncateText(`${brand.brand}${years ? ` (${years})` : ''}: ${descPref}`, 155);

  // Keywords
  keywords = brand?.seo?.keywords?.join(', ') || '';

  const brandPath = brand?.url || `/brand/${encodeURIComponent(brand.slug || slug)}/`;
  canonical = brand?.canonical || (Astro.site ? new URL(brandPath, Astro.site).href : brandPath);

  const siteOrigin = Astro.site?.origin || "https://vanishedbrands.com";
  const perBrandOg  = `/og/brand/${encodeURIComponent(brand.slug || slug)}.png`;
  ogImage     = brand?.og?.image || new URL(perBrandOg, siteOrigin).toString();
  ogImageAlt  = brand?.og?.image_alt || `What happened to ${brand.brand}?`;
  twitterCard = brand?.twitter?.card || "summary_large_image";

  const sameAs: string[] = [];
  if (brand?.links?.wikipedia) sameAs.push(String(brand.links.wikipedia));
  if (brand?.schema?.sameAs) {
    sameAs.push(...(Array.isArray(brand.schema.sameAs) ? brand.schema.sameAs : [brand.schema.sameAs]));
  }

  // Enhanced Brand Schema
  const brandLd = {
    ["@context"]: "https://schema.org",
    ["@type"]: brand?.schema?.["@type"] || "Brand",
    ["@id"]: canonical + "#brand",
    name: brand.brand,
    alternateName: brand?.schema?.alternateName,
    description: descPref || undefined,
    url: canonical,
    sameAs: sameAs.length ? sameAs : undefined,
    foundingDate: brand?.schema?.foundingDate || (brand?.active?.start ? `${brand.active.start}` : undefined),
    dissolutionDate: brand?.schema?.dissolutionDate || (brand?.active?.end ? `${brand.active.end}` : undefined),
    category: brand.category || undefined,
    founder: brand?.schema?.founder,
    location: brand?.schema?.location,
    parentOrganization: brand?.schema?.parentOrganization,
  };

  // Enhanced Article Schema
  const articleLd = {
    ["@context"]: "https://schema.org",
    ["@type"]: "Article",
    headline: pageTitle,
    description: pageDesc,
    image: ogImage,
    datePublished: brand?.publishing?.published_date || 
      brand?.publishing?.datePublished ||
      (brand?.active?.start ? `${brand.active.start}-01-01` : undefined),
    dateModified: brand?.publishing?.last_updated || 
      brand?.publishing?.dateModified ||
      new Date().toISOString().split('T')[0],
    author: brand?.publishing?.author ? {
      ["@type"]: brand.publishing.author.name ? "Person" : "Organization",
      name: brand.publishing.author.name || "Vanished Brands Editorial Team",
      url: brand.publishing.author.url
    } : {
      ["@type"]: "Organization",
      name: "Vanished Brands Editorial Team"
    },
    publisher: {
      ["@type"]: "Organization",
      name: "Vanished Brands",
      url: siteOrigin,
      logo: {
        ["@type"]: "ImageObject",
        url: new URL("/logo.png", siteOrigin).toString()
      }
    },
    mainEntityOfPage: {
      ["@type"]: "WebPage",
      ["@id"]: canonical
    },
    wordCount: brand?.publishing?.word_count,
    keywords: keywords || undefined
  };

  const webPageLd = {
    ["@context"]: "https://schema.org",
    ["@type"]: "WebPage",
    url: canonical,
    name: pageTitle,
    description: pageDesc,
    mainEntity: { ["@id"]: canonical + "#brand" },
    primaryImageOfPage: { ["@type"]: "ImageObject", url: ogImage },
    breadcrumb: { ["@id"]: canonical + "#breadcrumb" }
  };

  const breadcrumbsLd = {
    ["@context"]: "https://schema.org",
    ["@type"]: "BreadcrumbList",
    ["@id"]: canonical + "#breadcrumb",
    itemListElement: [
      { ["@type"]: "ListItem", position: 1, name: "Home", item: Astro.site ? new URL("/", Astro.site).href : "/" },
      { ["@type"]: "ListItem", position: 2, name: "A‚ÄìZ",  item: Astro.site ? new URL("/az/", Astro.site).href : "/az/" },
      { ["@type"]: "ListItem", position: 3, name: brand.brand, item: canonical },
    ],
  };

  jsonLdBlocks = [brandLd, articleLd, webPageLd, breadcrumbsLd];

  // FAQ Schema
  if (Array.isArray(brand?.content?.faq) && brand.content.faq.length > 0) {
    const faqLd = {
      ["@context"]: "https://schema.org",
      ["@type"]: "FAQPage",
      mainEntity: brand.content.faq.map((item: any) => ({
        ["@type"]: "Question",
        name: item.question,
        acceptedAnswer: {
          ["@type"]: "Answer",
          text: item.answer
        }
      }))
    };
    jsonLdBlocks.push(faqLd);
  }

  // Image Schema
  if (brand?.images?.hero) {
    const imageLd = {
      ["@context"]: "https://schema.org",
      ["@type"]: "ImageObject",
      url: brand.images.hero.url,
      description: brand.images.hero.alt,
      width: brand.images.hero.width || 1200,
      height: brand.images.hero.height || 630,
      caption: brand.images.hero.caption
    };
    jsonLdBlocks.push(imageLd);
  }

  // Set Last-Modified header
  if (brand?.publishing?.last_updated) {
    try {
      Astro.response.headers.set(
        'Last-Modified',
        new Date(brand.publishing.last_updated).toUTCString()
      );
    } catch (e) {
      // Ignore if headers already sent
    }
  }

  // ---------- LearnMore links ----------
  internalLinks = [{ href: "/az/", label: "Browse A‚ÄìZ" }];
  const catPath = catToPath(brand?.category);
  if (catPath) internalLinks.push({ href: catPath, label: `More in ${brand.category}` });

  if (Array.isArray(brand?.topics) && brand.topics.length > 0) {
  // normalize category to a slug so "Retail" matches "retail"
  const categorySlug = String(brand?.category || "")
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");

  const uniq = Array.from(new Set(brand.topics.map((t: string) => String(t))));

  // remove any topic that matches the category (e.g., topic "retail" when category is "Retail")
  const filtered = uniq.filter((t) => {
    const tSlug = String(t)
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/^-+|-+$/g, "");
    return tSlug !== categorySlug;
  });

  filtered.slice(0, 2).forEach((t) => {
    internalLinks.push({
      href: `/topics/${encodeURIComponent(t)}/`,
      label: `More in ${titleFromSlug(t)}`
    });
  });
}


  // Add related articles
  if (Array.isArray(brand?.related_articles) && brand.related_articles.length > 0) {
    brand.related_articles.slice(0, 3).forEach((article: string) => {
      internalLinks.push({ href: article, label: article.split('/').pop()?.replace(/-/g, ' ') || 'Related Article' });
    });
  }

  if (brand?.links?.wikipedia)
    authorityLinks.push({ href: String(brand.links.wikipedia), label: `${brand.brand} on Wikipedia`, external: true });
  if (brand?.links?.official)
    authorityLinks.push({ href: String(brand.links.official), label: "Official site (archived)", external: true, rel: "noopener nofollow" });
  if (brand?.links?.wayback)
    authorityLinks.push({ href: String(brand.links.wayback), label: "Archived homepage (Wayback)", external: true });
  if (brand?.links?.verge)
    mediaLinks.push({ href: String(brand.links.verge), label: "The Verge retrospective", external: true });
  if (brand?.links?.cnet)
    mediaLinks.push({ href: String(brand.links.cnet), label: "CNET photo gallery", external: true });
}
---

<Base
  title={pageTitle}
  description={pageDesc}
  canonical={canonical}
  jsonLd={jsonLdBlocks}
>
  <Fragment slot="head">
    <meta name="robots" content="max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
    {notFound && <meta name="robots" content="noindex,follow" />}
    {keywords && <meta name="keywords" content={keywords} />}
    
    {!notFound && (
      <>
        {/* Open Graph */}
        <meta property="og:type" content={brand?.og?.type || "website"} />
        <meta property="og:site_name" content="Vanished Brands" />
        <meta property="og:title" content={brand?.og?.title || pageTitle} />
        <meta property="og:description" content={brand?.og?.description || pageDesc} />
        <meta property="og:url" content={brand?.og?.url || canonical} />
        <meta property="og:image" content={ogImage} />
        <meta property="og:image:alt" content={ogImageAlt} />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="630" />
        
        {/* Twitter Card */}
        <meta name="twitter:card" content={twitterCard} />
        <meta name="twitter:title" content={brand?.twitter?.title || pageTitle} />
        <meta name="twitter:description" content={brand?.twitter?.description || pageDesc} />
        <meta name="twitter:image" content={brand?.twitter?.image || ogImage} />
        <meta name="twitter:image:alt" content={brand?.twitter?.image_alt || ogImageAlt} />
        {brand?.twitter?.site && <meta name="twitter:site" content={brand.twitter.site} />}
        {brand?.twitter?.creator && <meta name="twitter:creator" content={brand.twitter.creator} />}
        
        {/* Additional SEO */}
        <link rel="alternate" hreflang="en" href={canonical} />
        <link rel="alternate" hreflang="x-default" href={canonical} />
      </>
    )}
  </Fragment>

  {notFound ? (
    <>
      <nav class="flex flex-wrap items-center gap-2 my-3">
        <a href="/" class="chip focus-ring">‚Üê Home</a>
        <a href="/az/" class="chip focus-ring">Browse A‚ÄìZ</a>
      </nav>
      <h1 class="text-2xl md:text-3xl font-bold mb-2">Page not found</h1>
      <p class="text-slate-600 dark:text-slate-300">Try another page or browse the full list.</p>
    </>
  ) : (
    <>
      {/* Breadcrumb Navigation */}
      <nav aria-label="Breadcrumb" class="mb-4">
        <ol class="flex flex-wrap items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
          <li>
            <a href="/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Home</a>
          </li>
          <li aria-hidden="true">‚Ä∫</li>
          <li>
            <a href="/az/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">A‚ÄìZ</a>
          </li>
          {brand.category && catToPath(brand.category) && (
            <>
              <li aria-hidden="true">‚Ä∫</li>
              <li>
                <a href={catToPath(brand.category)} class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                  {brand.category}
                </a>
              </li>
            </>
          )}
          <li aria-hidden="true">‚Ä∫</li>
          <li aria-current="page" class="font-semibold text-slate-900 dark:text-slate-100">
            {brand.brand}
          </li>
        </ol>
      </nav>

      <nav class="flex flex-wrap items-center gap-2 my-3">
        <a href="/" class="chip focus-ring">‚Üê Home</a>
        <a href="/az/" class="chip focus-ring">Browse A‚ÄìZ</a>
      </nav>

      <h1 id="brand-title" class="text-2xl md:text-3xl font-bold mb-1">
        What Happened to {brand.brand}?
        {Array.isArray(brand?.topics) && brand.topics.includes("scandal") && (
          <span
            class="ml-2 inline-flex items-center rounded-full bg-rose-50 px-2 py-0.5 text-[12px] font-medium text-rose-700
                   dark:bg-rose-900/30 dark:text-rose-300"
            title="Ended due to scandal"
          >
            ‚ö†Ô∏è Scandal
          </span>
        )}
      </h1>

      {/* Metadata row: years, category, read time */}
      {(years || brand.category || brand?.publishing?.estimated_read_time) && (
        <div class="text-sm text-slate-700 dark:text-slate-300 mb-3 flex flex-wrap items-center gap-2">
          {years && (
            <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-2 py-0.5 dark:border-slate-700 dark:bg-slate-900">
              {years}
            </span>
          )}
          {brand.category && (
            <a href={catToPath(brand.category) || "#"} class="chip focus-ring">
              {brand.category}
            </a>
          )}
          {brand.country && (
            <span class="text-slate-500 dark:text-slate-400">‚Ä¢ {countryLabel(brand.country)}</span>
          )}
          {brand?.publishing?.estimated_read_time && (
            <span class="text-slate-500 dark:text-slate-400">
              ‚Ä¢ ‚è±Ô∏è {brand.publishing.estimated_read_time} min read
            </span>
          )}
        </div>
      )}

      {/* Fate (prominent on brand page) */}
      {brand.fate && (
        <p class="mt-2 mb-8 text-base text-slate-800 dark:text-slate-200">
          <strong>{pickFateIcon(brand.fate, brand.topics)} Fate:</strong>{" "}
          <Fragment set:html={inlineMd(brand.fate)} />
        </p>
      )}

      {/* Hook/Excerpt if available */}
      {false && brand.hook && (
        <p class="mt-3 text-lg font-medium text-slate-700 dark:text-slate-300 border-l-4 border-blue-500 pl-4">
          {brand.hook}
        </p>
      )}

      {/* Optional short summary for backwards compatibility */}
      {brand.summary && (
        <p class="mt-2 text-gray-700 dark:text-slate-300">{brand.summary}</p>
      )}

      {/* Quick Facts Card - Supports both quick_facts and stats */}
      {hasQuickFacts(brand) && (
        <aside class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
          <h3 class="font-semibold text-blue-900 dark:text-blue-100 mb-3">Quick Facts</h3>
          <dl class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
            {/* Prefer quick_facts if available */}
            {brand?.quick_facts ? (
              <>
                {Object.entries(brand.quick_facts).map(([key, value]) => {
                  if (!value) return null;
                  return (
                    <>
                      <dt class="text-slate-600 dark:text-slate-400">{formatFieldName(key)}:</dt>
                      <dd class="font-semibold text-slate-900 dark:text-slate-100">
                        {typeof value === 'number' ? value.toLocaleString() : value}
                      </dd>
                    </>
                  );
                })}
              </>
            ) : (
              <>
                {/* Fallback to stats */}
                {brand.stats.peak_stores && (
                  <>
                    <dt class="text-slate-600 dark:text-slate-400">Peak Stores:</dt>
                    <dd class="font-semibold text-slate-900 dark:text-slate-100">
                      {brand.stats.peak_stores.toLocaleString()}
                    </dd>
                  </>
                )}
                {brand.stats.years_in_business && (
                  <>
                    <dt class="text-slate-600 dark:text-slate-400">Years Active:</dt>
                    <dd class="font-semibold text-slate-900 dark:text-slate-100">
                      {brand.stats.years_in_business}
                    </dd>
                  </>
                )}
                {brand.stats.years_available && (
                  <>
                    <dt class="text-slate-600 dark:text-slate-400">Years Available:</dt>
                    <dd class="font-semibold text-slate-900 dark:text-slate-100">
                      {brand.stats.years_available}
                    </dd>
                  </>
                )}
                {brand.stats.employees_at_peak && (
                  <>
                    <dt class="text-slate-600 dark:text-slate-400">Employees (Peak):</dt>
                    <dd class="font-semibold text-slate-900 dark:text-slate-100">
                      {brand.stats.employees_at_peak.toLocaleString()}
                    </dd>
                  </>
                )}
                {brand.stats.peak_year && (
                  <>
                    <dt class="text-slate-600 dark:text-slate-400">Peak Year:</dt>
                    <dd class="font-semibold text-slate-900 dark:text-slate-100">
                      {brand.stats.peak_year}
                    </dd>
                  </>
                )}
                {brand.stats.founding_year && (
                  <>
                    <dt class="text-slate-600 dark:text-slate-400">Founded:</dt>
                    <dd class="font-semibold text-slate-900 dark:text-slate-100">
                      {brand.stats.founding_year}
                    </dd>
                  </>
                )}
                {brand.stats.closure_year && (
                  <>
                    <dt class="text-slate-600 dark:text-slate-400">Closed:</dt>
                    <dd class="font-semibold text-slate-900 dark:text-slate-100">
                      {brand.stats.closure_year}
                    </dd>
                  </>
                )}
                {brand.stats.alcohol_content && (
                  <>
                    <dt class="text-slate-600 dark:text-slate-400">Alcohol Content:</dt>
                    <dd class="font-semibold text-slate-900 dark:text-slate-100">
                      {brand.stats.alcohol_content}
                    </dd>
                  </>
                )}
                {brand.stats.category && (
                  <>
                    <dt class="text-slate-600 dark:text-slate-400">Category:</dt>
                    <dd class="font-semibold text-slate-900 dark:text-slate-100">
                      {brand.stats.category}
                    </dd>
                  </>
                )}
              </>
            )}
          </dl>
        </aside>
      )}

      {/* Table of Contents */}
      {Array.isArray(brand?.content?.sections) && brand.content.sections.length > 3 && (
        <nav class="my-6 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700" aria-label="Table of contents">
          <h2 class="text-lg font-semibold mb-3 text-slate-900 dark:text-slate-100">Contents</h2>
          <ol class="space-y-2 list-decimal list-inside text-sm">
            {brand.content.sections.map((section: any) => (
              <li>
                <a 
                  href={`#${section.slug || section.id}`}
                  class="text-blue-600 dark:text-blue-400 hover:underline"
                >
                  {section.heading}
                </a>
              </li>
            ))}
          </ol>
        </nav>
      )}

      {/* Overview body (Markdown) */}
      {(brand.overview_md || overviewHtml || brand?.content?.introduction) && (
        <section aria-label="Overview" class="prose prose-sm dark:prose-invert max-w-none mt-6">
          <Fragment set:html={overviewHtml || mdToHtml(String(brand.overview_md || brand?.content?.introduction || ""))} />
        </section>
      )}

      {/* Main Content Sections */}
      {Array.isArray(brand?.content?.sections) && brand.content.sections.length > 0 && (
        <div class="mt-8 space-y-8">
          {brand.content.sections.map((section: any) => (
            <section 
              id={section.slug || section.id} 
              aria-labelledby={`heading-${section.slug || section.id}`}
              class="scroll-mt-20"
            >
              <h2 
                id={`heading-${section.slug || section.id}`}
                class="text-2xl font-bold mb-4 text-slate-900 dark:text-slate-100"
              >
                {section.heading}
              </h2>
              <div class="prose prose-sm dark:prose-invert max-w-none">
                <Fragment set:html={mdToHtml(section.content)} />
              </div>
            </section>
          ))}
        </div>
      )}

      {/* Timeline */}
      {Array.isArray(timeline) && timeline.length > 0 && (
        <section aria-label="Timeline" class="mt-8">
          <h2 class="text-xl font-bold mb-4 text-slate-900 dark:text-slate-100">
            Timeline
          </h2>
          <ul class="space-y-3 border-l-2 border-blue-500 pl-4">
            {timeline.map((t) => (
              <li class="relative">
                <div class="absolute -left-[21px] top-1 w-3 h-3 bg-blue-500 rounded-full border-2 border-white dark:border-slate-900"></div>
                <div>
                  <strong class="text-slate-900 dark:text-slate-100">{yearOf(t.date)}</strong>
                  {t.text && (
                    <p class="mt-1 text-slate-700 dark:text-slate-300">
                      <Fragment set:html={inlineMd(t.text)} />
                    </p>
                  )}
                </div>
              </li>
            ))}
          </ul>
        </section>
      )}

      {/* FAQ Section */}
      {Array.isArray(brand?.content?.faq) && brand.content.faq.length > 0 && (
        <section aria-label="Frequently Asked Questions" class="mt-10">
          <h2 class="text-2xl font-bold mb-6 text-slate-900 dark:text-slate-100">
            Frequently Asked Questions
          </h2>
          <div class="space-y-6">
            {brand.content.faq.map((item: any) => (
              <div class="border-l-4 border-blue-500 pl-4 py-2">
                <h3 class="text-lg font-semibold mb-2 text-slate-800 dark:text-slate-200">
                  {item.question}
                </h3>
                <div class="text-slate-700 dark:text-slate-300 prose prose-sm dark:prose-invert max-w-none">
                  <Fragment set:html={mdToHtml(item.answer)} />
                </div>
              </div>
            ))}
          </div>
        </section>
      )}

      {/* Related Brands */}
      {Array.isArray(brand?.related_brands) && brand.related_brands.length > 0 && (
        <section aria-label="Related brands" class="mt-10 border-t pt-8 border-slate-200 dark:border-slate-700">
          <h2 class="text-2xl font-bold mb-6 text-slate-900 dark:text-slate-100">Related Brands</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {brand.related_brands.map((related: any) => (
              <a 
                href={`/brand/${related.slug}/`}
                class="block p-4 border rounded-lg hover:shadow-md transition-all
                       bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700
                       hover:border-blue-500 dark:hover:border-blue-400"
              >
                <h3 class="font-semibold text-slate-900 dark:text-slate-100 mb-1">
                  {related.name}
                </h3>
                {related.relationship && (
                  <p class="text-sm text-slate-600 dark:text-slate-400">
                    {related.relationship}
                  </p>
                )}
              </a>
            ))}
          </div>
        </section>
      )}

      {/* Sources */}
      {Array.isArray(sources) && sources.length > 0 && (
        <section aria-label="Sources" class="mt-8">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-300 mb-3">
            Explore More
          </h3>
          <ul class="list-disc pl-5 space-y-2 text-sm">
            {sources.map((s) => (
              <li>
                <a 
                  href={s.url} 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="text-blue-600 dark:text-blue-400 hover:underline"
                >
                  {s.label || s.url}
                </a>
              </li>
            ))}
          </ul>
        </section>
      )}

      {/* Publishing metadata */}
      {brand?.publishing && (
        <div class="mt-8 pt-6 border-t border-slate-200 dark:border-slate-700 text-xs text-slate-500 dark:text-slate-400">
          {brand.publishing.published_date && (
            <p>Published: {new Date(brand.publishing.published_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
          )}
          {brand.publishing.last_updated && (
            <p>Last updated: {new Date(brand.publishing.last_updated).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
          )}
          {brand.publishing.author?.name && (
            <p>Author: {brand.publishing.author.name}</p>
          )}
        </div>
      )}

      {/* Existing UI 
      <ExploreMore brand={brand} /> */}

      {(internalLinks.length || authorityLinks.length || mediaLinks.length) && (
        <LearnMore internal={internalLinks} authority={authorityLinks} media={mediaLinks} />
      )}

      {/* <AffiliateDisclosure /> */}
    </>
  )}
</Base>