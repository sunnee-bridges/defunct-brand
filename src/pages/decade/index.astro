---
// src/pages/decade/index.astro
import Base from "../../layouts/Base.astro";
import { slugify } from "../../lib/slug.js";

/* ---- Load curated brand JSON at build time & de-dupe by slug ---- */
const modules = import.meta.glob("/src/content/brands/*.json", {
  eager: true,
  import: "default",
}) as Record<string, any>;

const bySlug = new Map<string, any>();
for (const raw of Object.values(modules)) {
  const b = raw as any;
  if (!b) continue;
  const key =
    String(b.slug || "").trim().toLowerCase() ||
    slugify(String(b.brand || ""));
  if (!key) continue;
  if (typeof b.category === "string") b.category = b.category.trim();
  if (!bySlug.has(key)) bySlug.set(key, b); // first-wins
}
const brands: any[] = Array.from(bySlug.values());

/* ---- Helpers ---- */
const toYear = (v: unknown): number | undefined => {
  if (v == null) return undefined;
  const m = String(v).match(/\d{3,4}/);
  if (!m) return undefined;
  const n = parseInt(m[0], 10);
  return Number.isFinite(n) ? n : undefined;
};
const decadeStart = (y: number) => Math.floor(y / 10) * 10;
const labelOf = (start: number) => `${start}s`;

/* ---- Build: decade label -> count (prefer end year, fallback start) ---- */
const counts = new Map<string, number>();
for (const b of brands) {
  const y = toYear(b?.active?.end) ?? toYear(b?.active?.start);
  if (y == null) continue;
  const label = labelOf(decadeStart(y));
  counts.set(label, (counts.get(label) ?? 0) + 1);
}

/* ---- Sorted available decades (e.g., "1990s", "2000s") ---- */
const decades = [...counts.keys()].sort((a, b) => parseInt(a) - parseInt(b));

/* ---- SEO ---- */
const PAGE_TITLE = "Browse by Decade ‚Ä¢ Defunct Brands";
const PAGE_DESC = decades.length
  ? `Browse defunct brands by decade (${decades[0]}‚Äì${decades[decades.length - 1]}).`
  : "Browse defunct brands by decade.";
const CANONICAL = Astro.site ? new URL("/decade/", Astro.site).href : "/decade/";

/* ---- JSON-LD ItemList for the decade list ---- */
const itemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: "Defunct brands by decade",
  itemListElement: decades.map((d, i) => ({
    "@type": "ListItem",
    position: i + 1,
    name: d,
    url: Astro.site ? new URL(`/decade/${d}/`, Astro.site).href : `/decade/${d}/`,
    numberOfItems: counts.get(d) ?? 0,
  })),
};
---

<Base title={PAGE_TITLE} description={PAGE_DESC}>
  <!-- üîé SEO head -->
  <Fragment slot="head">
    <link rel="canonical" href={CANONICAL} />
    <meta name="description" content={PAGE_DESC} />

    <meta property="og:type" content="website" />
    <meta property="og:url" content={CANONICAL} />
    <meta property="og:title" content={PAGE_TITLE} />
    <meta property="og:description" content={PAGE_DESC} />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={PAGE_TITLE} />
    <meta name="twitter:description" content={PAGE_DESC} />

    <script type="application/ld+json">{JSON.stringify(itemListLd)}</script>
  </Fragment>

  <!-- üß≠ Breadcrumb + header (mirrors Categories page) -->
  <div class="max-w-6xl mx-auto px-4">
    <nav class="mb-3 flex flex-wrap gap-2" aria-label="Breadcrumb">
      <a href="/" class="chip focus-ring">‚Üê Home</a>
      <span class="chip opacity-70 cursor-default" aria-current="page">Decades</span>
    </nav>

    <h1 id="top" class="text-2xl md:text-3xl font-bold mb-1">Browse by Decade</h1>
    <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">Total decades: {decades.length}</p>

    {decades.length === 0 ? (
      <p class="text-slate-600 dark:text-slate-400">No decades available yet.</p>
    ) : (
      <ul class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        {decades.map((d) => (
          <li>
            <a
              href={`/decade/${d}/`}
              class="chip focus-ring block"
              title={`${counts.get(d)} ${counts.get(d) === 1 ? "brand" : "brands"} in the ${d}s`}
              aria-label={`${d}s (${counts.get(d)} ${counts.get(d) === 1 ? "brand" : "brands"})`}
            >
              {d} <span class="text-gray-500">({counts.get(d)})</span>
            </a>
          </li>
        ))}
      </ul>
    )}
  </div>
</Base>
