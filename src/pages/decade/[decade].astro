---
// src/pages/decade/[decade].astro
import Base from "../../layouts/Base.astro";
import { slugify } from "../../lib/slug.js";

/* ---------- small helpers (runtime-safe) ---------- */
function parseYearRT(v: unknown): number | undefined {
  if (v == null) return undefined;
  const m = String(v).match(/\d{3,4}/);
  if (!m) return undefined;
  const n = parseInt(m[0], 10);
  return Number.isFinite(n) ? n : undefined;
}
const decadeLabel = (start: number) => `${start}s`;
const decadeStartFromParam = (p: string | undefined): number | null => {
  if (!p) return null;
  const m = p.match(/^(\d{3,4})s$/i);
  return m ? parseInt(m[1], 10) : null;
};
const inDecade = (year: number | undefined, start: number) =>
  typeof year === "number" && year >= start && year <= start + 9;

/** Build a clean year range: 1990–2001, 1990–?, or –2001 (if only one side known) */
function yearsOf(b: any): string {
  const s = b?.active?.start;
  const e = b?.active?.end;
  if (s && e) return `${s}\u2013${e}`;
  if (s && !e) return `${s}\u2013?`;
  if (!s && e) return `\u2013${e}`;
  return ""; // unknown
}

/* ---------- build-time: pre-generate decades that exist ---------- */
export async function getStaticPaths() {
  function parseYear(v: unknown): number | undefined {
    if (v == null) return undefined;
    const m = String(v).match(/\d{3,4}/);
    if (!m) return undefined;
    const n = parseInt(m[0], 10);
    return Number.isFinite(n) ? n : undefined;
  }

  const mods = import.meta.glob("/src/content/brands/*.json", {
    eager: true,
    import: "default",
  }) as Record<string, any>;

  // curated + de-duped by slug (fallback to slugified brand)
  const bySlug = new Map<string, any>();
  for (const raw of Object.values(mods)) {
    const b = raw as any;
    if (!b) continue;
    const key =
      String(b.slug || "").trim().toLowerCase() ||
      slugify(String(b.brand || ""));
    if (!key) continue;
    if (!bySlug.has(key)) bySlug.set(key, b); // first wins
  }
  const brands: any[] = Array.from(bySlug.values());

  const byDecade: Record<string, any[]> = {};
  for (const b of brands) {
    const endY = parseYear(b?.active?.end);
    const startY = parseYear(b?.active?.start);
    const y = endY ?? startY;
    if (y == null) continue;
    const start = Math.floor(y / 10) * 10;
    const key = `${start}s`;
    (byDecade[key] ||= []).push(b);
  }

  return Object.keys(byDecade)
    .sort((a, b) => parseInt(a) - parseInt(b))
    .map((dec) => ({
      params: { decade: dec },
      props: {
        decade: dec,
        start: parseInt(dec, 10),
        items: byDecade[dec]
          .slice()
          .sort((a, b) => (a.brand || "").localeCompare(b.brand || "")),
      },
    }));
}

/* ---------- runtime: load curated + de-duped set ---------- */
function loadDedupedPublicBrandsRuntime() {
  const mods = import.meta.glob("/src/content/brands/*.json", {
    eager: true,
    import: "default",
  }) as Record<string, any>;

  const bySlug = new Map<string, any>();
  for (const raw of Object.values(mods)) {
    const b = raw as any;
    if (!b) continue;
    const key =
      String(b.slug || "").trim().toLowerCase() ||
      slugify(String(b.brand || ""));
    if (!key) continue;
    if (!bySlug.has(key)) bySlug.set(key, b);
  }
  return Array.from(bySlug.values());
}

/* ---------- runtime props + safe fallback ---------- */
const allBrands = loadDedupedPublicBrandsRuntime();

let { decade, start, items } = Astro.props as {
  decade?: string; start?: number; items?: any[];
};

if (!decade) {
  const s = decadeStartFromParam(Astro.params.decade) ?? NaN;
  start = s;
  decade = Number.isFinite(s) ? decadeLabel(s) : "Decade";
  items = Number.isFinite(s)
    ? allBrands
        .filter((b) =>
          inDecade(
            parseYearRT(b?.active?.end) ?? parseYearRT(b?.active?.start),
            s
          )
        )
        .sort((a, b) => (a.brand || "").localeCompare(b.brand || ""))
    : [];
}

/* ---------- 404 guard ---------- */
const notFound = !Number.isFinite(start!) || (items?.length ?? 0) === 0;
if (notFound) Astro.response.status = 404;

/* ---------- SEO ---------- */
const PAGE_TITLE = notFound
  ? "Page not found"
  : `Defunct Brands in the ${decade}`;
const PAGE_DESC = notFound
  ? "Try another page or jump to a random brand."
  : `Explore ${items!.length} brands from the ${decade}.`;

const CANONICAL = notFound
  ? (Astro.site ? new URL("/decade/", Astro.site).href : "/decade/")
  : (Astro.site ? new URL(`/decade/${decade}/`, Astro.site).href : `/decade/${decade}/`);

const breadcrumbsLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: Astro.site ? new URL("/", Astro.site).href : "/" },
    { "@type": "ListItem", position: 2, name: "Decades", item: Astro.site ? new URL("/decade/", Astro.site).href : "/decade/" },
    !notFound && { "@type": "ListItem", position: 3, name: decade, item: CANONICAL },
  ].filter(Boolean),
};

const LD_MAX = 100;
const itemListLd = !notFound
  ? {
      "@context": "https://schema.org",
      "@type": "ItemList",
      name: `Brands in the ${decade}`,
      itemListOrder: "http://schema.org/ItemListOrderAscending",
      numberOfItems: items!.length,
      itemListElement: items!.slice(0, LD_MAX).map((b: any, i: number) => ({
        "@type": "ListItem",
        position: i + 1,
        name: b.brand,
        url: Astro.site
          ? new URL(`/brand/${encodeURIComponent(b.slug)}/`, Astro.site).href
          : `/brand/${encodeURIComponent(b.slug)}/`,
      })),
    }
  : null;
---

<Base title={PAGE_TITLE} description={PAGE_DESC}>
  <!-- SEO head -->
  <Fragment slot="head">
    <link rel="canonical" href={CANONICAL} />
    <meta property="og:url" content={CANONICAL} />
    <meta property="og:title" content={PAGE_TITLE} />
    <meta property="og:description" content={PAGE_DESC} />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={PAGE_TITLE} />
    <meta name="twitter:description" content={PAGE_DESC} />
    {notFound && <meta name="robots" content="noindex,follow" />}
    <script type="application/ld+json">{JSON.stringify(breadcrumbsLd)}</script>
    {!notFound && itemListLd && (
      <script type="application/ld+json">{JSON.stringify(itemListLd)}</script>
    )}
  </Fragment>

  <!-- Top nav chips -->
  <nav class="mb-4 flex flex-wrap gap-2">
    <a href="/" class="chip focus-ring">← Home</a>
    <a href="/decade/" class="chip focus-ring">All decades</a>
  </nav>

  {notFound ? (
    <>
      <h1 class="text-2xl md:text-3xl font-bold mb-2">Page not found</h1>
      <p class="text-slate-600 dark:text-slate-300">
        Try another page or jump to a random brand.
      </p>
      <div class="mt-4 flex gap-2">
        <a href="/az/" class="chip focus-ring">Browse A–Z</a>
        <a href="/category/" class="chip focus-ring">Categories</a>
        <a href="/decade/" class="chip focus-ring">Decades</a>
      </div>
    </>
  ) : (
    <>
      <h1 class="text-2xl md:text-3xl font-bold mb-2">
        Defunct Brands in the {decade}
      </h1>
      <p class="text-slate-600 dark:text-slate-300 mb-3">{PAGE_DESC}</p>

      <!-- Minimal list: Brand title + YEAR RANGE ONLY + Category -->
      <ul id="brandList" class="grid grid-cols-[repeat(auto-fill,minmax(260px,1fr))] gap-3">
        {items!.map((b: any) => {
          const yrs = yearsOf(b);
          const cat = b?.category || "";
          return (
            <li>
              <article
                class="relative group rounded-xl p-4 border transition
                       bg-white border-gray-200 hover:bg-slate-50
                       dark:bg-slate-900 dark:border-slate-700 dark:hover:bg-slate-800
                       focus-within:ring-2 focus-within:ring-indigo-500
                       focus-within:ring-offset-2 focus-within:ring-offset-white
                       dark:focus-within:ring-offset-slate-900 h-full"
              >
                <!-- Full-card click -->
                <a
                  href={`/brand/${encodeURIComponent(b.slug)}/`}
                  class="stretched-link focus-ring rounded"
                  aria-label={`${b.brand}${yrs ? ` (${yrs})` : ""}${cat ? ` — ${cat}` : ""}`}
                ></a>

                <!-- Brand title -->
                <h3 class="text-base font-semibold mb-1 text-slate-900 dark:text-slate-100 group-hover:underline underline-offset-2 line-clamp-2">
                  {b.brand}
                </h3>

                <!-- Years ONLY -->
                {yrs && (
                  <div class="text-sm text-gray-700 dark:text-slate-200">
                    {yrs}
                  </div>
                )}

                <!-- Category ONLY -->
                {cat && (
                  <div class="text-xs text-gray-500 dark:text-slate-400 mt-1">
                    {cat}
                  </div>
                )}
              </article>
            </li>
          );
        })}
      </ul>
    </>
  )}
</Base>
