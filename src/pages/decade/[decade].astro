---
// src/pages/decade/[decade].astro
import Base from "../../layouts/Base.astro";
import { slugify } from "../../lib/slug.js";

/* ---------- small helpers (runtime-safe) ---------- */
function parseYearRT(v: unknown): number | undefined {
  if (v == null) return undefined;
  const m = String(v).match(/\d{3,4}/);
  if (!m) return undefined;
  const n = parseInt(m[0], 10);
  return Number.isFinite(n) ? n : undefined;
}
const decadeLabel = (start: number) => `${start}s`;
const decadeStartFromParam = (p: string | undefined): number | null => {
  if (!p) return null;
  const m = p.match(/^(\d{3,4})s$/i);
  return m ? parseInt(m[1], 10) : null;
};
const inDecade = (year: number | undefined, start: number) =>
  typeof year === "number" && year >= start && year <= start + 9;

/* ---------- build-time: pre-generate decades that exist ---------- */
export async function getStaticPaths() {
  // define local helper here so it's always available in build step
  function parseYear(v: unknown): number | undefined {
    if (v == null) return undefined;
    const m = String(v).match(/\d{3,4}/);
    if (!m) return undefined;
    const n = parseInt(m[0], 10);
    return Number.isFinite(n) ? n : undefined;
  }

  // curated + de-duped
  const mods = import.meta.glob("/content/brands/*.public.json", {
    eager: true,
    import: "default",
  }) as Record<string, any>;

  const bySlug = new Map<string, any>();
  for (const raw of Object.values(mods)) {
    const b = raw as any;
    if (!b) continue;
    const key =
      String(b.slug || "").trim().toLowerCase() ||
      slugify(String(b.brand || ""));
    if (!key) continue;
    if (!bySlug.has(key)) bySlug.set(key, b); // first wins
  }
  const brands: any[] = Array.from(bySlug.values());

  const byDecade: Record<string, any[]> = {};
  for (const b of brands) {
    const endY = parseYear(b?.active?.end);
    const startY = parseYear(b?.active?.start);
    const y = endY ?? startY;
    if (y == null) continue;
    const start = Math.floor(y / 10) * 10;
    const key = `${start}s`;
    (byDecade[key] ||= []).push(b);
  }

  return Object.keys(byDecade)
    .sort((a, b) => parseInt(a) - parseInt(b))
    .map((dec) => ({
      params: { decade: dec },
      props: {
        decade: dec,
        start: parseInt(dec, 10),
        items: byDecade[dec]
          .slice()
          .sort((a, b) => (a.brand || "").localeCompare(b.brand || "")),
      },
    }));
}

/* ---------- runtime: load curated + de-duped set ---------- */
function loadDedupedPublicBrandsRuntime() {
  const mods = import.meta.glob("/content/brands/*.public.json", {
    eager: true,
    import: "default",
  }) as Record<string, any>;

  const bySlug = new Map<string, any>();
  for (const raw of Object.values(mods)) {
    const b = raw as any;
    if (!b) continue;
    const key =
      String(b.slug || "").trim().toLowerCase() ||
      slugify(String(b.brand || ""));
    if (!key) continue;
    if (!bySlug.has(key)) bySlug.set(key, b);
  }
  return Array.from(bySlug.values());
}

/* ---------- runtime props + safe fallback ---------- */
const allBrands = loadDedupedPublicBrandsRuntime();

let { decade, start, items } = Astro.props as {
  decade?: string; start?: number; items?: any[];
};

if (!decade) {
  const s = decadeStartFromParam(Astro.params.decade) ?? NaN;
  start = s;
  decade = Number.isFinite(s) ? decadeLabel(s) : "Decade";
  items = Number.isFinite(s)
    ? allBrands
        .filter((b) =>
          inDecade(
            parseYearRT(b?.active?.end) ?? parseYearRT(b?.active?.start),
            s
          )
        )
        .sort((a, b) => (a.brand || "").localeCompare(b.brand || ""))
    : [];
}

/* ---------- 404 guard ---------- */
const notFound = !Number.isFinite(start!) || (items?.length ?? 0) === 0;
if (notFound) Astro.response.status = 404;

/* ---------- SEO ---------- */
const PAGE_TITLE = notFound
  ? "Page not found"
  : `Defunct Brands in the ${decade}`;
const PAGE_DESC = notFound
  ? "Try another page or jump to a random brand."
  : `Explore ${items!.length} brands from the ${decade}.`;

const CANONICAL = notFound
  ? (Astro.site ? new URL("/decade/", Astro.site).href : "/decade/")
  : (Astro.site ? new URL(`/decade/${decade}/`, Astro.site).href : `/decade/${decade}/`);

const breadcrumbsLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: Astro.site ? new URL("/", Astro.site).href : "/" },
    { "@type": "ListItem", position: 2, name: "Decades", item: Astro.site ? new URL("/decade/", Astro.site).href : "/decade/" },
    !notFound && { "@type": "ListItem", position: 3, name: decade, item: CANONICAL },
  ].filter(Boolean),
};

const LD_MAX = 100;
const itemListLd = !notFound
  ? {
      "@context": "https://schema.org",
      "@type": "ItemList",
      name: `Brands in the ${decade}`,
      itemListOrder: "http://schema.org/ItemListOrderAscending",
      numberOfItems: items!.length,
      itemListElement: items!.slice(0, LD_MAX).map((b: any, i: number) => ({
        "@type": "ListItem",
        position: i + 1,
        name: b.brand,
        url: Astro.site
          ? new URL(`/brand/${encodeURIComponent(b.slug)}/`, Astro.site).href
          : `/brand/${encodeURIComponent(b.slug)}/`,
      })),
    }
  : null;
---

<Base title={PAGE_TITLE} description={PAGE_DESC}>
  <!-- SEO head -->
  <Fragment slot="head">
    <link rel="canonical" href={CANONICAL} />
    <meta property="og:url" content={CANONICAL} />
    <meta property="og:title" content={PAGE_TITLE} />
    <meta property="og:description" content={PAGE_DESC} />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={PAGE_TITLE} />
    <meta name="twitter:description" content={PAGE_DESC} />
    {notFound && <meta name="robots" content="noindex,follow" />}
    <script type="application/ld+json">{JSON.stringify(breadcrumbsLd)}</script>
    {!notFound && itemListLd && (
      <script type="application/ld+json">{JSON.stringify(itemListLd)}</script>
    )}
  </Fragment>

  <!-- Top nav chips -->
  <nav class="mb-4 flex flex-wrap gap-2">
    <a href="/" class="chip focus-ring">← Home</a>
    <a href="/decade/" class="chip focus-ring">All decades</a>
    <a href="#" data-random class="btn-primary focus-ring">Random</a>
  </nav>

  {notFound ? (
    <>
      <h1 class="text-2xl md:text-3xl font-bold mb-2">Page not found</h1>
      <p class="text-slate-600 dark:text-slate-300">
        Try another page or jump to a random brand.
      </p>
      <div class="mt-4 flex gap-2">
        <a href="/az/" class="chip focus-ring">Browse A–Z</a>
        <a href="/category/" class="chip focus-ring">Categories</a>
        <a href="/decade/" class="chip focus-ring">Decades</a>
        <a href="#" data-random class="btn-primary focus-ring">Random</a>
      </div>
    </>
  ) : (
    <>
      <h1 class="text-2xl md:text-3xl font-bold mb-2">
        Defunct Brands in the {decade}
      </h1>
      <p class="text-slate-600 dark:text-slate-300 mb-3">{PAGE_DESC}</p>

      <!-- Controls -->
      <div class="mb-3 flex flex-wrap items-center gap-3">
        <label for="q" class="text-sm text-slate-600 dark:text-slate-300">Search</label>
        <input
          id="q"
          type="search"
          class="rounded-md border border-slate-300 bg-white px-3 py-2 text-slate-900 placeholder-slate-400 focus-ring dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
          placeholder="Search brands…"
          inputmode="search"
        />

        <label for="fate" class="text-sm text-slate-600 dark:text-slate-300">Status</label>
        <select
          id="fate"
          class="rounded-md border border-slate-300 bg-white px-3 py-2 text-slate-900 focus-ring dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
        >
          <option value="">All</option>
          <option value="acquired">Acquired</option>
          <option value="bankrupt">Bankrupt</option>
          <option value="merged">Merged</option>
          <option value="discontinued">Discontinued</option>
        </select>

        <label for="sort" class="text-sm text-slate-600 dark:text-slate-300">Sort</label>
        <select
          id="sort"
          class="rounded-md border border-slate-300 bg-white px-3 py-2 text-slate-900 focus-ring dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
        >
          <option value="alpha">A → Z</option>
          <option value="start-asc">Oldest founded</option>
          <option value="end-desc">Most recent closure</option>
        </select>
      </div>

      <!-- Active filter chips -->
      <div id="activeChips" class="mb-3 flex flex-wrap gap-2" aria-live="polite"></div>

      <!-- List -->
      <ul id="brandList" class="grid grid-cols-[repeat(auto-fill,minmax(240px,1fr))] gap-3">
        {items!.map((b: any) => (
          <li
            data-brand={(b.brand || "").toLowerCase()}
            data-fate={(b.fate || "").toLowerCase()}
            data-start={b.active?.start || "0"}
            data-end={b.active?.end || "0"}
          >
            <article
              class="relative group rounded-xl p-4 border transition
                     bg-white border-gray-200 hover:bg-slate-50
                     dark:bg-slate-900 dark:border-slate-700 dark:hover:bg-slate-800
                     focus-within:ring-2 focus-within:ring-indigo-500
                     focus-within:ring-offset-2 focus-within:ring-offset-white
                     dark:focus-within:ring-offset-slate-900"
            >
              <!-- Full-card click -->
              <a
                href={`/brand/${encodeURIComponent(b.slug)}/`}
                class="stretched-link focus-ring rounded"
                aria-label={`${b.brand}${b.active?.start ? ` (${b.active.start}–${b.active?.end ?? "?"})` : ""}${b.fate ? ` — ${b.fate}` : ""}`}
              ></a>

              <h3 class="text-base font-semibold mb-1 text-slate-900 dark:text-slate-100 group-hover:underline underline-offset-2">
                {b.brand}
              </h3>
              <div class="text-sm text-gray-600 dark:text-slate-300">
                {b.active?.start ?? ""}{b.active?.start ? '\u2013' : ''}{b.active?.start ? (b.active?.end ?? '?') : ''}{b.fate ? ` \u2014 ${b.fate}` : ""}
              </div>
              <div class="text-xs text-gray-500 dark:text-slate-400 mt-1">{b.category}</div>
            </article>
          </li>
        ))}
      </ul>

      <!-- Empty state -->
      <div id="emptyBlock" class="hidden mt-2 text-slate-600 dark:text-slate-300">
        No matches. Try clearing filters or searching fewer terms.
        <button
          id="clearAll"
          class="ml-2 inline-flex items-center rounded-md border border-slate-200 bg-white px-2.5 py-1 text-sm text-slate-900 focus-ring dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
        >
          Clear all
        </button>
      </div>
    </>
  )}
</Base>

<!-- Client-side filters (no deps) -->
<script>
  const $  = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));

  const list  = $("#brandList");
  const q     = $("#q");
  const fate  = $("#fate");
  const sort  = $("#sort");
  const chips = $("#activeChips");
  const empty = $("#emptyBlock");
  const clearAllBtn = $("#clearAll");

  /* URL → controls */
  const params = new URLSearchParams(location.search);
  if (params.has("q")) q.value = params.get("q") || "";
  if (params.has("status")) fate.value = params.get("status") || "";
  if (params.has("sort")) sort.value = params.get("sort") || "alpha";

  function pushURL(){
    const p = new URLSearchParams();
    if (q.value.trim()) p.set("q", q.value.trim());
    if (fate.value) p.set("status", fate.value);
    if (sort.value && sort.value !== "alpha") p.set("sort", sort.value);
    const qs = p.toString();
    history.replaceState(null, "", qs ? `?${qs}` : location.pathname);
  }

  function renderChips(){
    chips.innerHTML = "";
    const fr = document.createDocumentFragment();

    if (q.value.trim()){
      const el = document.createElement("span");
      el.className = "chip inline-flex items-center gap-1";
      el.innerHTML = `<strong>Search:</strong> ${escapeHtml(q.value.trim())} <button aria-label="Clear search">✕</button>`;
      el.querySelector("button").onclick = () => { q.value = ""; onChange(); q.focus(); };
      fr.appendChild(el);
    }
    if (fate.value){
      const el = document.createElement("span");
      el.className = "chip inline-flex items-center gap-1";
      el.innerHTML = `<strong>Status:</strong> ${escapeHtml(fate.value)} <button aria-label="Clear status">✕</button>`;
      el.querySelector("button").onclick = () => { fate.value = ""; onChange(); fate.focus(); };
      fr.appendChild(el);
    }
    if (fr.childNodes.length){
      const clear = document.createElement("button");
      clear.textContent = "Clear all";
      clear.className = "chip focus-ring cursor-pointer";
      clear.onclick = () => { q.value = ""; fate.value = ""; sort.value = "alpha"; onChange(); };
      fr.appendChild(clear);
    }
    chips.appendChild(fr);
  }

  function applyFilters(){
    const term = (q.value || "").trim().toLowerCase();
    const st   = (fate.value || "").toLowerCase();

    let visible = 0;
    $$("#brandList > li").forEach(li => {
      const t = li.dataset.brand || "";
      const f = li.dataset.fate || "";
      const show = (!term || t.includes(term)) && (!st || f.includes(st));
      li.style.display = show ? "" : "none";
      if (show) visible++;
    });
    empty.classList.toggle("hidden", !!visible);
  }

  function applySort(){
    const mode = sort.value;
    const rows = $$("#brandList > li").filter(li => li.style.display !== "none");
    const name = (li)=> (li.dataset.brand || "");
    const num  = (v)=> parseInt(v || "0", 10);

    rows.sort((a,b)=>{
      if (mode === "alpha") return name(a).localeCompare(name(b));
      if (mode === "start-asc") return num(a.dataset.start)-num(b.dataset.start) || name(a).localeCompare(name(b));
      if (mode === "end-desc") return num(b.dataset.end)-num(a.dataset.end) || name(a).localeCompare(name(b));
      return 0;
    });
    rows.forEach(r => list.appendChild(r));
  }

  function onChange(){ applyFilters(); applySort(); renderChips(); pushURL(); }

  // debounce search
  let t; q.addEventListener("input", () => { clearTimeout(t); t = setTimeout(onChange, 150); });
  fate.addEventListener("change", onChange);
  sort.addEventListener("change", onChange);

  // keyboard niceties
  window.addEventListener("keydown", (e) => {
    if (e.key === "/" && document.activeElement?.tagName !== "INPUT"){ e.preventDefault(); q.focus(); }
    else if (e.key === "Escape" && q.value){ q.value=""; onChange(); }
  });

  clearAllBtn?.addEventListener("click", ()=>{ q.value=""; fate.value=""; sort.value="alpha"; onChange(); });

  // init
  onChange();

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
</script>
