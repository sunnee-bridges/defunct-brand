---
// src/pages/buy.astro — SDK-free PayPal redirect flow

const CLIENT_ID =
  import.meta.env.PUBLIC_PAYPAL_CLIENT_ID || import.meta.env.PAYPAL_CLIENT_ID || "";
const ENV = (import.meta.env.PUBLIC_PAYPAL_ENV || "sandbox").toLowerCase();

const title = "Buy the Full CSV";
const price = "9.00"; // USD
const PAYPAL_HOST = ENV === "live" ? "www.paypal.com" : "www.sandbox.paypal.com";
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{--fg:#111827;--muted:#6b7280;}
      @media (prefers-color-scheme: dark){:root{--fg:#e5e7eb;--muted:#9ca3af;}}
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;margin:0;padding:2rem;color:var(--fg);}
      .wrap{max-width:720px;margin:0 auto;}
      .muted{color:var(--muted);}
      .link{color:#2563eb;text-decoration:underline;}
      #result{margin-top:1rem}
      .note{font-size:.875rem;margin-top:.5rem}
      .row{margin:.75rem 0}
      .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem .9rem;border-radius:.75rem;border:1px solid #d1d5db;background:#fff;text-decoration:none;font-weight:600}
      .btn:hover{background:#f3f4f6}
      .hidden{display:none}
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>{title}</h1>
      <p>Get instant access to the full dataset (CSV). Price: <strong>${price} USD</strong>.</p>

      <div class="row">
        <button id="checkout" class="btn" type="button" aria-label="Checkout with PayPal">
          <!-- simple PayPal wordmark -->
          <svg width="24" height="24" viewBox="0 0 48 32" aria-hidden="true"><rect width="48" height="32" rx="4" fill="#fff"/><path d="M14 8h6.5c3.8 0 6.2 2 5.6 5.5-.6 3.4-3.4 5.5-7.3 5.5h-2.1l-.9 4.5h-3.2L14 8z" fill="#003087"/><path d="M20.8 10c2.4 0 3.6 1.2 3.3 3-.3 2-2.2 3-4.5 3h-2.2l.9-6h2.5z" fill="#009CDE"/></svg>
          <span>Checkout with PayPal</span>
        </button>
        <span id="loading" class="muted hidden" aria-live="polite">Loading…</span>
      </div>

      <div id="result" class="note muted"></div>

      <!-- tiny env hint; remove later -->
      <p class="note muted">ENV: {ENV} • CLIENT_ID: {CLIENT_ID ? CLIENT_ID.slice(0,10) + "…" : "(none)"}</p>
      <p class="note muted">Payments are processed securely by PayPal. You’ll receive a one-time download link immediately after purchase.</p>
    </div>

    <script is:inline>
      (function(){
        var PAYPAL_HOST = {JSON.stringify(PAYPAL_HOST)};

        function $(id){ return document.getElementById(id); }
        function show(el){ if (el) el.classList.remove('hidden'); }
        function hide(el){ if (el) el.classList.add('hidden'); }
        function setResult(t){ var r=$('result'); if (r) r.textContent = t || ''; }
        function httpJSON(url, opts){
          return fetch(url, opts || {}).then(function(r){
            return r.json().then(function(data){ return { ok:r.ok, status:r.status, data:data }; })
              .catch(function(){ return { ok:r.ok, status:r.status, data:null }; });
          });
        }

        // 1) Create order → redirect to PayPal
        function startCheckout(){
          hide($('result')); setResult('');
          show($('loading'));
          httpJSON('/.netlify/functions/paypal-create-order').then(function(res){
            if (!res.ok || !res.data || !res.data.id) {
              hide($('loading'));
              setResult('Create order failed (HTTP ' + res.status + '). Please retry.');
              return;
            }
            var token = res.data.id;
            // Redirect to PayPal hosted checkout
            window.location.href = 'https://' + PAYPAL_HOST + '/checkoutnow?token=' + encodeURIComponent(token);
          }).catch(function(){
            hide($('loading')); setResult('Network error creating order.');
          });
        }

        // 2) On return from PayPal (?token=ORDER_ID), capture + deliver
        function handleReturn(){
          var qs = new URLSearchParams(window.location.search);
          var orderID = qs.get('token'); // PayPal returns "token" = Order ID
          if (!orderID) return;

          hide($('checkout')); show($('loading'));
          setResult('Finalizing payment…');

          httpJSON('/.netlify/functions/paypal-capture-order', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ orderID: orderID })
          }).then(function(cap){
            if (!cap.ok || !cap.data || !cap.data.ok || !cap.data.token) {
              hide($('loading'));
              var msg = (cap.data && cap.data.error) ? cap.data.error : ('Capture failed (HTTP ' + cap.status + ').');
              setResult(msg);
              return;
            }
            return httpJSON('/.netlify/functions/download-link', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ token: cap.data.token })
            }).then(function(dl){
              hide($('loading'));
              if (!dl.ok || !dl.data || !dl.data.url) {
                var msg2 = (dl.data && dl.data.error) ? dl.data.error : ('Download link error (HTTP ' + dl.status + ').');
                setResult(msg2);
                return;
              }
              // Show the download link
              var a = document.createElement('a');
              a.href = dl.data.url;
              a.textContent = 'Click to download your CSV';
              a.className = 'link';
              a.rel = 'noopener';
              var res = $('result'); if (res){ res.innerHTML=''; res.appendChild(a); }
              // Optional: remove query params so refresh is clean
              try { window.history.replaceState({}, '', window.location.pathname); } catch(e){}
            });
          }).catch(function(){
            hide($('loading')); setResult('Network error during capture.');
          });
        }

        window.addEventListener('load', function(){
          handleReturn(); // if coming back from PayPal
          var btn = $('checkout');
          if (btn) btn.addEventListener('click', startCheckout);
        });
      })();
    </script>
  </body>
</html>
