---
// /src/pages/buy.astro
import Base from "../layouts/Base.astro";

const CLIENT_ID =
  import.meta.env.PUBLIC_PAYPAL_CLIENT_ID || import.meta.env.PAYPAL_CLIENT_ID || "";
const ENV = (import.meta.env.PUBLIC_PAYPAL_ENV || "sandbox").toLowerCase();

const title = "Buy the Full CSV";
const description = "Secure checkout via PayPal. Receive a one-time download link after purchase.";
const price = "9.00"; // USD
---

<Base title={title} description={description}>
  <!-- Head slot: SDK + small wrapper CSS -->
  <Fragment slot="head">
    {CLIENT_ID && (
      <script
        src={`https://www.paypal.com/sdk/js?client-id=${CLIENT_ID}&currency=USD&intent=capture&components=buttons`}
        defer
      />
    )}
    <style>
      {`
      /* Keep PayPal wrappers transparent (outside iframe) */
      #paypal-btns > div,
      #paypal-btns .paypal-buttons,
      #paypal-btns .paypal-button-row,
      #paypal-btns .paypal-button-container,
      #paypal-btns iframe { background: transparent !important; }
      `}
    </style>
  </Fragment>

  <!-- Nav chips: explicit Tailwind with dark:hover states -->
  <nav class="mb-4 flex flex-wrap gap-2">
    <a
      href="/"
      class="inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-sm font-medium shadow-sm
             border-slate-200 bg-white/80 text-slate-900 hover:bg-white focus:outline-none
             focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 focus:ring-offset-white
             dark:border-slate-700 dark:bg-[#121418] dark:text-slate-100 dark:hover:bg-[#15181e]
             dark:focus:ring-blue-400 dark:focus:ring-offset-[#0b0b0f] transition-colors"
    >
      <span aria-hidden="true">←</span> Home
    </a>

    <a
      href="/az/"
      class="inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-sm font-medium shadow-sm
             border-slate-200 bg-white/80 text-slate-900 hover:bg-white focus:outline-none
             focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 focus:ring-offset-white
             dark:border-slate-700 dark:bg-[#121418] dark:text-slate-100 dark:hover:bg-[#15181e]
             dark:focus:ring-blue-400 dark:focus:ring-offset-[#0b0b0f] transition-colors"
    >A–Z</a>

    <a
      href="/decade/"
      class="inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-sm font-medium shadow-sm
             border-slate-200 bg-white/80 text-slate-900 hover:bg-white focus:outline-none
             focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 focus:ring-offset-white
             dark:border-slate-700 dark:bg-[#121418] dark:text-slate-100 dark:hover:bg-[#15181e]
             dark:focus:ring-blue-400 dark:focus:ring-offset-[#0b0b0f] transition-colors"
    >Decades</a>
  </nav>

  <h1 class="text-2xl md:text-3xl font-bold mb-2">{title}</h1>
  <p class="text-slate-700 dark:text-slate-300 mb-4">
    Get instant access to the full dataset (CSV). Price:
    <strong class="font-semibold text-slate-900 dark:text-slate-100">${price} USD</strong>.
  </p>

  {!CLIENT_ID ? (
    <p class="text-red-600 dark:text-red-400">
      Missing PayPal client ID.
      Set <code>PUBLIC_PAYPAL_CLIENT_ID</code> (and <code>PUBLIC_PAYPAL_ENV</code>) in your env and redeploy.
    </p>
  ) : (
    <>
      <!-- Always-white checkout card -->
      <section class="rounded-xl border p-4 bg-white shadow-sm text-slate-900 border-slate-200 dark:border-slate-700">
        <h2 class="sr-only">Payment</h2>

        <div id="paypal-loading" role="status" aria-live="polite"
             class="text-sm text-slate-600 text-center">Loading…</div>

        <!-- Center the PayPal buttons -->
        <div class="mt-3 flex justify-center">
          <div id="paypal-btns" class="w-full max-w-[480px]"></div>
        </div>
      </section>

      <!-- Result / notes -->
      <div id="result" class="mt-4 text-sm text-slate-700 dark:text-slate-300"></div>
      <p class="mt-2 text-sm text-slate-700 dark:text-slate-300">
        Payments are processed securely by PayPal. You’ll receive a one-time download link immediately after purchase.
      </p>
      <p class="mt-1 text-center text-xs text-slate-500 dark:text-slate-400">
        Powered by <span class="font-semibold">PayPal</span>
      </p>
    </>
  )}

  {CLIENT_ID && (
    <script is:inline>
      {`
      // Helpers
      function $(id){ return document.getElementById(id); }
      function hideLoading(msg){
        const el = $('paypal-loading');
        if (!el) return;
        if (msg !== undefined) el.textContent = msg;
        el.style.display = 'none';
      }
      function setResult(text){
        const el = $('result');
        if (!el) return;
        el.textContent = text || '';
      }
      async function httpJSON(url, opts){
        const r = await fetch(url, opts);
        let data = null;
        try { data = await r.json(); } catch {}
        return { ok: r.ok, status: r.status, data };
      }

      window.addEventListener('load', () => {
        const fallbackTimer = setTimeout(() => hideLoading(), 8000);
        if (!window.paypal || !window.paypal.Buttons) return;

        paypal.Buttons({
          style: { layout: 'vertical', shape: 'rect', color: 'gold', label: 'paypal', tagline: false },

          onInit() { hideLoading(); setResult(''); },

          async createOrder() {
            const { ok, data } = await httpJSON('/.netlify/functions/paypal-create-order');
            if (!ok || !data?.id) { setResult('Could not create order. Please refresh and try again.'); throw new Error('createOrder failed'); }
            return data.id;
          },

          async onApprove(data) {
            setResult('Finalizing payment…');

            const cap = await httpJSON('/.netlify/functions/paypal-capture-order', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderID: data.orderID })
            });

            if (!cap.ok || !cap.data?.ok || !cap.data?.token) {
              hideLoading(); setResult(cap.data?.error || \`Capture failed (HTTP \${cap.status}).\`); return;
            }

            const dl = await httpJSON('/.netlify/functions/download-link', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token: cap.data.token })
            });

            hideLoading();

            if (!dl.ok || !dl.data?.url) { setResult(dl.data?.error || \`Download link error (HTTP \${dl.status}).\`); return; }

            const a = document.createElement('a');
            a.href = dl.data.url;
            a.textContent = 'Click to download your CSV';
            a.className = 'underline text-blue-600 dark:text-blue-300 hover:no-underline focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-blue-600 dark:focus:ring-blue-400 focus:ring-offset-white dark:focus:ring-offset-[#0b0b0f] rounded';
            a.rel = 'noopener';

            const result = $('result');
            if (result) { result.innerHTML = ''; result.appendChild(a); }
          },

          onError(err) { hideLoading(); setResult('PayPal error: ' + (err?.message || String(err))); }
        })
        .render('#paypal-btns')
        .then(() => { clearTimeout(fallbackTimer); hideLoading(); })
        .catch(() => { clearTimeout(fallbackTimer); hideLoading(); });
      });
      `}
    </script>
  )}
</Base>
