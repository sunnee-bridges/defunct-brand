---
// /src/pages/buy.astro
import Base from "../layouts/Base.astro";

const CLIENT_ID =
  import.meta.env.PUBLIC_PAYPAL_CLIENT_ID || import.meta.env.PAYPAL_CLIENT_ID || "";
const ENV = (import.meta.env.PUBLIC_PAYPAL_ENV || "sandbox").toLowerCase();

// Display-only; real price comes from server PRICE_USD
const PRICE_LABEL = import.meta.env.PUBLIC_PRICE_LABEL || "$9";

const title = "Buy the Full CSV";
const description = "Secure checkout via PayPal. Receive a one-time download link immediately after purchase.";
---
<Base title={title} description={description}>
  <Fragment slot="head">
    {CLIENT_ID && (
      <script
        src={`https://www.paypal.com/sdk/js?client-id=${CLIENT_ID}&currency=USD&intent=capture&components=buttons&disable-funding=paylater,card,credit`}
        defer
      />
    )}
    <style>
      #paypal-btns > div,
      #paypal-btns .paypal-buttons,
      #paypal-btns .paypal-button-row,
      #paypal-btns .paypal-button-container,
      #paypal-btns iframe { background: transparent !important; }
      .link { color:#2563eb; text-decoration:underline; }
    </style>
  </Fragment>

  <nav class="mb-4 flex flex-wrap gap-2">
    <a href="/" class="chip focus-ring">← Home</a>
    <a href="/az/" class="chip focus-ring">A–Z</a>
    <a href="/decade/" class="chip focus-ring">Decades</a>
  </nav>

  <h1 class="text-2xl md:text-3xl font-bold mb-2">{title}</h1>
  <p class="text-slate-700 dark:text-slate-300 mb-4">
    Get instant access to the full dataset (CSV). Price:
    <strong class="font-semibold text-slate-900 dark:text-slate-100">{PRICE_LABEL} USD</strong>.
  </p>

  {!CLIENT_ID ? (
    <p class="text-red-600 dark:text-red-400">
      Missing PayPal client ID. Set <code>PUBLIC_PAYPAL_CLIENT_ID</code> (and <code>PUBLIC_PAYPAL_ENV</code>) and redeploy.
    </p>
  ) : (
    <>
      <section class="rounded-xl border p-4 bg-white shadow-sm text-slate-900 border-slate-200 dark:border-slate-700">
        <h2 class="sr-only">Payment</h2>
        <div id="paypal-loading" role="status" aria-live="polite" class="text-sm text-slate-600 text-center">
          Loading…
        </div>
        <div class="mt-3 flex justify-center">
          <div id="paypal-btns" class="w-full max-w-[480px]"></div>
        </div>
      </section>

      <p class="mt-3 text-sm text-slate-700 dark:text-slate-300">
        Payments are processed securely by PayPal. You’ll receive a one-time download link immediately after purchase.
      </p>

      <div id="result" class="mt-3" aria-live="polite"></div>

      <p class="mt-1 text-center text-xs text-slate-500 dark:text-slate-400">
        ENV: {ENV} • Powered by <span class="font-semibold">PayPal</span>
      </p>
    </>
  )}

  {CLIENT_ID && (
    <script is:inline>
      console.log("[BUY] script inline loaded");

      function $(id){ return document.getElementById(id); }
      function hideLoading(msg){
        const el = $('paypal-loading');
        if (!el) return;
        if (msg !== undefined) el.textContent = msg;
        el.style.display = 'none';
      }
      function setResultHTML(html){
        const el = $('result');
        if (!el) return;
        el.innerHTML = html || '';
      }

     function renderButton(token, extraHTML){
      const dlPath = '/download/' + token;
      const html = `
        <a
          id="fallback-download"
          href="${dlPath}"
          target="_blank" rel="noopener"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800 text-white text-sm sm:text-base font-medium no-underline focus-ring transition-colors"
          role="button"
        >
          <svg viewBox="0 0 20 20" aria-hidden="true" class="h-5 w-5" focusable="false">
            <path fill="currentColor" fill-rule="evenodd"
              d="M3 14.25A1.75 1.75 0 0 1 4.75 12.5h10.5A1.75 1.75 0 0 1 17 14.25v.5A1.75 1.75 0 0 1 15.25 16.5H4.75A1.75 1.75 0 0 1 3 14.75v-.5zm6.22-9.97a.75.75 0 0 1 1.06 0l.01.01c.14.14.22.33.22.53v6.19l2.22-2.22a.75.75 0 1 1 1.06 1.06l-3.5 3.5a.75.75 0 0 1-1.06 0l-3.5-3.5a.75.75 0 1 1 1.06-1.06L9.5 10.01V4.82c0-.2.08-.39.22-.53z"
              clip-rule="evenodd" />
          </svg>
          Download CSV
        </a>
        ${extraHTML || ""}
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">
          Tip: If the download didn’t start, click the button above.
        </p>
      `;
      setResultHTML(html);
      const resEl = document.getElementById('result');
      if (resEl) resEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }


      async function httpJSON(url, opts){
        const r = await fetch(url, opts);
        let data = null;
        try { data = await r.json(); } catch {}
        return { ok: r.ok, status: r.status, data };
      }

      window.addEventListener('load', () => {
        console.log("[BUY] window load");
        const fallbackTimer = setTimeout(() => hideLoading(), 8000);

        if (!window.paypal || !window.paypal.Buttons) {
          console.error("[BUY] PayPal SDK not ready");
          return;
        }

        paypal.Buttons({
          style: { layout: 'vertical', shape: 'rect', color: 'gold', label: 'paypal', tagline: false },

          onInit() {
            console.log("[BUY] onInit");
            hideLoading(); setResultHTML('');
          },

          async createOrder() {
            console.log("[BUY] createOrder → calling function");
            const res = await httpJSON('/.netlify/functions/paypal-create-order');
            console.log("[BUY] createOrder response", res.status, res.data);
            if (!res.ok || !res.data?.id) {
              setResultHTML('<p class="text-red-600 dark:text-red-400">Could not create order. Please refresh and try again.</p>');
              throw new Error('createOrder failed');
            }
            return res.data.id;
          },

          async onApprove(data) {
            console.log("[BUY] onApprove", data);
            setResultHTML('<p class="text-slate-600 dark:text-slate-300">Finalizing payment…</p>');

            const cap = await httpJSON('/.netlify/functions/paypal-capture-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderID: data.orderID })
            });
            console.log("[BUY] capture response", cap.status, cap.data);

            if (!cap.ok || !cap.data?.ok || !cap.data?.token) {
              hideLoading();
              const msg = (cap && cap.data && cap.data.error)
                ? cap.data.error
                : ('Capture failed (HTTP ' + (cap ? cap.status : '?') + ').');
              setResultHTML('<p class="text-red-600 dark:text-red-400">Something went wrong (capture). ' + msg + '</p>');
              return;
            }

            const token = cap.data.token;
            console.log("[BUY] got token", token);

            // 1) Render green fallback button immediately
            renderButton(token, '<div class="text-sm text-slate-600 dark:text-slate-400 mt-1">Download will open in a new tab…</div>');

            // 2) Try to auto-open in new tab (pop-up friendly: runs in onApprove handler)
            const dlPath = '/download/' + token;
            try {
              window.open(dlPath, '_blank', 'noopener'); 
              console.log("[BUY] opened new tab", dlPath);
            } catch (e) {
              console.warn("[BUY] window.open blocked", e);
            }

            hideLoading();
          },

          onError(err) {
            console.error("[BUY] PayPal error", err);
            hideLoading();
            setResultHTML('<p class="text-red-600 dark:text-red-400">PayPal error: ' + (err?.message || String(err)) + '</p>');
          }
        })
        .render('#paypal-btns')
        .then(() => { console.log("[BUY] buttons rendered"); clearTimeout(fallbackTimer); hideLoading(); })
        .catch((e) => { console.error("[BUY] render error", e); clearTimeout(fallbackTimer); hideLoading(); });
      });
    </script>
  )}
</Base>
