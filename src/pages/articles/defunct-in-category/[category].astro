---
// /src/pages/articles/defunct-in-category/[category].astro
import Base from "../../../layouts/Base.astro";
import { slugify } from "../../../lib/slug.js";

/** Eagerly load all brand JSON for static generation */
const brandModules = import.meta.glob("/src/content/brands/*.json", {
  eager: true,
  import: "default",
}) as Record<string, any>;

/** Build static paths from discovered categories */
export function getStaticPaths() {
  const cats = new Set<string>();
  for (const raw of Object.values(brandModules)) {
    const b = raw as any;
    if (!b?.category) continue;
    cats.add(slugify(String(b.category)));
  }
  return [...cats].map((c) => ({ params: { category: c } }));
}

/** Utilities */
const toYear = (v: unknown): number | undefined => {
  const m = String(v ?? "").match(/\d{3,4}/);
  if (!m) return undefined;
  const n = parseInt(m[0], 10);
  return Number.isFinite(n) ? n : undefined;
};

/** Page input */
const { category } = Astro.params;
const catSlug = String(category);

/** Gather items for this category */
const items = Object.values(brandModules)
  .map((raw: any) => raw)
  .filter((b: any) => !!b?.category && slugify(b.category) === catSlug)
  // defensive de-dupe by canonical slug
  .reduce((acc: any[], b: any) => {
    const key = String(b?.slug || "").trim().toLowerCase();
    if (!key || acc.find((x) => (x.slug || "").toLowerCase() === key)) return acc;
    acc.push(b);
    return acc;
  }, [])
  // sort: most recent end first → then alpha
  .sort((a: any, b: any) => {
    const ae = toYear(a?.active?.end) ?? toYear(a?.active?.start) ?? 0;
    const be = toYear(b?.active?.end) ?? toYear(b?.active?.start) ?? 0;
    return be - ae || a.brand.localeCompare(b.brand);
  });

/** Recover the human label from any item (fallback to slug) */
const label =
  items.find(Boolean)?.category ??
  catSlug.replace(/-/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());

/** SEO */
const title = `Defunct Brands in ${label} — Data-Driven List`;
const desc =
  items.length > 0
    ? `Explore ${items.length} discontinued or defunct brands in ${label}. Quick timelines, fate, and links to each profile.`
    : `Explore discontinued or defunct brands in ${label}.`;
const hubPath = `/articles/defunct-in-category/${encodeURIComponent(catSlug)}/`;
const canonical = Astro.site ? new URL(hubPath, Astro.site).href : hubPath;

/** JSON-LD */
const itemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: title,
  itemListOrder: "http://schema.org/ItemListOrderDescending",
  numberOfItems: items.length,
  itemListElement: items.map((b: any, i: number) => ({
    "@type": "ListItem",
    position: i + 1,
    name: b.brand,
    url: Astro.site
      ? new URL(`/brand/${encodeURIComponent(b.slug)}/`, Astro.site).href
      : `/brand/${encodeURIComponent(b.slug)}/`,
  })),
};

const collectionPageLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  url: canonical,
  name: title,
  description: desc,
  mainEntity: itemListLd,
};
---

<Base title={title} description={desc} canonical={canonical} jsonLd={[collectionPageLd]}>
  <nav class="mb-4">
    <a href="/" class="chip focus-ring">← Home</a>
    <a href="/category/" class="chip focus-ring">Categories</a>
    <a href="/blog/" class="chip focus-ring">Blog</a>
  </nav>

  <h1 class="text-2xl md:text-3xl font-bold mb-2">{title}</h1>
  <p class="text-slate-600 dark:text-slate-300 mb-4">{desc}</p>

  {/* Optional short explainer */}
  <div class="prose dark:prose-invert max-w-none mb-6">
    <p>
      This page is generated automatically from our brand dataset. Entries are sorted by the
      most recent closure (or earliest known activity when end year is unknown).
    </p>
  </div>

  {/* Results */}
  {items.length ? (
    <ul class="grid gap-2 sm:grid-cols-2 md:grid-cols-3">
      {items.map((b: any) => {
        const start = b?.active?.start ?? "";
        const end = b?.active?.end ?? "";
        const fate = b?.fate ?? "";
        return (
          <li class="rounded-xl border border-slate-200 dark:border-slate-800 p-3">
            <a class="focus-ring hover:underline font-medium" href={`/brand/${encodeURIComponent(b.slug)}/`}>
              {b.brand}
            </a>
            <div class="text-xs text-slate-500 mt-1">
              {start ? `${start}\u2013${end || "?"}` : ""}{fate ? ` • ${fate}` : ""}
            </div>
            {b.category && (
              <div class="text-xs text-slate-500">{b.category}</div>
            )}
          </li>
        );
      })}
    </ul>
  ) : (
    <p class="text-slate-600 dark:text-slate-300">
      No brands were found for this category yet.
    </p>
  )}

  <div class="mt-6 flex flex-wrap gap-2">
    <a href={`/category/${encodeURIComponent(catSlug)}/`} class="chip focus-ring">
      View the {label} category hub
    </a>
    <a href="/topics/" class="chip focus-ring">Topics</a>
    <a href="/az/" class="chip focus-ring">Browse A–Z</a>
  </div>
</Base>
