---
import Base from "../layouts/Base.astro";
import { slugify } from "../lib/slug.js";

/* Load curated data and de-dupe by slug */
const modules = import.meta.glob("/src/content/brands/*.json", {
  eager: true,
  import: "default",
}) as Record<string, any>;

const bySlug = new Map<string, any>();
for (const raw of Object.values(modules)) {
  const b = raw as any;
  if (!b) continue;
  const key = (String(b.slug || "").trim().toLowerCase()) || slugify(String(b.brand || ""));
  if (!key) continue;
  if (!bySlug.has(key)) bySlug.set(key, b); // first-wins
}
const brands: any[] = Array.from(bySlug.values());

/* Helpers */
const firstLetter = (s: string = "") => {
  const ch = (s[0] || "").toUpperCase();
  return /[A-Z]/.test(ch) ? ch : "#";
};
const anchorIdFor = (L: string) => (L === "#" ? "0-9" : L).replace(/[^A-Za-z0-9_-]/g, "-");

/* Sort/group */
const sorted = brands.slice().sort((a, b) => (a.brand || "").localeCompare(b.brand || ""));
const groups: Record<string, any[]> = {};
for (const b of sorted) {
  const key = firstLetter(b.brand);
  (groups[key] ||= []).push(b);
}
const letters = Object.keys(groups)
  .filter((k) => groups[k]?.length)
  .sort((a, b) => (a === "#" ? 1 : b === "#" ? -1 : a.localeCompare(b)));
const total = sorted.length;

/* SEO */
const PAGE_TITLE = "Browse A–Z • Defunct Brands";
const PAGE_DESC = "Browse all discontinued and defunct brands alphabetically. Clean, structured entries with timelines and outcomes.";
const CANONICAL = Astro.site ? new URL("/az/", Astro.site).href : "/az/";

/** JSON-LD: Breadcrumb + ItemList (cap to avoid huge scripts) */
const LD_MAX = 100;
const ldItems = sorted.slice(0, LD_MAX).map((b: any, i: number) => ({
  "@type": "ListItem",
  position: i + 1,
  name: b.brand,
  url: Astro.site
    ? new URL(`/brand/${encodeURIComponent(b.slug)}/`, Astro.site).href
    : `/brand/${encodeURIComponent(b.slug)}/`,
}));

const breadcrumbLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: Astro.site ? new URL("/", Astro.site).href : "/" },
    { "@type": "ListItem", position: 2, name: "A–Z", item: CANONICAL },
  ],
};

const itemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: "Defunct Brands A–Z",
  itemListOrder: "http://schema.org/ItemListOrderAscending",
  numberOfItems: Math.min(total, LD_MAX), // keep consistent with ldItems length
  itemListElement: ldItems,
};
---

<Base
  title={PAGE_TITLE}
  description={PAGE_DESC}
  canonical={CANONICAL}
  jsonLd={[breadcrumbLd, itemListLd]}
>
  <!-- Accessible, indexable intro (hidden visually; no UI change) -->
  <p class="sr-only">
    Defunct Brands A–Z index. Explore discontinued brands alphabetically with quick links to
    brand timelines, categories, and outcomes.
  </p>

   <nav class="mb-4 flex flex-wrap gap-2">
    <a href="/" class="chip focus-ring">← Home</a>
    <a href="/az/" class="chip focus-ring">A–Z</a>
  </nav>

  <h1 class="text-2xl md:text-3xl font-bold mb-2">Defunct Brands Dataset</h1>
  <p class="text-slate-700 dark:text-slate-300 mb-4">
    A cleaned CSV of brands, categories, active years, and fate.
  </p>

  <!-- Main container with max-width -->
  <div class="grid gap-4 md:grid-cols-2 md:gap-4 lg:gap-6">
    <nav class="mb-3 flex flex-wrap gap-2" aria-label="Breadcrumb">
      <a href="/" class="chip focus-ring">← Home</a>
      <span class="chip opacity-70 cursor-default" aria-current="page">A–Z</span>
    </nav>

    <h1 id="top" class="text-2xl md:text-3xl font-bold mb-1">Browse A–Z</h1>
    <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">Total brands: {total}</p>

    <!-- Jump bar with better spacing -->
    <div class="flex flex-wrap gap-2 mb-6" role="navigation" aria-label="Jump to letter">
      {letters.map((L) => {
        const anchor = anchorIdFor(L);
        return <a href={`#${anchor}`} class="chip focus-ring">{L}</a>;
      })}
    </div>

    <!-- Letter groups -->
    <div class="space-y-8">
      {letters.map((L) => {
        const anchor = anchorIdFor(L);
        return (
          <div id={anchor} role="region" aria-labelledby={`h-${anchor}`}>
            <div class="flex items-baseline gap-2 mb-3">
              <h2 id={`h-${anchor}`} class="text-xl font-semibold">{L}</h2>
              <span class="text-sm text-slate-500 dark:text-slate-400">({groups[L].length})</span>
            </div>

            <ul class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {groups[L].map((b: any) => (
                <li>
                  <article
                    class="relative group rounded-xl p-4 border bg-white border-gray-200
                           hover:bg-slate-50 transition-all duration-200
                           dark:bg-slate-900 dark:border-slate-700 dark:hover:bg-slate-800
                           focus-within:ring-2 focus-within:ring-indigo-500
                           focus-within:ring-offset-2 focus-within:ring-offset-white
                           dark:focus-within:ring-offset-slate-900
                           hover:shadow-md h-full"
                  >
                    <a
                      href={`/brand/${encodeURIComponent(b.slug)}/`}
                      class="stretched-link focus-ring rounded"
                      aria-label={`${b.brand}${b.active?.start ? ` (${b.active.start}–${b.active?.end ?? "?"})` : ""}${b.fate ? ` — ${b.fate}` : ""}`}
                    ></a>

                    <h3 class="text-base font-semibold leading-snug line-clamp-2 mb-2 text-slate-900 dark:text-slate-100 group-hover:underline underline-offset-2">
                      {b.brand}
                    </h3>

                    <div class="text-sm text-gray-600 dark:text-slate-300 mb-1">
                      {b.active?.start ?? ""}{b.active?.start ? '\u2013' : ''}{b.active?.start ? (b.active?.end ?? '?') : ''}{b.fate ? ` \u2014 ${b.fate}` : ""}
                    </div>

                    <div class="text-xs text-gray-500 dark:text-slate-400">
                      {b.category}
                    </div>
                  </article>
                </li>
              ))}
            </ul>
          </div>
        );
      })}
    </div>

    <div class="mt-8">
      <a href="#top" class="chip focus-ring">↑ Back to top</a>
    </div>
  </div>
</Base>