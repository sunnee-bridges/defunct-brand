---
// src/pages/blog/[...slug].astro
import Base from "../../layouts/Base.astro";
import { getCollection, getEntryBySlug } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("post", (p) => !p.data.draft);
  return posts.map((p) => ({ params: { slug: p.slug }, props: { entry: p } }));
}

const { entry } = Astro.props;
// If props weren't passed (edge case), resolve by slug:
const _entry = entry ?? await getEntryBySlug("post", String(Astro.params.slug));
if (!_entry) {
  throw new Error(`Post not found: ${Astro.params.slug}`);
}
const { Content } = await _entry.render();

const canonical = Astro.site
  ? new URL(`/blog/${_entry.slug}/`, Astro.site).href
  : `/blog/${_entry.slug}/`;

// Optional: allow route-level hero only if frontmatter says so
const routeHero = Boolean(_entry.data.routeHero);

// JSON-LD Article
const articleLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: _entry.data.title,
  description: _entry.data.description,
  author: { "@type": "Organization", name: _entry.data.author || "Vanished Brands" },
  datePublished: _entry.data.date ?? _entry.data.publishDate,
  dateModified: _entry.data.updated ?? _entry.data.date ?? _entry.data.publishDate,
  mainEntityOfPage: canonical,
};
---
<Base title={_entry.data.title} description={_entry.data.description} canonical={canonical} jsonLd={[articleLd]}>
  <nav class="mb-4">
    <a href="/" class="chip focus-ring">← Home</a>
    <a href="/blog/" class="chip focus-ring">Blog</a>
  </nav>

  {routeHero && (
    <>
      <h1 class="text-2xl md:text-3xl font-bold mb-2">{_entry.data.title}</h1>
      {_entry.data.description && (
        <p class="text-slate-600 dark:text-slate-300 mb-6">{_entry.data.description}</p>
      )}
    </>
  )}

  <article class="prose dark:prose-invert max-w-none">
    <Content />
  </article>

  <div class="mt-6 flex flex-wrap gap-2">
    <a href="/az/" class="chip focus-ring">Browse A–Z</a>
    <a href="/topics/" class="chip focus-ring">All Topics</a>
    <a href="/category/" class="chip focus-ring">Categories</a>
  </div>
</Base>
