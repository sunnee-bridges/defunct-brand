---
// src/pages/blog/[...slug].astro
import Base from "../../layouts/Base.astro";
import TableOfContents from "@components/TableOfContents.astro";
import ArticleHero from "@components/ArticleHero.astro";
import { getCollection, getEntryBySlug } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("post", (p) => !p.data.draft);
  return posts.map((p) => ({ params: { slug: p.slug }, props: { entry: p } }));
}

// Resolve entry from props or URL
const passed = Astro.props.entry;
const resolved = passed ?? (await getEntryBySlug("post", String(Astro.params.slug)));
if (!resolved) throw new Error(`Post not found: ${Astro.params.slug}`);

const entry = resolved;

// Access unrendered source to detect <ArticleHero .../>
const rawBody: string = (entry as any).body ?? "";

// Render MDX to component
const { Content } = await entry.render();

// Canonical
const canonical = Astro.site
  ? new URL(`/blog/${entry.slug}/`, Astro.site).href
  : `/blog/${entry.slug}/`;

/** ---------- Hero detection ---------- */
const componentHero = /<\s*ArticleHero\b/i.test(rawBody);

// Normalize frontmatter image (object or string)
function fmImage(e: any) {
  const img = e?.data?.image ?? null;
  if (!img) return null;
  if (typeof img === "string") {
    return { src: img, alt: "", credit: "", source: "", license: "" };
  }
  // object form
  return {
    src: img.src,
    alt: img.alt ?? "",
    credit: img.credit ?? "",
    source: img.source ?? "",
    license: img.license ?? "",
  };
}
const imageFromFm = fmImage(entry);
const shouldRenderFallbackHero = !componentHero && !!imageFromFm;

/** ---------- JSON-LD Article ---------- */
const articleLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: entry.data.title,
  description: entry.data.description,
  author: { "@type": "Organization", name: entry.data.author || "Vanished Brands" },
  datePublished: entry.data.date ?? entry.data.publishDate,
  dateModified: entry.data.updated ?? entry.data.date ?? entry.data.publishDate,
  mainEntityOfPage: canonical,
};
---
<Base title={entry.data.title} description={entry.data.description} canonical={canonical} jsonLd={[articleLd]}>
  <nav class="mb-4">
    <a href="/" class="chip focus-ring">← Home</a>
    <a href="/blog/" class="chip focus-ring">Blog</a>
  </nav>

  {/* If the MDX didn't render its own <ArticleHero />, auto-render from frontmatter */}
  {shouldRenderFallbackHero && (
    <ArticleHero
      title={entry.data.title}
      description={entry.data.description}
      date={entry.data.updated ?? entry.data.date ?? entry.data.publishDate}
      image={{
        src: imageFromFm!.src,
        alt: imageFromFm!.alt,
        credit: imageFromFm!.credit,
        source: imageFromFm!.source,
        license: imageFromFm!.license,
      }}
    />
  )}

  {/* If MDX did include <ArticleHero/>, don't duplicate a header */}
  {!shouldRenderFallbackHero && (
    <>
      {/* Some posts put their own hero; if they didn't, at least show the title/desc */}
      {!componentHero && (
        <>
          <h1 class="text-2xl md:text-3xl font-bold mb-2">{entry.data.title}</h1>
          {entry.data.description && (
            <p class="text-slate-600 dark:text-slate-300 mb-6">{entry.data.description}</p>
          )}
        </>
      )}
    </>
  )}

  {/* Layout: content + TOC */}
  <section class="grid grid-cols-1 lg:grid-cols-[minmax(0,1fr)_300px] gap-8 items-start">
    <article class="prose dark:prose-invert max-w-none relative z-0">
      <Content />
    </article>

    <aside class="relative z-10 hidden lg:block">
      <TableOfContents />
    </aside>
  </section>

  <div class="mt-6 flex flex-wrap gap-2">
    <a href="/az/" class="chip focus-ring">Browse A–Z</a>
    <a href="/topics/" class="chip focus-ring">All Topics</a>
    <a href="/category/" class="chip focus-ring">Categories</a>
  </div>
</Base>
