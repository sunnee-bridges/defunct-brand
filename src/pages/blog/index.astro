---
// src/pages/blog/index.astro
import Base from "../../layouts/Base.astro";
import { getCollection } from "astro:content";

/* ---------- Safe date helpers ---------- */
function parseDate(v: unknown): Date | undefined {
  if (!v) return undefined;
  const d = new Date(v as any);
  return Number.isFinite(+d) ? d : undefined;
}
function fmtDateSafe(v: unknown) {
  const d = parseDate(v);
  if (!d) return { iso: "", text: "Undated" };
  return {
    iso: d.toISOString(),
    text: d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" }),
  };
}

/* ---------- Load posts (exclude drafts) ---------- */
const posts = (await getCollection("post", p => !p.data.draft))
  .sort((a, b) => {
    const bd = parseDate(b.data.updated ?? b.data.date);
    const ad = parseDate(a.data.updated ?? a.data.date);
    return (+bd! || 0) - (+ad! || 0);
  });

const title = "Vanished Brands Blog";
const desc  = "Plain-language explainers, timelines, and data stories.";
const canonical = Astro.site ? new URL("/blog/", Astro.site).href : "/blog/";

/* ---------- Read-time estimate (best effort) ---------- */
function estReadMins(entry: any) {
  const src = (entry?.body ?? entry?.data?.description ?? "").toString();
  const words = src.trim().split(/\s+/).filter(Boolean).length;
  return Math.max(1, Math.round(words / 225));
}

/* ---------- Image helpers (frontmatter first; no fabricated fallbacks) ---------- */
function cardImageForPost(p: any) {
  // Accept: image { src, alt?, credit?, source?, license?, fit? } OR string
  const fm = p.data?.image ?? p.data?.hero ?? p.data?.cover ?? null;
  const fmObj = typeof fm === "string" ? { src: fm, alt: "" } : fm;

  const src     = fmObj?.src || "";
  const alt     = fmObj?.alt || p.data?.title || "Article image";
  const credit  = fmObj?.credit  || "";
  const source  = fmObj?.source  || "";
  const license = fmObj?.license || "";
  const fit     = (fmObj?.fit === "contain") ? "contain" : "cover";

  return { src, alt, credit, source, license, fit };
}

/* ---------- JSON-LD ---------- */
const itemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: title,
  numberOfItems: posts.length,
  itemListOrder: "http://schema.org/ItemListOrderDescending",
  itemListElement: posts.map((p, i) => {
    const dp = parseDate(p.data.date);
    const dm = parseDate(p.data.updated);
    return {
      "@type": "ListItem",
      position: i + 1,
      name: p.data.title,
      url: Astro.site ? new URL(`/blog/${p.slug}/`, Astro.site).href : `/blog/${p.slug}/`,
      ...(dp ? { datePublished: dp.toISOString() } : {}),
      ...(dm ? { dateModified: dm.toISOString() } : {}),
    };
  }),
};
---
<Base title={title} description={desc} canonical={canonical} jsonLd={itemListLd}>
  <style is:inline>
    .blog-grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
    .card {
      position: relative;
      border-radius: 16px;
      border: 1px solid rgb(226 232 240);
      background: #fff;
      overflow: hidden;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .dark .card { border-color: rgb(51 65 85); background: rgb(2 6 23); }
    .card:hover { transform: translateY(-2px); box-shadow: 0 14px 28px -18px rgba(0,0,0,.45); }

    /* Media box */
    .thumb {
      position: relative;
      aspect-ratio: 16/9;
      display: grid; place-items: center;
      color: white; overflow: hidden;
      background: linear-gradient(135deg, #6366f1 0%, #7c3aed 100%); /* only for no-image fallback */
    }
    .thumb.has-img { background: #000; } /* Avoid gradient band when an image exists */

    .thumb picture, .thumb img { width: 100%; height: 100%; display: block; }
    .thumb img.fit-cover   { object-fit: cover;   object-position: center top; }
    .thumb img.fit-contain { object-fit: contain; object-position: center center; background: #000; }

    .thumb .fallback { font-size: 40px; opacity: .9; }

    .credit {
      position: absolute; right: 8px; bottom: 8px;
      font-size: 11px; line-height: 1;
      background: rgba(0,0,0,.55); color: #fff;
      padding: .25rem .4rem; border-radius: 6px; border: 1px solid rgba(255,255,255,.15);
      max-width: 70%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .dark .credit { background: rgba(0,0,0,.6); }
    .credit a { color: #fff; text-decoration: underline; }

    .content { padding: 14px 14px 12px; }
    .title { font-weight: 700; line-height: 1.25; font-size: 1.05rem; color: rgb(15 23 42); }
    .dark .title { color: white; }
    .title a:hover { text-decoration: underline; text-underline-offset: 3px; }

    .desc {
      margin-top: 6px; color: rgb(71 85 105);
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; min-height: 2.4em;
    }
    .dark .desc { color: rgb(203 213 225); }

    .meta { margin-top: 10px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; font-size: 12px; color: rgb(100 116 139); }
    .dark .meta { color: rgb(148 163 184); }

    .chip {
      display:inline-flex; align-items:center; gap:.35rem; padding:.3rem .52rem; border-radius:9999px; font-weight:600;
      background: color-mix(in oklab, rgb(99 102 241) 12%, white);
      border: 1px solid color-mix(in oklab, rgb(99 102 241) 24%, white); color: rgb(30 41 59);
    }
    .dark .chip {
      background: color-mix(in oklab, rgb(99 102 241) 26%, rgb(2 6 23));
      border-color: color-mix(in oklab, rgb(99 102 241) 42%, rgb(2 6 23));
      color: white;
    }

    .badge { position: absolute; top: 10px; left: 10px; font-size: 11px; font-weight: 700; padding: .28rem .5rem; border-radius: 9999px;
      background: rgba(255,255,255,.92); color: #111827; border: 1px solid rgba(0,0,0,.06); }
    .dark .badge { background: rgba(2,6,23,.7); color: white; border-color: rgba(255,255,255,.16); }
  </style>

  <nav class="mb-4"><a href="/" class="chip focus-ring">‚Üê Home</a></nav>

  <h1 class="text-2xl md:text-3xl font-bold mb-2">{title}</h1>
  <p class="text-slate-600 dark:text-slate-300 mb-5">{desc}</p>

  {posts.length === 0 ? (
    <p class="text-slate-600 dark:text-slate-400">No posts yet.</p>
  ) : (
    <ul class="blog-grid">
      {posts.map((p) => {
        const d = fmtDateSafe(p.data.updated ?? p.data.date);
        const mins = estReadMins(p);
        const tags: string[] = Array.isArray(p.data.tags) ? p.data.tags.slice(0, 2) : [];
        const isUpdated = Boolean(parseDate(p.data.updated) && parseDate(p.data.date) && (p.data.updated !== p.data.date));

        const img = cardImageForPost(p);
        const hasCredit = Boolean(img.credit || img.source || img.license);

        return (
          <li class="card">
            <a href={`/blog/${p.slug}/`} class="stretched-link" aria-label={p.data.title}></a>

            <div class={`thumb ${img.src ? "has-img" : ""}`}>
              {img.src ? (
                <picture>
                  {/* Keep WebP if provided; no fake JPG fallback */}
                  {/\.webp($|\?)/i.test(img.src) && <source type="image/webp" srcset={img.src} />}
                  <img
                    src={img.src}
                    alt={img.alt}
                    loading="lazy"
                    decoding="async"
                    class={img.fit === "contain" ? "fit-contain" : "fit-cover"}
                  />
                </picture>
              ) : (
                <div class="fallback" aria-hidden="true">üì∞</div>
              )}
              {isUpdated && <span class="badge">Updated</span>}

              {hasCredit && (
                <small class="credit">
                  {img.source ? (
                    <a href={img.source} target="_blank" rel="noopener noreferrer">
                      {img.credit || "Image"}{img.license ? ` ‚Äî ${img.license}` : ""}
                    </a>
                  ) : (
                    <>
                      {img.credit || "Image"}{img.license ? ` ‚Äî {img.license}` : ""}
                    </>
                  )}
                </small>
              )}
            </div>

            <div class="content">
              <h2 class="title">
                <a class="focus-ring rounded-sm" href={`/blog/${p.slug}/`}>{p.data.title}</a>
              </h2>

              {p.data.description && <p class="desc">{p.data.description}</p>}

              <div class="meta">
                <time {...(d.iso ? { datetime: d.iso } : {})}>{d.text}</time>
                <span aria-hidden="true">‚Ä¢</span>
                <span>{mins} min read</span>
                {tags.length > 0 && (
                  <>
                    <span aria-hidden="true">‚Ä¢</span>
                    {tags.map(t => (
                      <span class="chip" title={`Tag: ${t}`}>#{t}</span>
                    ))}
                  </>
                )}
              </div>
            </div>
          </li>
        );
      })}
    </ul>
  )}

  <script is:inline>
    (function () {
      try {
        const fmt = Intl && Intl.DateTimeFormat
          ? new Intl.DateTimeFormat(undefined, { dateStyle: 'medium' })
          : null;
        if (!fmt) return;
        document.querySelectorAll('time[datetime]').forEach(t => {
          const iso = t.getAttribute('datetime');
          if (!iso) return;
          const dt = new Date(iso);
          if (+dt) t.textContent = fmt.format(dt);
        });
      } catch {}
    })();
  </script>
</Base>
