---
// src/pages/category/[category].astro
import Base from "../../layouts/Base.astro";
import { slugify } from "../../lib/slug.js";
import { CATEGORY_META } from "../../lib/categoryMeta.ts";
import {
  yearsOf,
  catHue,
  fateIconOf,
  fateTypeOf,
  primaryTextOf,
  truncateInline,
} from "../../lib/brandUtils";

/** Build-time: enumerate all SEO categories and precompute the items for each */
export async function getStaticPaths() {
  const modules = import.meta.glob("/src/content/brands/*.json", {
    eager: true,
    import: "default",
  }) as Record<string, any>;

  // Normalize & de-dupe by canonical brand slug
  const bySlug = new Map<string, any>();
  for (const raw of Object.values(modules)) {
    const b = raw as any;
    if (!b) continue;

    const brandKey =
      String(b.slug || "").trim().toLowerCase() ||
      slugify(String(b.brand || ""));
    if (!brandKey) continue;

    // Prefer seo_category; fallback to category
    const rawCat = (b.seo_category ?? b.category ?? "").toString().trim();
    if (!rawCat) continue;

    b.__seo_category = slugify(rawCat); // normalized canonical category slug

    if (!bySlug.has(brandKey)) bySlug.set(brandKey, b); // first wins
  }
  const brands = Array.from(bySlug.values());

  // Unique SEO category slugs (sorted)
  const slugs = Array.from(new Set(brands.map((b) => b.__seo_category))).sort();

  // Page props per category
  return slugs.map((catSlug) => {
    const items = brands
      .filter((b) => b.__seo_category === catSlug)
      .sort((a, b) => String(a.brand).localeCompare(String(b.brand)));

    // Derive label from meta (fallback to prettified slug)
    const meta = CATEGORY_META[catSlug] ?? {};
    const label =
      meta.label ||
      catSlug.replace(/-/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());

    return { params: { category: catSlug }, props: { label, catSlug, items, allCats: slugs } };
  });
}

/** Props from getStaticPaths */
const { label, catSlug, items } = Astro.props;

/** Final render-time guard (belt & suspenders) */
const _seen = new Set<string>();
const uniqueItems = items.filter((b: any) => {
  const k =
    String(b.slug || "").trim().toLowerCase() ||
    slugify(String(b.brand || ""));
  if (!k || _seen.has(k)) return false;
  _seen.add(k);
  return true;
});

/* ---------------- SEO / Canonical / JSON-LD ---------------- */
const categoryPath = `/category/${catSlug}/`;
const canonical = Astro.site ? new URL(categoryPath, Astro.site).href : categoryPath;

const title = `Defunct Brands in ${label}`;
const metaDesc =
  CATEGORY_META[catSlug]?.desc ??
  `Explore ${uniqueItems.length} defunct or discontinued brands in ${label}.`;

const itemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  url: canonical,
  name: title,
  itemListOrder: "http://schema.org/ItemListOrderAscending",
  numberOfItems: uniqueItems.length,
  itemListElement: uniqueItems.map((b: any, i: number) => ({
    "@type": "ListItem",
    position: i + 1,
    name: b.brand,
    url: Astro.site
      ? new URL(`/brand/${encodeURIComponent(b.slug)}/`, Astro.site).href
      : `/brand/${encodeURIComponent(b.slug)}/`,
  })),
};
---

<Base
  title={title}
  description={metaDesc}
  canonical={canonical}
  jsonLd={[itemListLd]}
>
  <style is:inline>
    /* Page controls */
    .toolbar {
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:14px;
    }
    .input, .select {
      border:1px solid rgb(226 232 240); background:#fff; color:#0f172a;
      border-radius:10px; padding:.5rem .7rem; font-size:.95rem;
    }
    .dark .input, .dark .select {
      border-color: rgb(51 65 85); background: rgb(2 6 23); color:white;
    }

    /* Cards ‚Äì aligned with homepage mini cards (fcard-sm) */
    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 14px;
    }
    .card {
      position:relative;
      border-radius:.875rem;
      border:1px solid var(--card-border, rgb(226 232 240));
      background: var(--card-bg, #fff);
      padding:.8rem .9rem;
      overflow:hidden;
      transition: transform .16s ease, box-shadow .16s ease, background .16s ease, border-color .16s ease;
    }
    .card:hover { transform: translateY(-1px); box-shadow: 0 6px 12px -8px rgb(0 0 0 / .18); }
    .dark .card{ --card-bg: rgb(2 6 23); --card-border: rgb(51 65 85); }

    .title { font-weight: 700; line-height:1.2; margin: 0 0 .25rem 0; }
    .title a:hover { text-decoration: underline; text-underline-offset: 3px; }
    .hook {
      margin-top:.25rem; font-size:.9rem; line-height:1.25rem;
      color: rgb(71 85 105);
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    .dark .hook { color: rgb(203 213 225); }
    .meta-row { display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.4rem }
    .chip-lite {
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.25rem .5rem; border-radius:9999px; font-size:.72rem; font-weight:600;
      background: color-mix(in oklab, var(--tint) 14%, white);
      border: 1px solid color-mix(in oklab, var(--tint) 28%, white);
      color: oklch(0.28 0 0);
    }
    .dark .chip-lite {
      background: color-mix(in oklab, var(--tint) 22%, rgb(2 6 23));
      border-color: color-mix(in oklab, var(--tint) 45%, rgb(2 6 23));
      color: white;
    }

    /* Divider + spacing for clarity */
    .section-head { display:flex; align-items:center; gap:.5rem; margin-bottom:.35rem; }
    .badge {
      display:inline-flex; align-items:center; justify-content:center;
      min-width: 1.5rem; height:1.5rem; padding: 0 .4rem;
      border-radius:9999px; font-size:.75rem; font-weight:700;
      border:1px solid rgb(226 232 240); background:white; color:#0f172a;
    }
    .dark .badge { border-color: rgb(51 65 85); background: rgb(2 6 23); color: white; }
  </style>

  <nav class="mb-3">
    <a href="/" class="chip focus-ring">‚Üê Home</a>
    <a href="/category/" class="chip focus-ring">All Categories</a>
  </nav>

  <div class="section-head">
    <h1 class="text-2xl md:text-3xl font-bold">{label} ‚Äî defunct brands</h1>
    <span class="badge" aria-label={`${uniqueItems.length} brands`}>{uniqueItems.length}</span>
  </div>
  <p class="text-slate-700 dark:text-slate-300 mb-3">
    {CATEGORY_META[catSlug]?.desc ?? `Browse brands in ${label}.`}
  </p>

  <!-- Controls -->
  <div class="toolbar">
    <label for="q" class="text-sm text-slate-600 dark:text-slate-300">Search</label>
    <input id="q" class="input" type="search" placeholder={`Search ${label}‚Ä¶`} inputmode="search" />
    <label for="sort" class="text-sm text-slate-600 dark:text-slate-300">Sort</label>
    <select id="sort" class="select">
      <option value="alpha">A ‚Üí Z</option>
      <option value="end-desc">Most recent closure</option>
      <option value="start-asc">Oldest founded</option>
    </select>
  </div>

  <!-- Card grid -->
  <ul id="grid" class="grid" role="list">
    {uniqueItems.map((b: any) => {
      const yrs = yearsOf(b);
      const cat = b.__seo_category_label || b.category || "Brand";
      const tint = `oklch(0.7 0.12 ${catHue(cat)})`;
      const icon = fateIconOf(b);
      const fateType = fateTypeOf(b) || "other";
      const text = truncateInline(primaryTextOf(b), 140);

      return (
        <li role="listitem">
          <article class="card" style={{ "--tint": tint }}>
            <a
              href={`/brand/${encodeURIComponent(b.slug)}/`}
              class="stretched-link focus-ring rounded"
              aria-label={`${b.brand}${yrs ? ` (${yrs})` : ""}${b.fate ? ` ‚Ä¢ ${b.fate}` : ""}`}
            ></a>

            <h2 class="title text-slate-900 dark:text-slate-100">
              <a href={`/brand/${encodeURIComponent(b.slug)}/`}>{b.brand}</a>
            </h2>

            {text && (
              <p class="hook">
                <span aria-hidden="true">{icon}</span>
                <span class="sr-only">Fate: {fateType}</span>
                {" "}{text}
              </p>
            )}

            <div class="meta-row">
              {yrs && <span class="chip-lite" aria-label={`Years active ${yrs}`}>{yrs}</span>}
              {cat && <span class="chip-lite" title={`Category: ${cat}`}>üè∑Ô∏è {cat}</span>}
            </div>
          </article>
        </li>
      );
    })}
  </ul>

  <!-- Client-side search + sort (cards) -->
  <script>
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));

    const grid = $("#grid");
    const q = $("#q");
    const sortSel = $("#sort");

    function normalize(s){ return (s || "").toLowerCase().trim(); }

    function applyFilters() {
      const term = normalize(q.value);
      $$("#grid > li").forEach(li => {
        const txt = (li.textContent || "").toLowerCase();
        li.style.display = !term || txt.includes(term) ? "" : "none";
      });
    }

    function parseYears(text) {
      // Looks for "(1990‚Äì2001)" patterns; returns {start,end}
      const m = text.match(/\((\d{3,4})\u2013(\?|\d{3,4})\)/);
      if (!m) return {start:0, end:0};
      return { start: parseInt(m[1],10), end: (m[2] === "?" ? 0 : parseInt(m[2],10)) };
    }

    function applySort() {
      const mode = sortSel.value;
      const rows = $$("#grid > li").filter(li => li.style.display !== "none");
      const nameOf = (li)=> (li.querySelector("h2")?.textContent || "").toLowerCase();
      const yearsOfText = (li)=> parseYears(li.textContent || "");

      rows.sort((a,b)=>{
        if (mode === "alpha") return nameOf(a).localeCompare(nameOf(b));
        if (mode === "end-desc") {
          const A = yearsOfText(a).end, B = yearsOfText(b).end;
          return (B - A) || nameOf(a).localeCompare(nameOf(b));
        }
        if (mode === "start-asc") {
          const A = yearsOfText(a).start, B = yearsOfText(b).start;
          return (A - B) || nameOf(a).localeCompare(nameOf(b));
        }
        return 0;
      });
      rows.forEach(r => grid.appendChild(r));
    }

    function onChange(){ applyFilters(); applySort(); }
    q.addEventListener("input", onChange);
    sortSel.addEventListener("change", onChange);
    onChange();
  </script>
</Base>
