---
// src/pages/category/index.astro
import Base from "../../layouts/Base.astro";
import { slugify } from "../../lib/slug.js";

/**
 * Canonical SEO categories + display labels/descriptions.
 * Keys MUST be slugified (kebab-case) and match the normalized category slugs.
 */
const CATEGORY_META: Record<string, { label?: string; desc?: string }> = {
  "retail": {
    label: "Retail",
    desc:
      "Department stores, specialty shops, and mall icons that shuttered‚Äîtimelines, fates, and what led to the downfall.",
  },
  "retail-entertainment": {
    label: "Retail & Entertainment",
    desc:
      "Video rental, arcades, and music/movie retailers that couldn‚Äôt survive the digital turn.",
  },
  "food-beverage": {
    label: "Food & Beverage",
    desc:
      "Cereal, snacks, and soft drinks‚Äîlimited runs, cult favorites, and why they vanished.",
  },
  "alcoholic-beverages": {
    label: "Alcoholic Beverages",
    desc:
      "Beers, malts, and RTDs that defined eras, then disappeared (and sometimes came back).",
  },
  "consumer-electronics": {
    label: "Consumer Electronics",
    desc:
      "Gadgets we loved‚Äîfrom music players to cameras‚Äîretired by smartphones or shifting tastes.",
  },
  "computers-hardware": {
    label: "Computers & Hardware",
    desc:
      "PC makers and components that shaped personal computing before being outpaced by new ecosystems.",
  },
  "mobile-wearables": {
    label: "Mobile & Wearables",
    desc:
      "Phones, PDAs, and smartwatches that set the pace for mobility‚Äîthen ceded it.",
  },
  "software-internet": {
    label: "Software & Internet",
    desc:
      "Browsers, IM clients, P2P, and e-commerce pioneers‚Äîwhat they built, and why they ended.",
  },
  "video-games-consoles": {
    label: "Video games & consoles",
    desc:
      "Hardware and online worlds that battled for the living room‚Äîlaunches, closures, and legacy.",
  },
  "airlines-aviation": {
    label: "Airlines & Aviation",
    desc:
      "Carriers that merged, rebranded, or ceased operations‚Äîroutes, fleets, and consolidation timelines.",
  },
  "automotive": {
    label: "Automotive",
    desc:
      "Marques and halo models that defined eras, from mid-century giants to single-year cult icons.",
  },
  "finance-payments": {
    label: "Finance & Payments",
    desc:
      "Banks, crypto exchanges, and processors‚Äîrise, risk, regulation, and collapse.",
  },
  "healthcare-diagnostics": {
    label: "Healthcare & Diagnostics",
    desc:
      "Ambitious med-tech and diagnostics brands‚Äîpromises, pivots, and regulatory reality.",
  },
};

/**
 * Normalize raw category/seo_category strings ‚Üí canonical slugs.
 * Add/adjust mappings here if you see new variants in your data.
 */
function normalizeCategory(raw: string): string {
  const s = String(raw || "").trim();
  if (!s) return "";

  // Common typos & punctuation variants ‚Üí canonical slug
  const lower = s.toLowerCase();

  // Direct quick fixes
  if (lower === "retaiil") return "retail";
  if (lower === "retail/entertainment" || lower === "retail-entertainment") return "retail-entertainment";
  if (lower === "consumer electronics" || lower === "consumer-electronics") return "consumer-electronics";
  if (lower === "software/internet" || lower === "software - internet") return "software-internet";
  if (lower === "video games & consoles" || lower === "video games and consoles" || lower === "video-games" || lower === "video-game-consoles")
    return "video-games-consoles";
  if (lower === "airline" || lower === "airlines" || lower === "aviation" || lower === "airline/aviation" || lower === "airlines-aviation")
    return "airlines-aviation";
  if (lower === "computers" || lower === "computers & hardware" || lower === "computers-hardware")
    return "computers-hardware";
  if (lower === "mobile devices" || lower === "mobile" || lower === "wearables" || lower === "mobile & wearables" || lower === "mobile-wearables")
    return "mobile-wearables";
  if (lower === "food & beverage" || lower === "food/beverage" || lower === "food-beverage")
    return "food-beverage";
  if (lower === "beverages/alcohol" || lower === "beverages (alcohol)" || lower === "alcoholic beverages")
    return "alcoholic-beverages";
  if (lower === "finance" || lower === "finance & payments" || lower === "finance/payments")
    return "finance-payments";
  if (lower === "healthcare" || lower === "healthcare & diagnostics" || lower === "healthcare/diagnostics")
    return "healthcare-diagnostics";

  // Fallback: slugify whatever came in
  return slugify(s);
}

/** Load curated brand JSON at build time */
const modules = import.meta.glob("/src/content/brands/*.json", {
  eager: true,
  import: "default",
}) as Record<string, any>;

/** Normalize + de-dupe by canonical brand slug */
const bySlug = new Map<string, any>();
for (const raw of Object.values(modules)) {
  const b = raw as any;
  if (!b) continue;

  const key =
    String(b.slug || "").trim().toLowerCase() ||
    slugify(String(b.brand || ""));
  if (!key) continue;

  // Prefer seo_category, fallback to category
  const rawCat = (b.seo_category ?? b.category ?? "").toString().trim();
  if (!rawCat) continue;

  // Store normalized canonical category slug on the object for later use
  b.__seo_category = normalizeCategory(rawCat);

  if (!bySlug.has(key)) bySlug.set(key, b); // first-wins
}
const brands = Array.from(bySlug.values());

/** Build category counts using the canonical normalized slug */
const counts = new Map<string, number>();
for (const b of brands) {
  const slug = b.__seo_category;
  if (!slug) continue;
  counts.set(slug, (counts.get(slug) || 0) + 1);
}

/** Helper: pretty label from meta, else title-cased slug */
function labelFor(slug: string, fallbackRaw?: string): string {
  const meta = CATEGORY_META[slug];
  if (meta?.label) return meta.label;
  const base = fallbackRaw || slug.replace(/-/g, " ");
  return base.replace(/\b\w/g, (c) => c.toUpperCase());
}

/**
 * Sorted categories with meta applied.
 * No duplicates; labels/descriptions come from CATEGORY_META when available.
 */
const categories = Array.from(counts.entries())
  .map(([slug, n]) => {
    const displayLabel = labelFor(slug);
    const desc =
      CATEGORY_META[slug]?.desc ||
      `Explore ${n} brand${n === 1 ? "" : "s"} in ${displayLabel}.`;
    return { slug, displayLabel, desc, n };
  })
  .sort((a, b) => a.displayLabel.localeCompare(b.displayLabel));

/** SEO bits */
const PAGE_TITLE = "Browse by Category ‚Ä¢ Defunct Brands";
const PAGE_DESC =
  "Browse discontinued and defunct brands by category. Clean, structured entries with timelines and outcomes.";
const CANONICAL = Astro.site
  ? new URL("/category/", Astro.site).href
  : "/category/";

/** Feature first 8 (for JSON-LD only) */
const FEATURED = categories.slice(0, 8);
---

<Base title={PAGE_TITLE} description={PAGE_DESC}>
  <!-- üîé SEO head -->
  <Fragment slot="head">
    <link rel="canonical" href={CANONICAL} />
    <meta name="description" content={PAGE_DESC} />

    <meta property="og:type" content="website" />
    <meta property="og:url" content={CANONICAL} />
    <meta property="og:title" content={PAGE_TITLE} />
    <meta property="og:description" content={PAGE_DESC} />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={PAGE_TITLE} />
    <meta name="twitter:description" content={PAGE_DESC} />

    {/* JSON-LD: ItemList of featured categories (optional) */}
    {FEATURED.length > 0 && (
      <script type="application/ld+json">
        {JSON.stringify({
          "@context": "https://schema.org",
          "@type": "ItemList",
          name: "Categories",
          itemListElement: FEATURED.map((c, i) => ({
            "@type": "ListItem",
            position: i + 1,
            name: c.displayLabel,
            url: Astro.site
              ? new URL(`/category/${c.slug}/`, Astro.site).href
              : `/category/${c.slug}/`,
          })),
        })}
      </script>
    )}
  </Fragment>

  <!-- üì¶ Page container -->
  <nav class="mb-4 flex flex-wrap gap-2">
    <a href="/" class="chip focus-ring">‚Üê Home</a>
    <span class="chip opacity-70 cursor-default" aria-current="page">Categories</span>
  </nav>

  <!-- Header -->
  <h1 id="top" class="text-2xl md:text-3xl font-bold mb-1">Browse by Category</h1>
  <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">
    Total categories: {categories.length}
  </p>

  <!-- Chip grid -->
  <ul class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
    {categories.map((c) => (
      <li>
        <a
          href={`/category/${c.slug}/`}
          class="chip focus-ring block"
          title={c.desc}
          aria-label={`${c.displayLabel} (${c.n}). ${c.desc}`}
        >
          {c.displayLabel} <span class="text-gray-500">({c.n})</span>
        </a>
      </li>
    ))}
  </ul>

  <!-- Back to top -->
  <div class="mt-8">
    <a href="#top" class="chip focus-ring">‚Üë Back to top</a>
  </div>
</Base>
