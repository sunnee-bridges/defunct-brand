---
// src/pages/category/index.astro
import Base from "../../layouts/Base.astro";
import { slugify } from "../../lib/slug.js";

/**
 * Curated copy for category hubs (used for nicer labels & hover descriptions).
 * Keys MUST be slugified (same algo as `slugify()`).
 */
const CATEGORY_META: Record<string, { label?: string; desc?: string }> = {
  "retail": {
    desc:
      "Department stores, specialty shops, and mall icons that shuttered—timelines, fates, and what led to the downfall.",
  },
  "software-internet": {
    label: "Software / Internet",
    desc:
      "Once-dominant apps and online services—what they did, when they peaked, and why they disappeared.",
  },
  "mobile-devices": {
    desc:
      "Phones, PDAs, and handhelds that defined eras of mobility—and the shifts that ended them.",
  },
  "retail-entertainment": {
    desc:
      "Movie, game, and media storefronts that couldn't survive the digital turn.",
  },
  "computers": {
    desc:
      "PC makers and platforms that shaped personal computing before being outpaced by new ecosystems.",
  },
  "e-commerce": {
    desc:
      "Dot-com darlings and online storefronts—early strategies vs. today's e-commerce giants.",
  },
  "consumer-electronics": {
    label: "Consumer electronics",
    desc:
      "Gadgets we loved—from music players to cameras—retired by smartphones or shifting tastes.",
  },
  "video-games": {
    label: "Video games",
    desc:
      "Studios, services, and titles that disappeared—launches, closures, and influence.",
  },
  "video-game-consoles": {
    label: "Video game consoles",
    desc:
      "Hardware that battled for the living room—specs, release windows, and market forces.",
  },
  "airline": {
    label: "Airlines",
    desc:
      "Carriers that merged, rebranded, or ceased operations—routes, fleets, consolidation timelines.",
  },
  "wearables": {
    desc:
      "Watches, bands, and quantified-self experiments—what launched, what stuck, what faded.",
  },
  "finance-cryptocurrency": {
    label: "Finance/Cryptocurrency",
    desc:
      "Crypto exchanges, fintech startups, and financial services that collapsed—valuations, timelines, and what went wrong.",
  },
};

/** Load curated brand JSON at build time */
const modules = import.meta.glob("/src/content/brands/*.json", {
  eager: true,
  import: "default",
}) as Record<string, any>;

/** Normalize + de-dupe by canonical slug (fallback to slugify(brand)) */
const bySlug = new Map<string, any>();
for (const raw of Object.values(modules)) {
  const b = raw as any;
  if (!b) continue;
  const key =
    String(b.slug || "").trim().toLowerCase() ||
    slugify(String(b.brand || ""));
  if (!key) continue;
  if (typeof b.category === "string") b.category = b.category.trim();
  if (!b.category) continue;
  if (!bySlug.has(key)) bySlug.set(key, b); // first-wins
}
const brands = Array.from(bySlug.values());

/** Build category counts (based on deduped curated set) */
const counts = new Map<string, number>();
for (const b of brands) {
  counts.set(b.category, (counts.get(b.category) || 0) + 1);
}

/**
 * Sorted categories with meta applied.
 * We keep the canonical slug for URLs, and use CATEGORY_META to override label/desc.
 */
const categories = Array.from(counts.entries())
  .map(([rawLabel, n]) => {
    const slug = slugify(rawLabel);
    const meta = CATEGORY_META[slug] ?? {};
    const displayLabel = meta.label || rawLabel;
    const desc =
      meta.desc || `Explore ${n} brand${n === 1 ? "" : "s"} in ${displayLabel}.`;
    return { slug, displayLabel, desc, n };
  })
  .sort((a, b) => a.displayLabel.localeCompare(b.displayLabel));

/** SEO bits */
const PAGE_TITLE = "Browse by Category • Defunct Brands";
const PAGE_DESC =
  "Browse discontinued and defunct brands by category. Clean, structured entries with timelines and outcomes.";
const CANONICAL = Astro.site
  ? new URL("/category/", Astro.site).href
  : "/category/";

/** Feature first 8 (for JSON-LD only) */
const FEATURED = categories.slice(0, 8);
---

<Base title={PAGE_TITLE} description={PAGE_DESC}>
  <Fragment slot="head">
    <link rel="canonical" href={CANONICAL} />
    <meta name="description" content={PAGE_DESC} />

    <meta property="og:type" content="website" />
    <meta property="og:url" content={CANONICAL} />
    <meta property="og:title" content={PAGE_TITLE} />
    <meta property="og:description" content={PAGE_DESC} />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={PAGE_TITLE} />
    <meta name="twitter:description" content={PAGE_DESC} />

    {FEATURED.length > 0 && (
      <script type="application/ld+json">
        {JSON.stringify({
          "@context": "https://schema.org",
          "@type": "ItemList",
          name: "Categories",
          itemListElement: FEATURED.map((c, i) => ({
            "@type": "ListItem",
            position: i + 1,
            name: c.displayLabel,
            url: Astro.site
              ? new URL(`/category/${c.slug}/`, Astro.site).href
              : `/category/${c.slug}/`,
          })),
        })}
      </script>
    )}

    <style>
      .category-card {
        position: relative;
        transition: all 0.2s ease;
      }
      
      .category-card:hover {
        transform: scale(1.02);
        filter: brightness(1.15);
      }

      .category-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(-8px);
        background: var(--tooltip-bg, rgba(17, 24, 39, 0.95));
        color: var(--tooltip-text, white);
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        line-height: 1.4;
        white-space: normal;
        max-width: 280px;
        z-index: 50;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s ease;
        border: 1px solid var(--tooltip-border, rgba(75, 85, 99, 0.5));
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      }

      :global(html:not(.dark)) .category-tooltip {
        --tooltip-bg: rgba(255, 255, 255, 0.98);
        --tooltip-text: rgba(17, 24, 39, 0.95);
        --tooltip-border: rgba(209, 213, 219, 0.8);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      :global(html.dark) .category-tooltip {
        --tooltip-bg: rgba(17, 24, 39, 0.95);
        --tooltip-text: white;
        --tooltip-border: rgba(75, 85, 99, 0.5);
      }

      .category-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: var(--tooltip-bg, rgba(17, 24, 39, 0.95));
      }

      .category-card:hover .category-tooltip {
        opacity: 1;
      }

      @media (max-width: 640px) {
        .category-tooltip {
          left: 10%;
          right: 10%;
          max-width: none;
          transform: translateX(0) translateY(-8px);
        }
        .category-tooltip::after {
          left: 20%;
        }
      }

      .count-badge {
        display: inline-block;
        background: rgba(75, 85, 99, 0.3);
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        margin-left: 0.5rem;
      }
    </style>
  </Fragment>

  <nav class="mb-4 flex flex-wrap gap-2"><a href="/" class="chip focus-ring">← Home</a><a href="/az/" class="chip focus-ring">A–Z</a><a href="/decade/" class="chip focus-ring">Decades</a><a href="/data/" class="chip focus-ring">Data</a><span class="chip opacity-70 cursor-default" aria-current="page">Categories</span></nav>
  <h1 id="top" class="text-2xl md:text-3xl font-bold mb-2">Browse by Category</h1>
  <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">Total categories: {categories.length}</p>
  <ul class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
    {categories.map((c) => (
      <li>
        <a
          href={`/category/${c.slug}/`}
          class="chip focus-ring block category-card"
          aria-label={`${c.displayLabel} (${c.n}). ${c.desc}`}
        >
          <span class="font-medium">{c.displayLabel}</span>
          <span class="count-badge text-gray-400">({c.n})</span>
          <span class="category-tooltip" role="tooltip">
            {c.desc}
          </span>
        </a>
      </li>
    ))}
  </ul>
  <div class="mt-8">
    <a href="#top" class="chip focus-ring">↑ Back to top</a>
  </div>
</Base>