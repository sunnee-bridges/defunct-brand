---
// src/pages/category/index.astro
import Base from "../../layouts/Base.astro";
import { slugify } from "../../lib/slug.js";

const CATEGORY_META: Record<string, { label?: string; desc?: string }> = {
  "retail": {
    desc: "Department stores, specialty shops, and mall icons that shuttered—timelines, fates, and what led to the downfall.",
  },
  "software-internet": {
    label: "Software / Internet",
    desc: "Once-dominant apps and online services—what they did, when they peaked, and why they disappeared.",
  },
  "mobile-devices": {
    desc: "Phones, PDAs, and handhelds that defined eras of mobility—and the shifts that ended them.",
  },
  "retail-entertainment": {
    desc: "Movie, game, and media storefronts that couldn't survive the digital turn.",
  },
  "computers": {
    desc: "PC makers and platforms that shaped personal computing before being outpaced by new ecosystems.",
  },
  "e-commerce": {
    desc: "Dot-com darlings and online storefronts—early strategies vs. today's e-commerce giants.",
  },
  "consumer-electronics": {
    label: "Consumer electronics",
    desc: "Gadgets we loved—from music players to cameras—retired by smartphones or shifting tastes.",
  },
  "video-games": {
    label: "Video games",
    desc: "Studios, services, and titles that disappeared—launches, closures, and influence.",
  },
  "video-game-consoles": {
    label: "Video game consoles",
    desc: "Hardware that battled for the living room—specs, release windows, and market forces.",
  },
  "airline": {
    label: "Airlines",
    desc: "Carriers that merged, rebranded, or ceased operations—routes, fleets, consolidation timelines.",
  },
  "wearables": {
    desc: "Watches, bands, and quantified-self experiments—what launched, what stuck, what faded.",
  },
  "finance-cryptocurrency": {
    label: "Finance/Cryptocurrency",
    desc: "Crypto exchanges, fintech startups, and financial services that collapsed—valuations, timelines, and what went wrong.",
  },
};

const modules = import.meta.glob("/src/content/brands/*.json", {
  eager: true,
  import: "default",
}) as Record<string, any>;

const bySlug = new Map<string, any>();
for (const raw of Object.values(modules)) {
  const b = raw as any;
  if (!b) continue;
  const key = String(b.slug || "").trim().toLowerCase() || slugify(String(b.brand || ""));
  if (!key) continue;
  if (typeof b.category === "string") b.category = b.category.trim();
  if (!b.category) continue;
  if (!bySlug.has(key)) bySlug.set(key, b);
}
const brands = Array.from(bySlug.values());

const counts = new Map<string, number>();
for (const b of brands) {
  counts.set(b.category, (counts.get(b.category) || 0) + 1);
}

const categories = Array.from(counts.entries())
  .map(([rawLabel, n]) => {
    const slug = slugify(rawLabel);
    const meta = CATEGORY_META[slug] ?? {};
    const displayLabel = meta.label || rawLabel;
    const desc = meta.desc || `Explore ${n} brand${n === 1 ? "" : "s"} in ${displayLabel}.`;
    return { slug, displayLabel, desc, n };
  })
  .sort((a, b) => a.displayLabel.localeCompare(b.displayLabel));

const title = "Browse by Category • Defunct Brands";
const desc = "Browse discontinued and defunct brands by category. Clean, structured entries with timelines and outcomes.";
const canonical = Astro.site ? new URL("/category/", Astro.site).href : "/category/";
---
<Base title={title} description={desc} canonical={canonical}>
  <nav class="mb-4 flex flex-wrap gap-2">
    <a href="/" class="chip focus-ring">← Home</a>
    <a href="/az/" class="chip focus-ring">A–Z</a>
    <a href="/decade/" class="chip focus-ring">Decades</a>
    <a href="/data/" class="chip focus-ring">Data</a>
    <span class="chip opacity-70 cursor-default" aria-current="page">Categories</span>
  </nav>
  <h1 class="text-2xl md:text-3xl font-bold mb-2">{title}</h1>
  <p class="text-slate-600 dark:text-slate-300 mb-4">Total categories: {categories.length}</p>
  <ul class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
    {categories.map((c) => (
      <li>
        <a href={`/category/${c.slug}/`} class="chip focus-ring block" title={c.desc}>
          {c.displayLabel} <span class="text-gray-500">({c.n})</span>
        </a>
      </li>
    ))}
  </ul>
</Base>