---
const links = [
  { href: "/category/",  label: "Categories (browse)",  match: (p: string) => p.startsWith("/category/") },
  { href: "/az/",        label: "Aâ€“Z (all brands)",     match: (p: string) => p.startsWith("/az/") },
  { href: "/decade/",    label: "Decades (timelines)",  match: (p: string) => p.startsWith("/decade/") },

  // NEW: Products hub (vanished products/cult favorites)
  { href: "/products/",  label: "Products",             match: (p: string) => p.startsWith("/products/") },

  { href: "/blog/",      label: "Blog (articles)",      match: (p: string) => p.startsWith("/blog/") },
  { href: "/data/",      label: "Data (CSV dataset)",   match: (p: string) => p.startsWith("/data/") },
];

const path = Astro.url.pathname;
const isHome = path === "/";
const fallbackSlug = Astro.props.fallbackSlug ?? "blockbuster";

/* ---------- Safe inline JSON-LD for site nav ---------- */
const urlFor = (p: string) => (Astro.site ? new URL(p, Astro.site).href : p);

// Optional: simpler names (without parentheses) for the JSON-LD "name" array
const navNames = links.map(l => l.label.replace(/\s*\([^)]*\)\s*/g, "").trim());
const navUrls  = links.map(l => urlFor(l.href));

const navSchema = {
  "@context": "https://schema.org",
  "@type": "SiteNavigationElement",
  name: navNames,
  url: navUrls
};

// Escape dangerous sequences for inline <script>
const toSafeJson = (obj: any) =>
  JSON.stringify(obj ?? {})
    .replace(/<\/script/gi, '<\\/script')
    .replace(/</g, '\\u003c')
    .replace(/\u2028|\u2029/g, '');
---

<header class="max-w-[1040px] mx-auto px-4">
  <!-- Top row: title + theme toggle -->
  <div class="mt-8 flex items-center justify-between gap-4">
    <div>
      {isHome ? (
        <h1 class="text-2xl md:text-3xl font-bold">
          ğŸ•°ï¸ Vanished Brands Archive
        </h1>
      ) : (
        <p class="text-2xl md:text-3xl font-bold" role="heading" aria-level="2">
          ğŸ•°ï¸ Vanished Brands Archive
        </p>
      )}
      <p class="text-gray-600 dark:text-slate-300 mt-1">
        Explore by category, A&ndash;Z, decade, or fate.
      </p>
    </div>

    <!-- Theme toggle -->
    <button
      id="themeToggleBtn"
      type="button"
      class="shrink-0 px-3 py-1 rounded border border-slate-300 dark:border-slate-600
             text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-800
             hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus-visible:ring-2
             focus-visible:ring-indigo-500"
      aria-label="Toggle color theme"
      aria-pressed="false"
      data-icon="ğŸŒ“"
    >
      ğŸŒ“ <span class="ml-1 hidden sm:inline">Theme</span>
    </button>
  </div>

  <!-- Primary nav -->
  <nav role="navigation" aria-label="Primary" class="flex flex-wrap items-center gap-3 mt-5 mb-6">
    {links.map((l) => {
      const isCurrent = l.match(path);
      return (
        <a
          href={l.href}
          class={`chip focus-ring ${isCurrent ? "ring-2 ring-indigo-500" : ""}`}
          aria-current={isCurrent ? "page" : undefined}
        >
          {l.label}
        </a>
      );
    })}

    <!-- Real href as no-JS fallback; delegated JS will hijack -->
    <a
      href={`/brand/${fallbackSlug}/`}
      class="btn-primary focus-ring"
      data-random
      onclick="return window.__goRandomBrand ? window.__goRandomBrand(event) : true"
    >
      Random
    </a>
  </nav>
</header>

<!-- Inline SiteNavigationElement JSON-LD (safely escaped) -->
<script type="application/ld+json" is:inline set:html={toSafeJson(navSchema)} />

<!-- Small inline script to sync the toggle label/state and call the global setter -->
<script is:inline>
  (function () {
    const KEY = 'theme';
    const btn = document.getElementById('themeToggleBtn');
    if (!btn) return;

    function currentTheme() {
      return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    }

    function setStateFromTheme(theme) {
      btn.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
    }

    function setTheme(next) {
      if (window.toggleTheme) {
        const cur = currentTheme();
        if (cur !== next) window.toggleTheme();
      } else {
        document.documentElement.classList.toggle('dark', next === 'dark');
        document.documentElement.dataset.theme = next;
        try { localStorage.setItem(KEY, next); } catch (_) {}
        const meta = document.querySelector('meta[name="theme-color"]');
        if (meta) meta.setAttribute('content', next === 'dark' ? '#0b0b0f' : '#ffffff');
      }
      setStateFromTheme(next);
    }

    setStateFromTheme(currentTheme());

    btn.addEventListener('click', function () {
      const next = currentTheme() === 'dark' ? 'light' : 'dark';
      setTheme(next);
    });

    const mo = new MutationObserver(() => setStateFromTheme(currentTheme()));
    mo.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
  })();
</script>
