---
// src/components/BrandCard.astro
export interface Props {
  slug: string;       // brand slug (e.g., "toys-r-us")
  compact?: boolean;  // tighter layout
}

const { slug, compact = false } = Astro.props;

/** Load curated brand JSON at build time */
const modules = import.meta.glob("/src/content/brands/*.json", {
  eager: true,
  import: "default",
}) as Record<string, any>;

/** Find the brand by slug (filename slug OR b.slug) */
let brand: any = null;
for (const [p, mod] of Object.entries(modules)) {
  const data = (mod as any) ?? {};
  const fileSlug = (p.split("/").pop() || "")
    .replace(/\.public\.json$/i, "")
    .replace(/\.json$/i, "");
  if ((data.slug || fileSlug) === slug) {
    brand = { ...data, slug: data.slug || fileSlug };
    break;
  }
}

/* ---------- Local helpers ---------- */
const toYear = (v: unknown): number | undefined => {
  if (v == null) return undefined;
  const m = String(v).match(/\d{3,4}/);
  if (!m) return undefined;
  const n = parseInt(m[0], 10);
  return Number.isFinite(n) ? n : undefined;
};

const yearsOf = (b: any): string => {
  const s = b?.active?.start;
  const e = b?.active?.end;
  if (s && e) return `${s}\u2013${e}`;
  if (s && !e) return `${s}\u2013?`;
  if (!s && e) return `\u2013${e}`;
  return "";
};

function primaryTextOf(b: any): string {
  const hook = (b?.hook ?? "").toString().trim();
  if (hook) return hook;
  const fate = (b?.fate ?? "").toString().trim();
  if (fate) return fate;
  const summary = (b?.summary ?? "").toString().trim();
  return summary;
}
function truncateInline(text: string, max = 140) {
  const plain = String(text).replace(/<[^>]*>/g, "").replace(/\s+/g, " ").trim();
  if (plain.length <= max) return plain;
  return plain.slice(0, max - 1).replace(/\W?$/, "") + "‚Ä¶";
}

/* ---------- Derived ---------- */
const years = yearsOf(brand || {});
const oneLiner = truncateInline(primaryTextOf(brand || {}), compact ? 110 : 140);
const catLabel = (brand?.__seo_category_label || brand?.category || "").toString().trim();

/* ---------- Topic chips (1-line, no wrap) ---------- */
const topicBadges: Record<string, { label: string; icon: string; title: string; classes: string }> = {
  scandal: {
    label: "Scandal", icon: "‚ö†Ô∏è", title: "Ended due to scandal",
    classes: "inline-flex items-center rounded-full bg-rose-50 px-2 py-0.5 font-medium text-rose-700 dark:bg-rose-900/30 dark:text-rose-300"
  },
  "vanished-product": {
    label: "Product", icon: "üßÉ", title: "Discontinued product",
    classes: "inline-flex items-center rounded-full bg-emerald-50 px-2 py-0.5 font-medium text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300"
  },
  "cult-favorite": {
    label: "Product", icon: "üßÉ", title: "Discontinued product (cult favorite)",
    classes: "inline-flex items-center rounded-full bg-emerald-50 px-2 py-0.5 font-medium text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300"
  },
};
const topicsArr: string[] = Array.isArray(brand?.topics) ? brand.topics : [];
const scandalish = /fraud|scandal|brib|launder|misconduct|embezz|hacking|phone[- ]?hacking|accounting\s+irregular/i;
const hasScandalTag = topicsArr.includes("scandal");
const inferredScandal = !hasScandalTag && scandalish.test(String(brand?.fate || ""));
const topicChips = topicsArr.filter((t) => topicBadges[t]).map((t) => ({ key: t, ...topicBadges[t] }));
if (inferredScandal) topicChips.push({ key: "scandal", ...topicBadges.scandal });

/* ---------- Sizing tokens ---------- */
const linesHook = compact ? 2 : 3;
const titleSize = compact ? "text-base" : "text-lg";
const pad = compact ? "p-3" : "p-4";
---

{brand ? (
  <article
    class={`brand-card rounded-xl border border-slate-200 dark:border-slate-800 ${pad}`}
    data-toc-exclude
    style={{ "--hook-lines": String(linesHook) }}
  >
    <a
      href={`/brand/${encodeURIComponent(brand.slug)}/`}
      class="stretched-link focus-ring rounded-sm"
      aria-label={`${brand.brand}${years ? ` (${years})` : ""}${catLabel ? ` ‚Äî ${catLabel}` : ""}`}
    ></a>

    <!-- 1) Title: fixed 2 lines -->
    <h3 class={`title ${titleSize} font-semibold leading-snug`} data-toc-exclude>
      {brand.brand}
    </h3>

    <!-- 2) Hook: fixed block-size (2‚Äì3 lines) -->
    <p class="hook">{oneLiner || "\u00A0"}</p>

    <!-- 3) Chips: forced 1 line with ellipsis (optional; will not change card height) -->
    {topicChips.length > 0 ? (
      <div class="chips" aria-label="Tags">
        {topicChips.map((c) => (
          <span class={c.classes} title={c.title} aria-label={c.title}>
            <span class="mr-1" aria-hidden="true">{c.icon}</span>{c.label}
          </span>
        ))}
      </div>
    ) : (
      <div class="chips" aria-hidden="true">&nbsp;</div>
    )}

    <!-- 4) Years: always render a line to reserve space -->
    <div class="years">{years || "\u00A0"}</div>

    <!-- 5) Category: always render a line to reserve space -->
    <div class="category">
      <span class="category-chip" title={catLabel}>{catLabel ? `üè∑Ô∏è ${catLabel}` : "\u00A0"}</span>
    </div>
  </article>
) : (
  <article class="rounded-xl border border-slate-200 dark:border-slate-800 p-4" data-toc-exclude>
    <p class="text-sm text-slate-600 dark:text-slate-400">Brand ‚Äú{slug}‚Äù not found.</p>
  </article>
)}

<style is:inline>
  /* Make every card the same total height by fixing each row‚Äôs height */
  .brand-card {
    position: relative;
    display: grid;
    grid-template-rows:
      /* title */ minmax(calc(1.2em * 2), auto)
      /* hook  */ minmax(calc(1.25rem * var(--hook-lines, 3)), auto)
      /* chips */ 1.5rem
      /* years */ 1.1rem
      /* cat   */ 1.4rem;
    gap: .55rem;
    height: 100%;
    background: var(--card-bg, #fff);
  }
  .dark .brand-card { --card-bg: rgb(2 6 23); }

  .title {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .hook {
    --lh: 1.25rem;
    line-height: var(--lh);
    display: -webkit-box;
    -webkit-line-clamp: var(--hook-lines, 3);
    -webkit-box-orient: vertical;
    overflow: hidden;
    /* ensure exact height regardless of content */
    block-size: calc(var(--lh) * var(--hook-lines, 3));
    color: rgb(71 85 105);
    font-size: .95rem;
    margin: 0;
  }
  .dark .hook { color: rgb(203 213 225); }

  /* Force chips to ONE line, ellipsize if long, never wrap to a new row */
  .chips {
    display: flex;
    gap: .375rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    align-items: center;
    min-height: 1.5rem;
  }

  .years, .category {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.1;
    font-size: .9rem;
    color: rgb(71 85 105);
  }
  .dark .years, .dark .category { color: rgb(203 213 225); }

  .category-chip {
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    padding: .25rem .5rem;
    border-radius: 9999px;
    font-size: .72rem;
    font-weight: 600;
    max-width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    background: rgb(241 245 249);
    border: 1px solid rgb(226 232 240);
    color: rgb(30 41 59);
  }
  .dark .category-chip {
    background: rgb(30 41 59 / .45);
    border-color: rgb(51 65 85);
    color: white;
  }

  .stretched-link { position: absolute; inset: 0; }
  .focus-ring:focus-visible { outline: 2px solid rgb(99 102 241); outline-offset: 2px; }
</style>
