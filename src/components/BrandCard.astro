---
/**
 * BrandCard.astro
 *
 * Flexible props:
 *  - item?: {
 *      brand: string; slug: string;
 *      category?: string;
 *      active?: { start?: number | string; end?: number | string };
 *      fate?: string;
 *      summary?: string;
 *      views?: number;
 *    }
 *  - brand?: string
 *  - slug?: string
 *  - category?: string
 *  - active?: { start?: number | string; end?: number | string }
 *  - fate?: string
 *  - summary?: string
 *  - views?: number
 *
 * Optional:
 *  - compact?: boolean   // tighter padding
 */

export interface BrandLike {
  brand: string;
  slug: string;
  category?: string;
  active?: { start?: number | string; end?: number | string };
  fate?: string;
  summary?: string;
  views?: number;
}

export interface Props extends Partial<BrandLike> {
  item?: BrandLike;
  compact?: boolean;
}

const {
  item,
  brand,
  slug,
  category,
  active,
  fate,
  summary,
  views,
  compact = false,
} = Astro.props as Props;

// Normalize into one object
const b: BrandLike = {
  brand: item?.brand ?? brand ?? "Unknown",
  slug: item?.slug ?? slug ?? "",
  category: item?.category ?? category,
  active: item?.active ?? active,
  fate: item?.fate ?? fate,
  summary: item?.summary ?? summary,
  views: item?.views ?? views,
};

function toYear(v: unknown): string {
  if (v == null) return "";
  const m = String(v).match(/\d{3,4}/);
  return m ? m[0] : "";
}
const start = toYear(b?.active?.start);
const end   = toYear(b?.active?.end);
const years = start ? `${start}\u2013${end || "?"}` : "";

function trimOneLine(s?: string, n = 140) {
  if (!s) return "";
  const t = s.replace(/\s+/g, " ").trim();
  return t.length > n ? t.slice(0, n - 1).trimEnd() + "…" : t;
}
const oneLine = trimOneLine(b.summary);

// Safe href
const href = b.slug ? `/brand/${encodeURIComponent(b.slug)}/` : "#";
const aria = `What happened to ${b.brand}?${years ? ` (${years})` : ""}${b.fate ? ` — ${b.fate}` : ""}`;
---

<article class={`group relative border border-slate-200 dark:border-slate-800 rounded-2xl bg-white dark:bg-slate-900 shadow-sm hover:shadow transition-shadow ${compact ? "p-3" : "p-4"}`}>
  <!-- Full-card clickable area -->
  <a href={href} class="stretched-link focus-ring rounded-xl" aria-label={aria}></a>

  <!-- Title -->
  <h3 class="text-lg font-semibold leading-snug text-slate-900 dark:text-slate-100 mb-0.5">
    <a href={href} class="hover:underline">{b.brand}</a>
  </h3>

  <!-- Meta row -->
  <div class="text-sm text-slate-600 dark:text-slate-300 flex flex-wrap items-center gap-x-2 gap-y-1">
    {years && <span>{years}</span>}
    {b.fate && <span>• {b.fate}</span>}
    {b.category && <span class="text-slate-500 dark:text-slate-400">• {b.category}</span>}
    {typeof b.views === "number" && b.views >= 0 && (
      <span class="ml-auto text-xs px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300">
        {b.views.toLocaleString()} views
      </span>
    )}
  </div>

  <!-- One-liner summary -->
  {oneLine && (
    <p class="mt-2 text-sm text-slate-700 dark:text-slate-300">
      {oneLine}
    </p>
  )}
</article>

<style is:inline>
  .stretched-link { position: absolute; inset: 0; }
  .focus-ring { outline: none; }
  .focus-ring:focus-visible {
    box-shadow: 0 0 0 2px rgba(79,70,229,.6);
  }
</style>
